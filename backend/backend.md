# åç«¯|æœåŠ¡å™¨ç«¯

* ä¸‰é«˜ï¼ˆé«˜å¹¶å‘ï¼Œé«˜å¯ç”¨ï¼Œé«˜æ€§èƒ½ï¼‰
* å®‰å…¨
* å­˜å‚¨
* ä¸šåŠ¡

## èŒèƒ½

* webé¡¹ç›®å¼€å‘
* åº•å±‚APIå°è£…ä¸å¼€å‘:ä¸ºå‰ç«¯æ“ä½œæä¾›æœåŠ¡
* çº¿ä¸Šç³»ç»Ÿçš„ä¼˜åŒ–
* çº¿ä¸ŠæœåŠ¡å™¨çš„è¿ç»´ï¼Œå¸¸è§é—®é¢˜çš„è¯Šæ–­ä¸è§£å†³ã€‚
* å­˜å‚¨ï¼šæ–‡ä»¶ ä¿¡æ¯ ä¿¡æ¯ä¹‹é—´çš„å…³ç³»ï¼ˆæ•°æ®åº“ï¼‰

## æŠ€èƒ½

* æŒæ¡å¥½è¯­è¨€åŸºç¡€
* è¯­è¨€ç”Ÿæ€
  - apache+php å¸¸ç”¨çš„PHPå’Œapacheæ¨¡å—
  - æ¡†æ¶ï¼šLN(A)MPæ¶æ„
* ç®—æ³•ä¸æ•°æ®ç»“æ„
* è®¡ç®—æœºç½‘ç»œ
* æ•°æ®åº“
  - Mysql ä¼˜åŒ–ã€èƒ½åˆ›å»ºé«˜æ•ˆçš„ç´¢å¼•
  - nosql
* æ¶ˆæ¯ä¸­é—´ä»¶
* Linuxä¸åº”ç”¨éƒ¨ç½²ï¼ŒShellè„šæœ¬
* ç¼“å­˜
  * Memcache
  * Redis
* æœåŠ¡åŒ–
* é¡¹ç›®æ‰©å±•
  - restful
  - solr
* æ¨¡ç‰ˆå¼•æ“

## ä¸šåŠ¡

* è®¾è®¡ã€å®ç°ç›¸å…³ä¸šåŠ¡æœåŠ¡
* åº•å±‚æ¡†æ¶ä»£ç ä»¥åŠçº¿ä¸Šç³»ç»Ÿä¼˜åŒ–

## è¿›é˜¶

* äº†è§£å¤§å®¹é‡ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å‘åŸç†
* åœ¨å¼€æ”¾å¹³å°ï¼Œåˆ†å¸ƒå¼å­˜å‚¨ï¼Œåˆ†å¸ƒå¼Cache

## è¶‹åŠ¿

* å¼‚æ­¥æ¨¡å¼ï¼šGo Dubbo.å¼‚æ­¥éé˜»å¡çš„ Nginxï¼Œè€Œä¸æ˜¯åŒæ­¥é˜»å¡çš„ Apacheã€‚å°±æ˜¯å› ä¸º Nginx è¿™æ ·çš„å¼‚æ­¥ç¨‹åºï¼Œå®ƒçš„é€‚åº”æ€§æ›´å¥½ã€å¹¶å‘èƒ½åŠ›æ›´å¼ºã€‚ç°åœ¨åœ¨åç«¯ä¸šåŠ¡å¼€å‘ç¼–ç¨‹æ–¹é¢ï¼ŒæŠ€æœ¯åŠ›é‡å¼ºçš„å›¢é˜Ÿå·²ç»å¼€å§‹å°†æŠ€æœ¯æ ˆä»åŒæ­¥æ¨¡å¼åˆ‡æ¢ä¸ºå¼‚æ­¥äº†ã€‚
  - åŒæ­¥é˜»å¡æ¨¡å¼å­˜åœ¨è¾ƒå¤šç¼ºé™·ï¼Œå¹¶å‘èƒ½åŠ›å¼±ã€é€‚åº”æ€§å·®ã€æ…¢é€Ÿè¯·æ±‚å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚å¦‚ï¼šåå°æ¥å£ä¸­è°ƒç”¨ç¬¬ä¸‰æ–¹ API çš„åœºæ™¯ï¼ŒåŒæ­¥æ¨¡å¼æ•ˆæœæå·®ã€‚è¿‡å»é‚£äº›ä½¿ç”¨ Javaã€PHPã€C++ã€Pythonã€Ruby è¯­è¨€å¼€å‘çš„åŒæ­¥é˜»å¡æ¨¡å¼æ¡†æ¶ï¼Œç”¨çš„äººè¶Šæ¥è¶Šå°‘ã€‚
* Node.js:å¾ˆå°‘è§åˆ°ä¼ä¸šå°† Node.js ä½œä¸ºå…¬å¸åç«¯æ–¹é¢çš„ä¸»è¦ç¼–ç¨‹è¯­è¨€.
  - å¼‚æ­¥å›è°ƒçš„æŠ€æœ¯æ–¹æ¡ˆï¼Œä»¥åŠåœ¨å®ƒä¹‹ä¸Šæ‰€åšçš„ä¸€äº›ä¼˜åŒ–æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Promiseã€Futureã€Yield/Generatorã€Async/Await ç­‰ï¼Œæ”¹å˜äº†ç¨‹åºå¼€å‘çš„é£æ ¼å’Œä¹ æƒ¯ã€‚ä½¿ç”¨è¿™äº›æŠ€æœ¯æ–¹æ¡ˆæ˜¯æ— æ³•å…¼å®¹å·²æœ‰ç¨‹åºçš„
* åç¨‹æ¨¡å¼ï¼Œå…¼é¡¾äº†åŒæ­¥é˜»å¡çš„å¯ç»´æŠ¤æ€§å’Œå¼‚æ­¥éé˜»å¡çš„é«˜å¹¶å‘èƒ½åŠ›ã€‚å°†ä¼šæˆä¸ºæœªæ¥åç«¯å¼€å‘é¢†åŸŸçš„ä¸»æµæŠ€æœ¯æ–¹æ¡ˆã€‚
  - åç¨‹æ¨¡å¼åªéœ€è¦å¯¹å·²æœ‰é¡¹ç›®ä»£ç è¿›è¡Œå°‘é‡è°ƒæ•´å°±å¯ä»¥è¿è¡Œèµ·æ¥ï¼Œç”šè‡³å¯ä»¥å®Œå…¨å…¼å®¹è€é¡¹ç›®ã€‚åªéœ€è¦æ¡†æ¶å±‚è¿›è¡Œå…¼å®¹å³å¯ã€‚
  - GO æ˜¯æœ€è€€çœ¼çš„é‚£ä¸€ä¸ªã€‚åç¨‹ã€é€šé“ã€é™æ€è¯­è¨€ã€æ€§èƒ½ã€å¯Œç¼–è¯‘ã€æ ‡å‡†åº“ä¸°å¯Œã€ç”Ÿæ€å®Œæ•´ã€Google ç­‰
  - PHP + Swoole çš„æŠ€æœ¯æ ˆï¼Œæ›´é€‚åˆå¿«é€Ÿå¼€å‘ã€å¿«é€Ÿè¿­ä»£ã€ä¸šåŠ¡é©±åŠ¨çš„åœºæ™¯ã€‚æ¯•ç«ŸåŠ¨æ€è¯­è¨€æ¯”é™æ€è¯­è¨€è¿˜æ˜¯è¦æ›´åŠ çµæ´»ã€å¼€å‘æ•ˆç‡æ›´é«˜ã€‚è€Œ Go æ›´é€‚åˆç¼–å†™ç³»ç»Ÿçº§è½¯ä»¶ã€æ ¸å¿ƒä¸šåŠ¡ã€‚

## ç³»ç»Ÿæ€§èƒ½

* åˆ†ç±»
  - Load Testing - è´Ÿè½½æµ‹è¯•
  - Stress Testing - å‹åŠ›æµ‹è¯•
  - Soak Testing - è€ä¹…æµ‹è¯•
  - Spike Testing - ç¬å‹æµ‹è¯•
* æŒ‡æ ‡
  - æŠ€æœ¯æŒ‡æ ‡
    + OK / KO
    + QPS / RPS / TPS
    + Response Time(min/max/mean/std/90%â€¦)
    + Concurrent Users / Concurrent Requests
  - ä¸šåŠ¡æŒ‡æ ‡
    + å¹³å‡åŒæ—¶åœ¨çº¿ç”¨æˆ·æ•°
    + åŒæ—¶åœ¨çº¿ç”¨æˆ·æ•°
* æ­¥éª¤
  - ç¡®å®šæ€§èƒ½éœ€æ±‚ï¼ˆå¯é€‰ï¼‰
  - å‡†å¤‡æµ‹è¯•ç¯å¢ƒå’Œæµ‹è¯•æ•°æ®
  - é€‰æ‹©æ€§èƒ½æµ‹è¯•å·¥å…·/å¹³å°ï¼Œ
  - åˆ¶å®šæ€§èƒ½æµ‹è¯•æ¨¡å‹ï¼Œç¼–å†™æ€§èƒ½æµ‹è¯•ä»£ç 
  - è¿è¡Œæ€§èƒ½æµ‹è¯•
  - åˆ†ææµ‹è¯•æŠ¥å‘Š
  - æ€§èƒ½è°ƒä¼˜ | ä¿®å¤é—®é¢˜
* æµ‹è¯•æ ¸å¿ƒ
  - ç½‘å…³(é˜²ç«å¢™/VPNç­‰)
  - åº”ç”¨ç³»ç»Ÿ
  - æ•°æ®åº“
* ç›®æ ‡ï¼šæ ¸å¿ƒä¸‰ç‚¹éƒ½åˆ†åˆ«æ€§èƒ½æœ€ä¼˜ï¼Œå¹¶ä¸”å…¨é“¾è·¯é•¿æ—¶è¶…é«˜å‹èƒ½æ­£å¸¸è¿è¡Œ

## ç³»ç»Ÿæ€§èƒ½å·¥ç¨‹

* å†…å®¹
  - æ¶æ„æ˜“æ‰©å±•
  - æµ‹è¯•è¾ƒç®€å•
  - åˆ†æå¾ˆå›°éš¾
    + æ€§èƒ½æµ‹è¯•ç»“æœ ï¼ˆ Throughput vs Latency ç­‰ï¼‰
    + æ“ä½œç³»ç»Ÿç›‘æ§ï¼ˆ CPU, Memory, IO, Network ç­‰ï¼‰
    + åº”ç”¨ç³»ç»Ÿï¼ˆ Profiler, Code Review ç­‰ï¼‰
    + ç½‘å…³å’Œæ•°æ®åº“ ï¼ˆ Logs, CPU, Memory, IO ç­‰ï¼‰
  - ä¼˜åŒ–å¯çµæ´»
    + ç¡¬ä»¶åŸºç¡€è®¾æ–½ä¼˜åŒ–
    + æ“ä½œç³»ç»Ÿä¼˜åŒ–
    + åº”ç”¨ç³»ç»Ÿä¼˜åŒ–
    + æ•°æ®åº“ä¼˜åŒ–
    + ç³»ç»Ÿæ¶æ„ä¼˜åŒ–
  - è§„åˆ’è¦æŒ‰éœ€
    + é€‰å–æµ‹è¯•æŒ‡æ ‡
    + å»ºç«‹æµ‹è¯•æ¨¡å‹
    + å˜åŒ–æµ‹è¯•æŒ‡æ ‡
    + åˆ†ææµ‹è¯•æŠ¥å‘Šã€æ‹Ÿåˆæµ‹è¯•æ•°æ®

## è´Ÿè½½å‡è¡¡ Load Balancer

* ä¸€ç»„è®¡ç®—æœºèŠ‚ç‚¹ï¼ˆæˆ–è€…ä¸€ç»„è¿›ç¨‹ï¼‰æä¾›ç›¸åŒï¼ˆåŒè´¨çš„ï¼‰æœåŠ¡ï¼ŒæœåŠ¡è¯·æ±‚åº”è¯¥å‡åŒ€åˆ†æ‘Šåˆ°è¿™äº›èŠ‚ç‚¹ä¸Š
* å½“ç³»ç»Ÿé¢ä¸´å¤§é‡ç”¨æˆ·è®¿é—®ï¼Œè´Ÿè½½è¿‡é«˜çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šä½¿ç”¨å¢åŠ æœåŠ¡å™¨æ•°é‡æ¥è¿›è¡Œæ¨ªå‘æ‰©å±•ï¼Œä½¿ç”¨é›†ç¾¤å’Œè´Ÿè½½å‡è¡¡æé«˜æ•´ä¸ªç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›
* æŠŠç”¨æˆ·è®¿é—®çš„æµé‡é€šè¿‡ã€Œè´Ÿè½½å‡è¡¡å™¨ã€æ ¹æ®æŸç§è½¬å‘ç­–ç•¥ï¼Œå‡åŒ€çš„åˆ†å‘åˆ°åç«¯å¤šå°æœåŠ¡å™¨ä¸Šï¼Œåç«¯æœåŠ¡å™¨å¯ä»¥ç‹¬ç«‹å“åº”å’Œå¤„ç†è¯·æ±‚ï¼Œä»è€Œå®ç°åˆ†æ•£è´Ÿè½½çš„æ•ˆæœï¼Œè´Ÿè½½å‡è¡¡çš„å…³é”®åœ¨äºå°†ç”¨æˆ·æµé‡è¿›è¡Œå‡è¡¡å‡å‹çš„
* è®©æ‰€æœ‰èŠ‚ç‚¹ä»¥æœ€å°ä»£ä»·ã€æœ€å¥½çŠ¶æ€å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™æ ·ç³»ç»Ÿååé‡æœ€å¤§ï¼Œæ€§èƒ½æ›´é«˜ï¼Œå¯¹äºç”¨æˆ·è€Œè¨€è¯·æ±‚çš„æ—¶é—´ä¹Ÿæ›´å°
* ä¼˜ç‚¹
  - å¢å¼ºäº†ç³»ç»Ÿå¯é æ€§
  - æé«˜äº†ç³»ç»ŸæœåŠ¡èƒ½åŠ›
  - å¢å¼ºäº†åº”ç”¨å¯ç”¨æ€§ï¼Œæœ€å¤§åŒ–é™ä½äº†å•ä¸ªèŠ‚ç‚¹è¿‡è½½ã€ç”šè‡³crashæ¦‚ç‡
* è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§æ¨æ¨¡å‹ï¼Œä¸€å®šä¼šé€‰å‡ºä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œç„¶åæŠŠè¯·æ±‚æ¨é€è¿‡æ¥
* æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ‹‰æ¨¡å‹ï¼šç©ºé—²æœåŠ¡èŠ‚ç‚¹ä¸»åŠ¨å»æ‹‰å–è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå„ä¸ªèŠ‚ç‚¹è´Ÿè½½è‡ªç„¶ä¹Ÿæ˜¯å‡è¡¡çš„
  - æœåŠ¡èŠ‚ç‚¹ä¸ä¼šè¢«å¤§é‡è¯·æ±‚å†²å®ï¼ŒåŒæ—¶å¢åŠ æœåŠ¡èŠ‚ç‚¹æ›´åŠ å®¹æ˜“
  - ç¼ºç‚¹ï¼šè¯·æ±‚ä¸æ˜¯äº‹å®å¤„ç†çš„

### ç»“æ„

æ¯ä¸€ä¸ªä¸Šæ¸¸éƒ½å‡åŒ€è®¿é—®æ¯ä¸€ä¸ªä¸‹æ¸¸ï¼Œå°±èƒ½å®ç°â€œå°†è¯·æ±‚/æ•°æ®ã€å‡åŒ€ã€‘åˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒä¸Šæ‰§è¡Œ

* å®¢æˆ·ç«¯å±‚ï¼šå…¸å‹è°ƒç”¨æ–¹æ˜¯æµè§ˆå™¨browseræˆ–è€…æ‰‹æœºåº”ç”¨APPï¼Œæ ¹æ®æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯è‡ªè¡Œé€‰æ‹©ï¼Œç„¶åå°†è¯·æ±‚ç›´æ¥å‘é€åˆ°é€‰ä¸­æœåŠ¡èŠ‚ç‚¹
  - çŸ¥é“æœåŠ¡å™¨åˆ—è¡¨ï¼Œè¦ä¹ˆæ˜¯é™æ€é…ç½®ï¼Œè¦ä¹ˆæœ‰ç®€å•æ¥å£æŸ¥è¯¢
  - backend serverè¯¦ç»†è´Ÿè½½ä¿¡æ¯ï¼Œå°±ä¸é€‚ç”¨é€šè¿‡å®¢æˆ·ç«¯æ¥æŸ¥è¯¢
  - ç®—æ³•è¦ä¹ˆæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ¯”å¦‚è½®è®­ï¼ˆåŠ æƒè½®è®­ï¼‰ã€éšæœºï¼ˆåŠ æƒéšæœºï¼‰ã€å“ˆå¸Œè¿™å‡ ç§ç®—æ³•ï¼Œåªè¦æ¯ä¸ªå®¢æˆ·ç«¯è¶³å¤Ÿéšæœºï¼ŒæŒ‰ç…§å¤§æ•°å®šç†ï¼ŒæœåŠ¡èŠ‚ç‚¹çš„è´Ÿè½½ä¹Ÿæ˜¯å‡è¡¡çš„
  - è¾ƒä¸ºå¤æ‚ç®—æ³•ï¼Œæ¯”å¦‚æ ¹æ®backendçš„å®é™…è´Ÿè½½éœ€è¦å»é¢å¤–çš„è´Ÿè½½å‡è¡¡æœåŠ¡ï¼ˆexternal load balancing serviceï¼‰æŸ¥è¯¢åˆ°è¿™äº›ä¿¡æ¯ï¼Œåœ¨grpcä¸­ï¼Œå°±æ˜¯ä½¿ç”¨è¿™ç§åŠæ³•
    + load balancerä¸grpc serveré€šä¿¡ï¼Œè·å¾—grpc serverçš„è´Ÿè½½ç­‰å…·ä½“è¯¦ç»†
    + grpc clientä»load balancerè·å–è¿™äº›ä¿¡æ¯ï¼Œæœ€ç»ˆgrpc clientç›´è¿åˆ°è¢«é€‰æ‹©çš„grpc server
* åå‘ä»£ç†å±‚ï¼šç³»ç»Ÿå…¥å£ï¼Œåå‘ä»£ç†
  - æ°´å¹³æ‰©å±•é€šè¿‡â€œDNSè½®è¯¢â€å®ç°çš„ï¼šdns-serverå¯¹äºä¸€ä¸ªåŸŸåé…ç½®äº†å¤šä¸ªè§£æipï¼Œæ¯æ¬¡DNSè§£æè¯·æ±‚æ¥è®¿é—®dns-serverï¼Œä¼šè½®è¯¢è¿”å›è¿™äº›ip
  - å½“nginxæˆä¸ºç“¶é¢ˆçš„æ—¶å€™ï¼Œåªè¦å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œæ–°å¢nginxæœåŠ¡éƒ¨ç½²ï¼Œå¢åŠ ä¸€ä¸ªå¤–ç½‘ipï¼Œå°±èƒ½æ‰©å±•åå‘ä»£ç†å±‚çš„æ€§èƒ½ï¼Œåšåˆ°ç†è®ºä¸Šçš„æ— é™é«˜å¹¶å‘
  - è¯·æ±‚è½®è¯¢ï¼šå’ŒDNSè½®è¯¢ç±»ä¼¼ï¼Œè¯·æ±‚ä¾æ¬¡è·¯ç”±åˆ°å„ä¸ªweb-serverï¼›
  - æœ€å°‘è¿æ¥è·¯ç”±ï¼šå“ªä¸ªweb-serverçš„è¿æ¥å°‘ï¼Œè·¯ç”±åˆ°å“ªä¸ªweb-serverï¼›
  - ipå“ˆå¸Œï¼šæŒ‰ç…§è®¿é—®ç”¨æˆ·çš„ipå“ˆå¸Œå€¼æ¥è·¯ç”±web-serverï¼Œåªè¦ç”¨æˆ·çš„ipåˆ†å¸ƒæ˜¯å‡åŒ€çš„ï¼Œè¯·æ±‚ç†è®ºä¸Šä¹Ÿæ˜¯å‡åŒ€çš„ï¼Œipå“ˆå¸Œå‡è¡¡æ–¹æ³•å¯ä»¥åšåˆ°ï¼ŒåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å›ºå®šè½åˆ°åŒä¸€å°web-serverä¸Šï¼Œæ­¤ç­–ç•¥é€‚åˆæœ‰çŠ¶æ€æœåŠ¡ï¼Œä¾‹å¦‚sessionï¼›
* ç«™ç‚¹åº”ç”¨å±‚ï¼šå®ç°æ ¸å¿ƒåº”ç”¨é€»è¾‘ï¼Œè¿”å›htmlæˆ–è€…json
  - æ°´å¹³æ‰©å±•é€šè¿‡â€œnginxâ€å®ç°çš„ã€‚é€šè¿‡ä¿®æ”¹nginx.confï¼Œè®¾ç½®å¤šä¸ªwebåç«¯
  - å½“webåç«¯æˆä¸ºç“¶é¢ˆçš„æ—¶å€™ï¼Œå¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œæ–°å¢webæœåŠ¡éƒ¨ç½²ï¼Œåœ¨nginxé…ç½®ä¸­é…ç½®ä¸Šæ–°çš„webåç«¯ï¼Œå°±èƒ½æ‰©å±•ç«™ç‚¹å±‚çš„æ€§èƒ½ï¼Œåšåˆ°ç†è®ºä¸Šçš„æ— é™é«˜å¹¶å‘
* æœåŠ¡å±‚ï¼šå¦‚æœå®ç°äº†æœåŠ¡åŒ–ï¼Œå°±æœ‰è¿™ä¸€å±‚
  - æ°´å¹³æ‰©å±•é€šè¿‡â€œæœåŠ¡è¿æ¥æ± â€å®ç°çš„ã€‚ç«™ç‚¹å±‚é€šè¿‡RPC-clientè°ƒç”¨ä¸‹æ¸¸çš„æœåŠ¡å±‚RPC-serveræ—¶ï¼ŒRPC-clientä¸­çš„è¿æ¥æ± ä¼šå»ºç«‹ä¸ä¸‹æ¸¸æœåŠ¡å¤šä¸ªè¿æ¥ï¼Œå½“æœåŠ¡æˆä¸ºç“¶é¢ˆçš„æ—¶å€™ï¼Œåªè¦å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œæ–°å¢æœåŠ¡éƒ¨ç½²ï¼Œåœ¨RPC-clientå¤„å»ºç«‹æ–°çš„ä¸‹æ¸¸æœåŠ¡è¿æ¥ï¼Œå°±èƒ½æ‰©å±•æœåŠ¡å±‚æ€§èƒ½ï¼Œåšåˆ°ç†è®ºä¸Šçš„æ— é™é«˜å¹¶å‘
  - å¦‚æœéœ€è¦ä¼˜é›…è¿›è¡ŒæœåŠ¡å±‚è‡ªåŠ¨æ‰©å®¹ï¼Œéœ€è¦é…ç½®ä¸­å¿ƒé‡ŒæœåŠ¡è‡ªåŠ¨å‘ç°åŠŸèƒ½çš„æ”¯æŒ
* ç¼“å­˜å±‚ï¼šç¼“å­˜åŠ é€Ÿè®¿é—®å­˜å‚¨
* æ•°æ®åº“å±‚ï¼šæ•°æ®åº“å›ºåŒ–æ•°æ®å­˜å‚¨
* åœ¨æ•°æ®é‡å¾ˆå¤§æƒ…å†µä¸‹ï¼Œæ•°æ®å±‚ï¼ˆç¼“å­˜ï¼Œæ•°æ®åº“ï¼‰æ¶‰åŠæ•°æ®æ°´å¹³æ‰©å±•ï¼Œå°†åŸæœ¬å­˜å‚¨åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼ˆç¼“å­˜ï¼Œæ•°æ®åº“ï¼‰æ°´å¹³æ‹†åˆ†åˆ°ä¸åŒæœåŠ¡å™¨ä¸Šå»ï¼Œä»¥è¾¾åˆ°æ‰©å……ç³»ç»Ÿæ€§èƒ½çš„ç›®çš„ï¼Œè¦è€ƒè™‘â€œæ•°æ®çš„å‡è¡¡â€ä¸â€œè¯·æ±‚çš„å‡è¡¡â€ä¸¤ä¸ªç‚¹
  - æŒ‰ç…§èŒƒå›´æ°´å¹³æ‹†åˆ†ï¼šæ¯ä¸€ä¸ªæ•°æ®æœåŠ¡ï¼Œå­˜å‚¨ä¸€å®šèŒƒå›´çš„æ•°æ®ï¼Œuser0åº“ï¼Œå­˜å‚¨uidèŒƒå›´1-1kwï¼Œuser1åº“ï¼Œå­˜å‚¨uidèŒƒå›´1kw-2kw
    + è§„åˆ™ç®€å•ï¼Œserviceåªéœ€åˆ¤æ–­ä¸€ä¸‹uidèŒƒå›´å°±èƒ½è·¯ç”±åˆ°å¯¹åº”çš„å­˜å‚¨æœåŠ¡ï¼›
    + æ•°æ®å‡è¡¡æ€§è¾ƒå¥½ï¼›
    + æ¯”è¾ƒå®¹æ˜“æ‰©å±•ï¼Œå¯ä»¥éšæ—¶åŠ ä¸€ä¸ªuid[2kw,3kw]çš„æ•°æ®æœåŠ¡
    + ä¸è¶³ï¼šè¯·æ±‚çš„è´Ÿè½½ä¸ä¸€å®šå‡è¡¡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ–°æ³¨å†Œçš„ç”¨æˆ·ä¼šæ¯”è€ç”¨æˆ·æ›´æ´»è·ƒï¼Œå¤§rangeçš„æœåŠ¡è¯·æ±‚å‹åŠ›ä¼šæ›´å¤§
  - æŒ‰ç…§å“ˆå¸Œæ°´å¹³æ‹†åˆ†:æ¯ä¸€ä¸ªæ•°æ®åº“ï¼Œå­˜å‚¨æŸä¸ªkeyå€¼hashåçš„éƒ¨åˆ†æ•°æ®ï¼Œuser0åº“ï¼Œå­˜å‚¨å¶æ•°uidæ•°æ®,user1åº“ï¼Œå­˜å‚¨å¥‡æ•°uidæ•°æ®
    + è§„åˆ™ç®€å•ï¼Œserviceåªéœ€å¯¹uidè¿›è¡Œhashèƒ½è·¯ç”±åˆ°å¯¹åº”çš„å­˜å‚¨æœåŠ¡
    + æ•°æ®å‡è¡¡æ€§è¾ƒå¥½
    + è¯·æ±‚å‡åŒ€æ€§è¾ƒå¥½
    + ä¸å®¹æ˜“æ‰©å±•ï¼Œæ‰©å±•ä¸€ä¸ªæ•°æ®æœåŠ¡ï¼Œhashæ–¹æ³•æ”¹å˜æ—¶å€™ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œæ•°æ®è¿ç§»
  - æ°´å¹³æ‹†åˆ†æ¥æ‰©å……ç³»ç»Ÿæ€§èƒ½vsä¸»ä»åŒæ­¥è¯»å†™åˆ†ç¦»
    + æ°´å¹³æ‹†åˆ†æ‰©å±•æ•°æ®åº“æ€§èƒ½ï¼š
      * æ¯ä¸ªæœåŠ¡å™¨ä¸Šå­˜å‚¨çš„æ•°æ®é‡æ˜¯æ€»é‡çš„1/nï¼Œæ‰€ä»¥å•æœºçš„æ€§èƒ½ä¹Ÿä¼šæœ‰æå‡
      * nä¸ªæœåŠ¡å™¨ä¸Šçš„æ•°æ®æ²¡æœ‰äº¤é›†ï¼Œé‚£ä¸ªæœåŠ¡å™¨ä¸Šæ•°æ®çš„å¹¶é›†æ˜¯æ•°æ®çš„å…¨é›†
      * æ•°æ®æ°´å¹³æ‹†åˆ†åˆ°äº†nä¸ªæœåŠ¡å™¨ä¸Šï¼Œç†è®ºä¸Šè¯»æ€§èƒ½æ‰©å……äº†nå€ï¼Œå†™æ€§èƒ½ä¹Ÿæ‰©å……äº†nå€ï¼ˆå…¶å®è¿œä¸æ­¢nå€ï¼Œå› ä¸ºå•æœºçš„æ•°æ®é‡å˜ä¸ºäº†åŸæ¥çš„1/nï¼‰
    + é€šè¿‡ä¸»ä»åŒæ­¥è¯»å†™åˆ†ç¦»æ‰©å±•æ•°æ®åº“æ€§èƒ½ï¼š
      * æ¯ä¸ªæœåŠ¡å™¨ä¸Šå­˜å‚¨çš„æ•°æ®é‡æ˜¯å’Œæ€»é‡ç›¸åŒ
      * nä¸ªæœåŠ¡å™¨ä¸Šçš„æ•°æ®éƒ½ä¸€æ ·ï¼Œéƒ½æ˜¯å…¨é›†
      * ç†è®ºä¸Šè¯»æ€§èƒ½æ‰©å……äº†nå€ï¼Œå†™ä»ç„¶æ˜¯å•ç‚¹ï¼Œå†™æ€§èƒ½ä¸å˜
* æœåŠ¡èŠ‚ç‚¹é›†ç¾¤ä¹‹å‰æ”¾ä¸€ä¸ªé›†ä¸­å¼ä»£ç†ï¼ˆproxyï¼‰ï¼Œç”±ä»£ç†è´Ÿè´£è¯·æ±‚åˆ†å‘
  - 7å±‚Nginx:responseç»è¿‡Proxy
  - å››å±‚F5ã€LVS:responseä¸ç»è¿‡proxyï¼Œå¦‚LVS
  - åœ¨äºæ–¹ä¾¿æ§åˆ¶ï¼Œè€Œä¸”èƒ½å®¹æ˜“å®ç°ä¸€äº›æ›´ç²¾å¯†ï¼Œæ›´å¤æ‚çš„ç®—æ³•
  - ç¼ºç‚¹
    - è´Ÿè½½å‡è¡¡å™¨æœ¬èº«å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
    - å¯èƒ½å¼•å…¥é¢å¤–çš„å»¶è¿Ÿï¼Œè¯·æ±‚ä¸€å®šå…ˆå‘åˆ°è¾¾è´Ÿè½½å‡è¡¡å™¨ï¼Œç„¶ååˆ°è¾¾çœŸæ­£çš„æœåŠ¡èŠ‚ç‚¹ã€‚
  * load balancer proxyä¸èƒ½æˆä¸ºå•ç‚¹æ•…éšœï¼ˆsingle point of failureï¼‰ï¼Œå› æ­¤ä¸€èˆ¬ä¼šè®¾è®¡ä¸ºé«˜å¯ç”¨çš„ä¸»ä»ç»“æ„
  * responseä¹Ÿæ˜¯èµ°load balancer proxyçš„è¯ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡è¿‡ç¨‹å¯¹å®¢æˆ·ç«¯è€Œè¨€å°±æ˜¯å®Œå…¨é€æ˜çš„ï¼Œä¹Ÿé˜²æ­¢äº†å®¢æˆ·ç«¯å»å°è¯•è¿æ¥åå°æœåŠ¡å™¨ï¼Œæä¾›äº†ä¸€å±‚å®‰å…¨ä¿éšœï¼

![grpcåŸç†å›¾](../_static/grpc.png "grpcåŸç†å›¾")
![proxyåŸç†å›¾](../_static/proxy.png "proxyåŸç†å›¾")

### æ–¹æ¡ˆ

* HTTPé‡å®šå‘ï¼šæƒè¡¡è½¬ç§»è¯·æ±‚å¼€é”€å’Œå¤„ç†å®é™…è¯·æ±‚å¼€é”€ï¼Œå‰è€…ç›¸å¯¹äºåè€…è¶Šå°ï¼Œé‚£ä¹ˆé‡å®šå‘çš„æ„ä¹‰å°±è¶Šå¤§
  - ç¼ºé™·
    + ååç‡é™åˆ¶ï¼šä¸»ç«™ç‚¹æœåŠ¡å™¨çš„ååç‡å¹³å‡åˆ†é…åˆ°äº†è¢«è½¬ç§»çš„æœåŠ¡å™¨ç°å‡è®¾ä½¿ç”¨RRï¼ˆRound Robinï¼‰è°ƒåº¦ç­–ç•¥ï¼Œå­æœåŠ¡å™¨çš„æœ€å¤§ååç‡ä¸º1000reqs/sï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨çš„ååç‡è¦è¾¾åˆ°3000reqs/sï¼Œä¸»æœåŠ¡å™¨çš„ååä¸å­æœåŠ¡å™¨åååŒ¹é…
    + é‡å®šå‘è®¿é—®æ·±åº¦ä¸åŒ
* åŸºäºDNSè´Ÿè½½å‡è¡¡ï¼šå¯ä»¥å®ç°åœ¨åœ°åŸŸä¸Šæµé‡å‡è¡¡,DNSæœåŠ¡å™¨å……å½“è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨
  - ä½¿ç”¨åŸŸåç³»ç»Ÿé€šè¿‡å°†åŸŸåè§£æä¸ºæœåŠ¡å™¨çš„ä¸åŒ IP åœ°å€æ¥å°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨
  - å¤§å‹ç½‘ç«™ä¸€èˆ¬ä½¿ç”¨DNSä½œä¸ºç¬¬ä¸€çº§è´Ÿè½½å‡è¡¡ DNSèŠ‚çœäº†æ‰€è°“çš„ä¸»ç«™ç‚¹ï¼ŒDNSæœåŠ¡å™¨å……å½“ä¸»ç«™ç‚¹èŒèƒ½ã€‚å¸¸è§ç­–ç•¥æ˜¯å¯¹å¤šä¸ªAè®°å½•è¿›è¡ŒRR(è½®è¯¢)
    + åœ¨DNSæœåŠ¡å™¨é…ç½®å¤šä¸ªAè®°å½•ï¼Œä¸åŒçš„DNSè¯·æ±‚ä¼šè§£æåˆ°ä¸åŒçš„IPåœ°å€ è®©DNSæœåŠ¡å™¨æ ¹æ®ä¸åŒåœ°ç†ä½ç½®çš„ç”¨æˆ·è¿”å›ä¸åŒçš„IP
  - ç›¸å½“äºå®ç°äº†æŒ‰ç…§ã€Œå°±è¿‘åŸåˆ™ã€å°†è¯·æ±‚åˆ†æµäº†ï¼Œæ—¢å‡è½»äº†å•ä¸ªé›†ç¾¤çš„è´Ÿè½½å‹åŠ›ï¼Œä¹Ÿæå‡äº†ç”¨æˆ·çš„è®¿é—®é€Ÿåº¦
  - é…ç½®ç®€å•ï¼Œå®ç°æˆæœ¬éå¸¸ä½ï¼Œæ— éœ€é¢å¤–çš„å¼€å‘å’Œç»´æŠ¤å·¥ä½œ
  - ç¼ºç‚¹ï¼š
    + å¤§å¤šæ˜¯åŸºäºåœ°åŸŸæˆ–è€…å¹²è„†ç›´æ¥åšIPè½®è¯¢ï¼Œæ²¡æœ‰æ›´é«˜çº§çš„è·¯ç”±ç­–ç•¥ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯DNSæ–¹æ¡ˆçš„å±€é™æ‰€åœ¨ï¼Œæ¯”å¦‚ æ— æ³•å°†HTTPè¯·æ±‚çš„ä¸Šä¸‹æ–‡å¼•å…¥åˆ°è°ƒåº¦ç­–ç•¥ä¸­
    + DNSç”Ÿæ•ˆæ—¶é—´ç•¥é•¿ï¼Œå½“é…ç½®ä¿®æ”¹åï¼Œç”Ÿæ•ˆä¸åŠæ—¶ã€‚è¿™ä¸ªæ˜¯ç”±äºDNSçš„ç‰¹æ€§å¯¼è‡´çš„ï¼ŒDNSä¸€èˆ¬ä¼šæœ‰å¤šçº§ç¼“å­˜ï¼Œæ‰€ä»¥å½“ä¿®æ”¹äº†DNSé…ç½®ä¹‹åï¼Œç”±äºç¼“å­˜çš„åŸå› ï¼Œä¼šå¯¼è‡´IPå˜æ›´ä¸åŠæ—¶ï¼Œä»è€Œå½±å“è´Ÿè½½å‡è¡¡çš„æ•ˆæœ
    + å®¹æ˜“å¯¼è‡´æœåŠ¡å™¨ä¹‹é—´çš„åŠ¨æ€è´Ÿè½½ä¸å¹³è¡¡ï¼Œå› æ­¤æœåŠ¡å™¨å¾ˆéš¾å¤„ç†å…¶å³°å€¼è´Ÿè½½ã€‚åœ¨ DNS æœåŠ¡å™¨ä¸Šä¸èƒ½å¾ˆå¥½åœ°é€‰æ‹©åç§°æ˜ å°„çš„ TTL å€¼ã€‚
* åŸºäºç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼šç”¨äºå¤§å‹æœåŠ¡å™¨é›†ç¾¤ä¸­çš„è´Ÿè½½éœ€æ±‚ï¼ŒF5 Network Big-IP
  - å®Œå…¨é€šè¿‡ç¡¬ä»¶æ¥æŠ—å‹åŠ›ï¼Œæ€§èƒ½æ˜¯éå¸¸çš„å¥½ã€‚ç”¨åœ¨å¤§å‹äº’è”ç½‘å…¬å¸çš„æµé‡å…¥å£æœ€å‰ç«¯
  - ä¼˜ç‚¹ï¼š
    + åŠŸèƒ½å¼ºå¤§ï¼šæ”¯æŒå„å±‚çº§è´Ÿè½½å‡è¡¡åŠå…¨é¢è´Ÿè½½å‡è¡¡ç®—æ³•ï¼›
    + æ€§èƒ½å¼ºå¤§ï¼šæ€§èƒ½è¿œè¶…å¸¸è§çš„è½¯ä»¶è´Ÿè½½å‡è¡¡å™¨ï¼›
    + ç¨³å®šæ€§é«˜ï¼šç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼Œå¤§è§„æ¨¡ä½¿ç”¨è‚¯å®šæ˜¯ä¸¥æ ¼æµ‹è¯•è¿‡çš„ï¼›
    + å®‰å…¨é˜²æŠ¤ï¼šé™¤å…·å¤‡è´Ÿè½½å‡è¡¡åŠŸèƒ½å¤–ï¼Œè¿˜å…·å¤‡é˜²ç«å¢™ã€é˜² DDoS æ”»å‡»ç­‰å®‰å…¨åŠŸèƒ½ï¼›
  - ç¼ºç‚¹ï¼š
    + ä»·æ ¼æ˜‚è´µï¼›
    + å¯æ‰©å±•æ€§å·®ï¼›
    + è°ƒè¯•ç»´æŠ¤éº»çƒ¦ï¼›
* åŸºäºè½¯ä»¶è´Ÿè½½å‡è¡¡ï¼šåŸºäºæœºå™¨å±‚é¢çš„æµé‡å‡è¡¡
  - åå‘ä»£ç†è´Ÿè½½å‡è¡¡ï½œä¸ƒå±‚è´Ÿè½½å‡è¡¡ :åŸºäºç¬¬ä¸ƒå±‚åº”ç”¨å±‚æ¥åšæµé‡åˆ†å‘
    + å·¥ä½œåœ¨HTTPå±‚é¢ï¼Œæ ¸å¿ƒå·¥ä½œæ˜¯è½¬å‘HTTP
    + ä»»ä½•å¯¹äºå®é™…æœåŠ¡å™¨HTTPè¯·æ±‚éƒ½å¿…é¡»ç»è¿‡è°ƒåº¦å™¨
    + è°ƒåº¦å™¨å¿…é¡»ç­‰å¾…å®é™…æœåŠ¡å™¨HTTPå“åº”ï¼Œå¹¶å°†å®ƒåé¦ˆç»™ç”¨æˆ·
    + ç‰¹æ€§ï¼š
      * è°ƒåº¦ç­–ç•¥ä¸°å¯Œ
      * å¯¹åå‘ä»£ç†æœåŠ¡å™¨çš„å¹¶å‘å¤„ç†èƒ½åŠ›è¦æ±‚é«˜ï¼Œå› ä¸ºå®ƒå·¥ä½œåœ¨HTTPå±‚é¢
      * åå‘ä»£ç†æœåŠ¡å™¨è¿›è¡Œè½¬å‘æ“ä½œæœ¬èº«éœ€è¦ä¸€å®šå¼€é”€çš„ï¼Œæ¯”å¦‚åˆ›å»ºçº¿ç¨‹ã€ä¸åç«¯æœåŠ¡å™¨å»ºç«‹TCPè¿æ¥ã€æ¥æ”¶åç«¯æœåŠ¡å™¨è¿”å›çš„å¤„ç†ç»“æœã€åˆ†æHTTPå¤´éƒ¨ä¿¡æ¯ã€ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é¢‘ç¹åˆ‡æ¢ç­‰ï¼Œè™½ç„¶è¿™éƒ¨åˆ†æ—¶é—´å¹¶ä¸é•¿ï¼Œä½†æ˜¯å½“åç«¯æœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æ—¶é—´éå¸¸çŸ­æ—¶ï¼Œè½¬å‘çš„å¼€é”€å°±æ˜¾å¾—å°¤ä¸ºçªå‡ºã€‚ä¾‹å¦‚è¯·æ±‚é™æ€æ–‡ä»¶ï¼Œæ›´é€‚åˆä½¿ç”¨å‰é¢ä»‹ç»çš„åŸºäºDNSçš„è´Ÿè½½å‡è¡¡æ–¹å¼
      * åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥ç›‘æ§åç«¯æœåŠ¡å™¨ï¼Œæ¯”å¦‚ç³»ç»Ÿè´Ÿè½½ã€å“åº”æ—¶é—´ã€æ˜¯å¦å¯ç”¨ã€TCPè¿æ¥æ•°ã€æµé‡ç­‰ï¼Œä»è€Œæ ¹æ®è¿™äº›æ•°æ®è°ƒæ•´è´Ÿè½½å‡è¡¡çš„ç­–ç•¥
      * åå°„ä»£ç†æœåŠ¡å™¨å¯ä»¥è®©ç”¨æˆ·åœ¨ä¸€æ¬¡ä¼šè¯å‘¨æœŸå†…çš„æ‰€æœ‰è¯·æ±‚å§‹ç»ˆè½¬å‘åˆ°ä¸€å°ç‰¹å®šçš„åç«¯æœåŠ¡å™¨ä¸Šï¼ˆç²˜æ»ä¼šè¯ï¼‰ï¼Œè¿™æ ·çš„å¥½å¤„ä¸€æ˜¯ä¿æŒsessionçš„æœ¬åœ°è®¿é—®ï¼ŒäºŒæ˜¯é˜²æ­¢åç«¯æœåŠ¡å™¨çš„åŠ¨æ€å†…å­˜ç¼“å­˜çš„èµ„æºæµªè´¹
    + Nginxï¼šä¸ƒå±‚è´Ÿè½½å‡è¡¡ ï¼Œä¹Ÿç§°ä¸ºâ€œå†…å®¹äº¤æ¢â€ï¼Œä¹Ÿå°±æ˜¯ä¸»è¦é€šè¿‡æŠ¥æ–‡ä¸­çœŸæ­£æœ‰æ„ä¹‰çš„åº”ç”¨å±‚å†…å®¹
      * ä¼ ç»Ÿï¼šç›¸å¯¹äºä¼ ç»ŸåŸºäºè¿›ç¨‹æˆ–çº¿ç¨‹æ¨¡å‹ï¼ˆApacheå°±é‡‡ç”¨è¿™ç§æ¨¡å‹ï¼‰åœ¨å¤„ç†å¹¶å‘è¿æ¥æ—¶ä¼šä¸ºæ¯ä¸€ä¸ªè¿æ¥å»ºç«‹ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œä¸”åœ¨ç½‘ç»œæˆ–è€…è¾“å…¥/è¾“å‡ºæ“ä½œæ—¶é˜»å¡ï¼Œå°†å¯¼è‡´å†…å­˜å’Œ CPU çš„å¤§é‡æ¶ˆè€—ï¼Œå› ä¸ºæ–°èµ·ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹æˆ–çº¿ç¨‹éœ€è¦å‡†å¤‡æ–°çš„è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒ…æ‹¬å †å’Œæ ˆå†…å­˜çš„åˆ†é…ï¼Œä»¥åŠæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå½“ç„¶ï¼Œè¿™äº›ä¹Ÿä¼šå¯¼è‡´å¤šä½™çš„ CPU å¼€é”€ã€‚æœ€ç»ˆï¼Œä¼šç”±äºè¿‡å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢è€Œå¯¼è‡´æœåŠ¡å™¨æ€§èƒ½å˜å·®ã€‚
      * Nginx çš„æ¶æ„è®¾è®¡æ˜¯é‡‡ç”¨æ¨¡å—åŒ–çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥ã€å•çº¿ç¨‹ä¸”éé˜»å¡
  - [HAProxy](../../ops/HAProxy.md)
* æ—¥ PV å°äº1000ä¸‡ï¼Œç”¨ Nginx å°±å®Œå…¨å¯ä»¥äº†ï¼›å¦‚æœæœºå™¨ä¸å°‘ï¼Œå¯ä»¥ç”¨ DNS è½®è¯¢ï¼ŒLVS æ‰€è€—è´¹çš„æœºå™¨è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼›å¤§å‹ç½‘ç«™æˆ–é‡è¦çš„æœåŠ¡ï¼Œä¸”æœåŠ¡å™¨æ¯”è¾ƒå¤šæ—¶ï¼Œå¯ä»¥è€ƒè™‘ç”¨ LVS
* åˆç†æµè¡Œæ¶æ„æ–¹æ¡ˆï¼šWeb å‰ç«¯é‡‡ç”¨ Nginx/HAProxy+Keepalived ä½œè´Ÿè½½å‡è¡¡å™¨ï¼›åç«¯é‡‡ç”¨ MySQLæ•°æ®åº“ä¸€ä¸»å¤šä»å’Œè¯»å†™åˆ†ç¦»ï¼Œé‡‡ç”¨ LVS+Keepalived çš„æ¶æ„
* Googleäº2016å¹´3æœˆæœ€æ–°å…¬å¸ƒçš„è´Ÿè½½å‡è¡¡Maglev
  - Maglevæ˜¯è°·æ­Œä¸ºè‡ªå·±çš„æ•°æ®ä¸­å¿ƒç ”å‘çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶äº2008å¼€å§‹ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚åœ¨ç¬¬åä¸‰å±Šç½‘ç»œç³»ç»Ÿè®¾è®¡ä¸å®ç°USENIXç ”è®¨ä¼šï¼ˆNSDI '16ï¼‰ä¸Šï¼Œ æ¥è‡ªè°·æ­Œã€åŠ å·å¤§å­¦æ´›æ‰çŸ¶åˆ†æ ¡ã€SpaceXå…¬å¸çš„å·¥ç¨‹å¸ˆä»¬åˆ†äº«äº†è¿™ä¸€å•†ç”¨æœåŠ¡å™¨è´Ÿè½½å‡è¡¡å™¨Maglevçš„è¯¦ç»†ä¿¡æ¯
  - Maglevå®‰è£…åä¸éœ€è¦é¢„çƒ­5ç§’å†…å°±èƒ½åº”ä»˜æ¯ç§’100ä¸‡æ¬¡è¯·æ±‚ä»¤äººæƒŠå¹ä¸å·²ã€‚åœ¨è°·æ­Œçš„æ€§èƒ½åŸºå‡†æµ‹è¯•ä¸­ï¼ŒMaglevå®ä¾‹è¿è¡Œåœ¨ä¸€ä¸ª8æ ¸CPUä¸‹ï¼Œç½‘ç»œååç‡ä¸Šé™ä¸º12M PPS(æ•°æ®åŒ…æ¯ç§’)ï¼Œå¦‚æœMaglevä½¿ç”¨Linuxå†…æ ¸ç½‘ç»œå †æ ˆåˆ™é€Ÿåº¦ä¼šå°äº4M PPS
* å›½å†…äº‘æœåŠ¡å•† UCloud è¿›ä¸€æ­¥è¿­ä»£äº†è´Ÿè½½å‡è¡¡äº§å“----Vortexï¼ŒæˆåŠŸåœ°æå‡äº†å•æœºæ€§èƒ½
  - åœ¨æŠ€æœ¯å®ç°ä¸Šï¼ŒUCloud Vortexä¸Google Maglevé¢‡ä¸ºç›¸ä¼¼ã€‚ä»¥ä¸€å°æ™®é€šæ€§ä»·æ¯”çš„x86 1UæœåŠ¡å™¨ä¸ºä¾‹ï¼ŒVortexå¯ä»¥å®ç°ååé‡è¾¾14M PPS(10G, 64å­—èŠ‚çº¿é€Ÿ)ï¼Œæ–°å»ºè¿æ¥200k CPSä»¥ä¸Šï¼Œå¹¶å‘è¿æ¥æ•°è¾¾åˆ°3000ä¸‡ã€10Gçº¿é€Ÿçš„è½¬å‘

## å››å±‚è´Ÿè½½å‡è¡¡ï½œ[Linux Virtual Server LVS](http://www.linuxvirtualserver.org)

* åŸºäºç¬¬å››å±‚ä¼ è¾“å±‚æ¥åšæµé‡åˆ†å‘æ–¹æ¡ˆï¼Œè´Ÿè½½å‡è¡¡å·¥ä½œåœ¨ä¼ è¾“å±‚ï¼Œå¯¹æ•°æ®åŒ…ä¸­çš„IPåœ°å€å’Œç«¯å£è¿›è¡Œä¿®æ”¹ï¼Œä»è€Œè¾¾åˆ°è½¬å‘çš„ç›®çš„ï¼Œæ”¯æŒ TCP/UDP è´Ÿè½½å‡è¡¡
* LVSåœ¨Linuxå†…æ ¸æ€è·å–åˆ°IPæŠ¥æ–‡åï¼Œæ ¹æ®ç‰¹å®šè´Ÿè½½å‡è¡¡ç®—æ³•å°†IPæŠ¥æ–‡è½¬å‘åˆ°æ•´ä¸ªé›†ç¾¤çš„æŸå°æœåŠ¡å™¨ä¸­å»
* æœåŠ¡å™¨é›†ç¾¤ç³»ç»Ÿç»„æˆï¼š
  - æœ€å‰ç«¯è´Ÿè½½å‡è¡¡å±‚ Load Balancer
    + æœåŠ¡å™¨ç¾¤é›†ç³»ç»Ÿçš„å•ä¸ªå…¥å£ç‚¹ï¼Œå¯è¿è¡Œ IPVSï¼Œè¯¥ IPVS åœ¨ Linux å†…æ ¸æˆ– KTCPVS å†…éƒ¨å®ç° IP è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œåœ¨ Linux å†…æ ¸ä¸­å®ç°åº”ç”¨ç¨‹åºçº§è´Ÿè½½å¹³è¡¡ã€‚
    + ä½¿ç”¨ IPVS æ—¶ï¼Œè¦æ±‚æ‰€æœ‰æœåŠ¡å™¨æä¾›ç›¸åŒçš„æœåŠ¡å’Œå†…å®¹ï¼Œè´Ÿè½½å‡è¡¡å™¨æ ¹æ®æŒ‡å®šçš„è°ƒåº¦ç®—æ³•å’Œæ¯ä¸ªæœåŠ¡å™¨çš„è´Ÿè½½å°†æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚è½¬å‘åˆ°æœåŠ¡å™¨ã€‚
    + æ— è®ºé€‰æ‹©å“ªä¸ªæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯éƒ½åº”è·å¾—ç›¸åŒçš„ç»“æœã€‚ä½¿ç”¨ KTCPVS æ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥å…·æœ‰ä¸åŒçš„å†…å®¹ï¼Œè´Ÿè½½å‡è¡¡å™¨å¯ä»¥æ ¹æ®è¯·æ±‚çš„å†…å®¹å°†è¯·æ±‚è½¬å‘åˆ°å…¶ä»–æœåŠ¡å™¨ã€‚
    + ç”±äº KTCPVS æ˜¯åœ¨ Linux å†…æ ¸å†…éƒ¨å®ç°çš„ï¼Œå› æ­¤ä¸­ç»§æ•°æ®çš„å¼€é”€å¾ˆå°ï¼Œå› æ­¤ä»å¯ä»¥å…·æœ‰è¾ƒé«˜çš„ååé‡ã€‚
  - ä¸­é—´æœåŠ¡å™¨é›†ç¾¤å±‚ Server Array|pool
    + æ¯ä¸ªèŠ‚ç‚¹å…·æœ‰ç‹¬ç«‹çš„çœŸå® IP åœ°å€ï¼Œåªå¤„ç†è°ƒåº¦å™¨åˆ†å‘è¿‡æ¥çš„å®¢æˆ·æœºè¯·æ±‚
    + èŠ‚ç‚¹å¯æ ¹æ®ç³»ç»Ÿæ‰€æ‰¿å—çš„è´Ÿè½½è¿›è¡Œåˆ†æ‹…ã€‚å½“æ‰€æœ‰æœåŠ¡å™¨è¿‡è½½æ—¶ï¼Œå¯æ·»åŠ å¤šå°æœåŠ¡å™¨æ¥å¤„ç†ä¸æ–­å¢åŠ çš„å·¥ä½œè´Ÿè½½.éšç€æœåŠ¡å™¨ç¾¤é›†çš„èŠ‚ç‚¹æ•°å¢åŠ ï¼Œæ•´ä½“æ€§èƒ½å‡ ä¹å¯ä»¥çº¿æ€§æ‰©å±•
  - æœ€åº•ç«¯æ•°æ®å…±äº«å­˜å‚¨å±‚ Shared Storage
    + ä¸ºæœåŠ¡å™¨æ± ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹æä¾›ç¨³å®šã€ä¸€è‡´çš„æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼Œç¡®ä¿æ•´ä¸ªç¾¤é›†çš„ç»Ÿä¸€æ€§ï¼Œå¯ä½¿ç”¨ NAS è®¾å¤‡æˆ–æä¾› NFS ï¼ˆNetwork File Systemï¼‰ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå…±äº«æœåŠ¡çš„ä¸“ç”¨æœåŠ¡å™¨ã€‚
    + å¯ä»¥æ˜¯æ•°æ®åº“ç³»ç»Ÿï¼Œç½‘ç»œæ–‡ä»¶ç³»ç»Ÿæˆ–åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚
    + æœåŠ¡å™¨èŠ‚ç‚¹éœ€è¦åŠ¨æ€æ›´æ–°çš„æ•°æ®åº”å­˜å‚¨åœ¨åŸºäºæ•°æ®çš„ç³»ç»Ÿä¸­ï¼Œå½“æœåŠ¡å™¨èŠ‚ç‚¹å¹¶è¡Œåœ¨æ•°æ®åº“ç³»ç»Ÿä¸­è¯»å†™æ•°æ®æ—¶ï¼Œæ•°æ®åº“ç³»ç»Ÿå¯ä»¥ä¿è¯å¹¶å‘æ•°æ®è®¿é—®çš„ä¸€è‡´æ€§ã€‚
    + é™æ€æ•°æ®é€šå¸¸ä¿å­˜åœ¨ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ NFS å’Œ CIFSï¼‰ä¸­ï¼Œä»¥ä¾¿å¯ä»¥ç”±æ‰€æœ‰æœåŠ¡å™¨èŠ‚ç‚¹å…±äº«æ•°æ®
    + å•ä¸ªç½‘ç»œæ–‡ä»¶ç³»ç»Ÿçš„å¯ä¼¸ç¼©æ€§å—åˆ°é™åˆ¶ï¼Œä¾‹å¦‚ï¼Œå•ä¸ª NFS / CIFS åªèƒ½æ”¯æŒ 4 åˆ° 8 ä¸ªæœåŠ¡å™¨çš„æ•°æ®è®¿é—®ã€‚
    + å¯¹äºå¤§å‹é›†ç¾¤ç³»ç»Ÿï¼Œåˆ†å¸ƒå¼/é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿå¯ä»¥ç”¨äºå…±äº«å­˜å‚¨ï¼Œä¾‹å¦‚ GPFSï¼ŒCoda å’Œ GFSï¼Œç„¶åå…±äº«å­˜å‚¨ä¹Ÿå¯ä»¥æ ¹æ®ç³»ç»Ÿéœ€æ±‚è¿›è¡Œæ‰©å±•ã€‚
* åŸç†
  - netfilter åŸºæœ¬åŸç†
    + LVS æ˜¯åŸºäº Linux å†…æ ¸ä¸­ netfilter æ¡†æ¶å®ç°çš„è´Ÿè½½å‡è¡¡ç³»ç»Ÿ
    + å¹³æ—¶è¯´çš„ Linux é˜²ç«å¢™å°±æ˜¯ netfilter,iptables å’Œ netfilter æ˜¯ Linux é˜²ç«å¢™ç»„åˆå·¥å…·ï¼Œæ˜¯ä¸€èµ·æ¥å®Œæˆç³»ç»Ÿé˜²æŠ¤å·¥ä½œçš„
    + iptables æ˜¯ä½äºç”¨æˆ·ç©ºé—´ï¼Œè€Œ Netfilter æ˜¯ä½äºå†…æ ¸ç©ºé—´ã€‚iptables åªæ˜¯ç”¨æˆ·ç©ºé—´ç¼–å†™å’Œä¼ é€’è§„åˆ™çš„å·¥å…·è€Œå·²ï¼ŒçœŸæ­£å·¥ä½œçš„è¿˜æ˜¯ netfilter
    + åŒºåˆ«
      * Netfilter æ˜¯å†…æ ¸æ€çš„ Linux é˜²ç«å¢™æœºåˆ¶ï¼Œå®ƒä½œä¸ºä¸€ä¸ªé€šç”¨ã€æŠ½è±¡çš„æ¡†æ¶ï¼Œæä¾›äº†ä¸€æ•´å¥—çš„ hook å‡½æ•°ç®¡ç†æœºåˆ¶ï¼Œæä¾›æ•°æ®åŒ…è¿‡æ»¤ã€ç½‘ç»œåœ°å€è½¬æ¢ã€åŸºäºåè®®ç±»å‹çš„è¿æ¥è·Ÿè¸ªçš„åŠŸèƒ½ï¼Œå¯åœ¨æ•°æ®åŒ…æµç»è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®è§„åˆ™è®¾ç½®è‹¥å¹²ä¸ªå…³å¡ï¼ˆhook å‡½æ•°ï¼‰æ¥æ‰§è¡Œç›¸å…³æ“ä½œï¼Œå…±è®¾ç½®äº† 5 ä¸ªç‚¹ï¼ŒåŒ…æ‹¬ï¼šPREROUTINGã€INPUTã€FORWARDã€OUTPUTã€POSTROUTINGã€‚
        - preroutingï¼š åœ¨å¯¹æ•°æ®åŒ…åšè·¯ç”±é€‰æ‹©ä¹‹å‰ï¼Œå°†åº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼›
        - inputï¼š å½“æ”¶åˆ°è®¿é—®é˜²ç«å¢™æœ¬æœºåœ°å€çš„æ•°æ®åŒ…æ—¶ï¼Œå°†åº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼›
        - forwardï¼š å½“æ”¶åˆ°éœ€è¦é€šè¿‡é˜²ç«ä¸­è½¬å‘ç»™å…¶ä»–åœ°å€çš„æ•°æ®åŒ…æ—¶ï¼Œå°†åº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼›
        - outputï¼š å½“é˜²ç«å¢™æœ¬æœºå‘å¤–å‘é€æ•°æ®åŒ…æ—¶ï¼Œå°†åº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼›
        - postroutingï¼š åœ¨å¯¹æ•°æ®åŒ…åšè·¯ç”±é€‰æ‹©ä¹‹åï¼Œå°†åº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™ï¼›
      * iptable æ˜¯ç”¨æˆ·å±‚çš„å·¥å…·ï¼Œæä¾›å‘½ä»¤è¡Œæ¥å£ï¼Œèƒ½å¤Ÿå‘ Netfilter ä¸­æ·»åŠ è§„åˆ™ç­–ç•¥ï¼Œä»è€Œå®ç°æŠ¥æ–‡è¿‡æ»¤ï¼Œä¿®æ”¹ç­‰åŠŸèƒ½
  - LVS åŸºäº netfilter æ¡†æ¶ï¼Œå·¥ä½œåœ¨ INPUT é“¾ä¸Šï¼Œåœ¨ INPUT é“¾ä¸Šæ³¨å†Œ ip_vs_in HOOK å‡½æ•°ï¼Œè¿›è¡Œ IPVS ç›¸å…³ä¸»æµç¨‹
    + IPVS å·¥ä½œåœ¨ INPUT é“¾ä¸Šï¼Œä¼šæ ¹æ®è®¿é—®çš„VIPå’Œç«¯å£åˆ¤æ–­è¯·æ±‚æ˜¯å¦ä¸º IPVS æœåŠ¡ï¼Œæ˜¯çš„æƒ…å†µä¸‹ï¼Œåˆ™è°ƒç”¨æ³¨å†Œçš„IPVS HOOK å‡½æ•°ï¼Œè¿›è¡ŒIPVSç›¸å…³æµç¨‹ï¼Œå¹¶å¼ºåˆ¶ä¿®æ”¹æ•°æ®åŒ…çš„ç›¸å…³æ•°æ®ï¼Œå¹¶å°†æ•°æ®åŒ…å‘å¾€POSTROUTINGé“¾ä¸­
    + POSTROUTINGé“¾æ”¶åˆ°æ•°æ®åŒ…åï¼Œå°†æ ¹æ®ç›®æ ‡ IP åœ°å€æœåŠ¡å™¨ï¼Œé€šè¿‡è·¯ç”±é€‰è·¯ï¼Œå°†æ•°æ®åŒ…æœ€ç»ˆå‘é€è‡³åç«¯çœŸå®æœåŠ¡å™¨ä¸­
* ç‰¹ç‚¹
  * åŸºäº 4 å±‚çš„ç½‘ç»œåè®®çš„ï¼ŒæŠ—è´Ÿè½½èƒ½åŠ›å¼ºï¼Œå¯¹äºæœåŠ¡å™¨çš„ç¡¬ä»¶è¦æ±‚é™¤äº†ç½‘å¡å¤–ï¼Œå…¶ä»–æ²¡æœ‰å¤ªå¤šè¦æ±‚
  * é…ç½®æ€§æ¯”è¾ƒä½ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼ºç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªä¼˜ç‚¹ï¼Œå› ä¸ºæ²¡æœ‰å¯å¤ªå¤šé…ç½®çš„ä¸œè¥¿ï¼Œå¤§å¤§å‡å°‘äº†äººä¸ºå‡ºé”™çš„å‡ ç‡
  * åº”ç”¨èŒƒå›´æ¯”è¾ƒå¹¿ï¼Œä¸ä»…ä»…å¯¹ web æœåŠ¡åšè´Ÿè½½å‡è¡¡ï¼Œè¿˜å¯ä»¥å¯¹å…¶ä»–åº”ç”¨ï¼ˆmysqlï¼‰åšè´Ÿè½½å‡è¡¡
  * LVS æ¶æ„ä¸­å­˜åœ¨ä¸€ä¸ªè™šæ‹Ÿ IP çš„æ¦‚å¿µï¼Œéœ€è¦å‘ IDC å¤šç”³è¯·ä¸€ä¸ª IP æ¥åšè™šæ‹Ÿ IP

+ ç»„æˆ
  ipvs(ip virtual server)ï¼šLVS æ˜¯åŸºäºå†…æ ¸æ€çš„ netfilter æ¡†æ¶å®ç°çš„ IPVS åŠŸèƒ½ï¼Œå·¥ä½œåœ¨å†…æ ¸æ€ã€‚ç”¨æˆ·é…ç½® VIP ç­‰ç›¸å…³ä¿¡æ¯å¹¶ä¼ é€’åˆ° IPVS å°±éœ€è¦ç”¨åˆ° ipvsadm å·¥å…·ã€‚
  - ipvsadmï¼šipvsadm æ˜¯ LVS ç”¨æˆ·æ€çš„é…å¥—å·¥å…·ï¼Œå¯ä»¥å®ç° VIP å’Œ RS çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ï¼Œæ˜¯åŸºäº netlink æˆ– raw socket æ–¹å¼ä¸å†…æ ¸ LVS è¿›è¡Œé€šä¿¡çš„ï¼Œå¦‚æœ LVS ç±»æ¯”äº netfilterï¼Œé‚£ ipvsadm å°±æ˜¯ç±»ä¼¼ iptables å·¥å…·çš„åœ°ä½

* è½¬å‘ä¸»è¦é€šè¿‡ä¿®æ”¹ IP åœ°å€ï¼ˆNAT æ¨¡å¼ï¼Œåˆ†ä¸ºæºåœ°å€ä¿®æ”¹ SNAT å’Œç›®æ ‡åœ°å€ä¿®æ”¹ DNATï¼‰
  - NAT Network Address Translatio æ˜¯ä¸€ç§å¤–ç½‘å’Œå†…ç½‘åœ°å€æ˜ å°„çš„æŠ€æœ¯
    + å®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚æ•°æ®åŒ…ç»è¿‡ç½‘ç»œåˆ°è¾¾ LVS ç½‘å¡ï¼Œæ•°æ®åŒ…æº IP ä¸º CIPï¼Œç›®çš„ IP ä¸º VIP
    + è¿›å…¥ PREROUTING é“¾ä¸­ï¼Œæ ¹æ®ç›®çš„ IP æŸ¥æ‰¾è·¯ç”±ï¼Œç¡®å®šæ˜¯å¦ä¸ºæœ¬æœº IP åœ°å€ï¼Œéšåå°†æ•°æ®åŒ…è½¬å‘è‡³ INPUT é“¾ä¸­ï¼Œæº IP å’Œ ç›®çš„ IP ä¸å˜
    + åˆ°è¾¾ LVS åï¼Œé€šè¿‡ç›®çš„ IP å’Œç›®çš„ PORT æŸ¥æ‰¾æ˜¯å¦ä¸º IPVS æœåŠ¡ï¼Œå¦‚æ˜¯ IPVS æœåŠ¡ï¼Œå°†ä¼šé€‰æ‹©ä¸€ä¸ª RS æ¥ä½œä¸ºåç«¯æœåŠ¡å™¨(ç›®æ ‡åœ°å€è½¬æ¢ DNAT)ï¼Œæ•°æ®åŒ…çš„ç›®çš„ IP åœ°å€å°†ä¼šä¿®æ”¹ä¸º RIPï¼Œè¿™æ—¶å¹¶ä»¥ RIP ä¸ºç›®çš„ IP å»æŸ¥æ‰¾è·¯ç”±ï¼Œç¡®å®šä¸‹ä¸€è·³åŠ PORT ä¿¡æ¯åï¼Œæ•°æ®åŒ…å°†ä¼šè½¬å‘è‡³ OUTPUT é“¾ä¸­
    + è¢«ä¿®æ”¹è¿‡çš„æ•°æ®åŒ…ç»è¿‡ POSTROUTING é“¾åï¼Œåˆ°è¾¾ RS æœåŠ¡å™¨ï¼Œæ•°æ®åŒ…æº IP ä¸º CIPï¼Œç›®çš„ IP ä¸º RIP
    + RS æœåŠ¡å™¨ç»è¿‡å¤„ç†åï¼Œå°†ä¼šæŠŠæ•°æ®åŒ…å‘é€è‡³ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºï¼Œå¾…å¤„ç†å®Œæˆåï¼Œå‘é€å“åº”æ•°æ®åŒ…ï¼ŒRS æœåŠ¡å™¨çš„é»˜è®¤ç½‘å…³ä¸º LVS çš„ IPï¼Œåº”ç”¨ç¨‹åºå°†ä¼šæŠŠæ•°æ®åŒ…è½¬å‘è‡³ä¸‹ä¸€è·³ LVS æœåŠ¡å™¨ï¼Œæ•°æ®åŒ…æº IP ä¸º RIPï¼Œç›®çš„ IP ä¸º CIP
    + LVS æœåŠ¡å™¨æ”¶åˆ° RS æœåŠ¡å™¨å“åº”çš„æ•°æ®åŒ…åï¼ŒæŸ¥æ‰¾è·¯ç”±ï¼Œç›®çš„ IP ä¸æ˜¯æœ¬æœºå¹¶ä¸” LVS æœåŠ¡å™¨å¼€å¯äº† FORWARD æ¨¡å¼ï¼Œä¼šå°†æ•°æ®åŒ…è½¬å‘ç»™å®ƒï¼Œæ•°æ®åŒ…ä¸å˜
    + LVS æœåŠ¡å™¨æ”¶åˆ°å“åº”æ•°æ®åŒ…åï¼Œæ ¹æ®ç›®çš„ IP å’Œ ç›®çš„ PORT æŸ¥æ‰¾ç›¸åº”çš„æœåŠ¡ï¼Œè¿™æ—¶ï¼Œæº IP ä¸º VIP(æºåœ°å€è½¬æ¢ SNATï¼‰ï¼Œé€šè¿‡æŸ¥æ‰¾è·¯ç”±ï¼Œç¡®å®šä¸‹ä¸€è·³ä¿¡æ¯å¹¶å°†æ•°æ®åŒ…å‘é€è‡³ç½‘å…³ï¼Œæœ€ç»ˆå›åº”ç»™å®¢æˆ·ç«¯ç”¨æˆ·

    + NATæœåŠ¡å™¨ï¼ˆå‰ç«¯æœåŠ¡å™¨ï¼‰å¿…é¡»ä½œä¸ºå®é™…æœåŠ¡å™¨ï¼ˆåç«¯æœåŠ¡å™¨ï¼‰çš„ç½‘å…³ï¼Œå¦åˆ™æ•°æ®åŒ…è¢«è½¬å‘åå°†ä¸€å»ä¸è¿”
    + ä»Linux2.4å†…æ ¸å¼€å§‹ï¼Œå†…ç½®Neftilteræ¨¡å—åœ¨å†…æ ¸ä¸­ç»´æŠ¤ç€ä¸€äº›æ•°æ®åŒ…è¿‡æ»¤è¡¨ï¼Œè¿™äº›è¡¨åŒ…å«äº†ç”¨äºæ§åˆ¶æ•°æ®åŒ…è¿‡æ»¤çš„è§„åˆ™
    + Linuxæä¾›äº†iptablesæ¥å¯¹è¿‡æ»¤è¡¨è¿›è¡Œæ’å…¥ã€ä¿®æ”¹å’Œåˆ é™¤ç­‰æ“ä½œ
    + Linux2.6.xå†…æ ¸ä¸­å†…ç½®äº†IPVSæ¨¡å—ï¼Œå·¥ä½œæ€§è´¨ç±»å‹äºNetfilteræ¨¡å—ï¼Œä¸è¿‡æ›´ä¸“æ³¨äºå®ç°IPè´Ÿè½½å‡è¡¡
    + `modprobe -l  | grep ipvs` ç®¡ç†å·¥å…·æ˜¯ipvsadm
      * `ipvsadm -A -t 111.11.11.11:80 -s rr`: æ·»åŠ ä¸€å°è™šæ‹ŸæœåŠ¡å™¨ï¼Œ-t åé¢æ˜¯æœåŠ¡å™¨çš„å¤–ç½‘ipå’Œç«¯å£ï¼Œ-s rræ˜¯æŒ‡é‡‡ç”¨ç®€å•è½®è¯¢çš„RRè°ƒåº¦ç­–ç•¥
      * `ipvsadm -a -t 111.11.11.11:80 -r 10.10.120.210:8000 -m`  -råé¢æ˜¯å®é™…æœåŠ¡å™¨çš„å†…ç½‘ipå’Œç«¯å£ï¼Œ-mè¡¨ç¤ºé‡‡ç”¨NATæ–¹å¼æ¥è½¬å‘æ•°æ®åŒ…
    + ä½œä¸ºè°ƒåº¦å™¨çš„NATæœåŠ¡å™¨å¯ä»¥å°†ååç‡æå‡åˆ°ä¸€ä¸ªæ–°çš„é«˜åº¦ï¼Œå‡ ä¹æ˜¯åå‘ä»£ç†æœåŠ¡å™¨çš„ä¸¤å€ä»¥ä¸Šï¼Œè¿™å¤§å¤šå½’åŠŸäºåœ¨å†…æ ¸ä¸­è¿›è¡Œè¯·æ±‚è½¬å‘çš„è¾ƒä½å¼€é”€ã€‚
    + ä¼˜ç‚¹ï¼š
      * æ”¯æŒ Windows æ“ä½œç³»ç»Ÿï¼›
      * æ”¯æŒç«¯å£æ˜ å°„ï¼Œå¦‚ RS æœåŠ¡å™¨ PORT ä¸ VPORT ä¸ä¸€è‡´çš„è¯ï¼ŒLVS ä¼šä¿®æ”¹ç›®çš„ IP åœ°å€å’Œ DPORT ä»¥æ”¯æŒç«¯å£æ˜ å°„ï¼›
    + ç¼ºç‚¹ï¼š
      * RS æœåŠ¡å™¨éœ€é…ç½®ç½‘å…³ï¼›
      * åŒå‘æµé‡å¯¹ LVS ä¼šäº§ç”Ÿè¾ƒå¤§çš„è´Ÿè½½å‹åŠ›
    + ç“¶é¢ˆ:NATæœåŠ¡å™¨çš„ç½‘ç»œå¸¦å®½ï¼ŒåŒ…æ‹¬å†…éƒ¨ç½‘ç»œå’Œå¤–éƒ¨ç½‘ç»œ- ç½‘ç»œåœ°å€è½¬æ¢(NAT)
  - ç›´æ¥è·¯ç”±ï¼šDirect Routing DR:éœ€è¦ LVS å’Œ RS é›†ç¾¤ç»‘å®šåŒä¸€ä¸ª VIPï¼ˆRS é€šè¿‡å°† VIP ç»‘å®šåœ¨ loopback å®ç°ï¼‰ï¼Œä½†ä¸ NAT çš„ä¸åŒç‚¹åœ¨äºï¼šè¯·æ±‚ç”± LVS æ¥å—ï¼Œç”±çœŸå®æä¾›æœåŠ¡çš„æœåŠ¡å™¨ï¼ˆRealServerï¼ŒRSï¼‰ç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œè¿”å›çš„æ—¶å€™ä¸ç»è¿‡ LVS
    + ä¸ TUN æ¨¡å¼çš„ç»“æ„ç±»ä¼¼ï¼Œä½†å„èŠ‚ç‚¹å¹¶ä¸æ˜¯åˆ†æ•£åœ¨å„ä¸ªåœ°æ–¹ï¼Œè€Œæ˜¯ä¸è°ƒåº¦å™¨ä½äºåŒä¸€ä¸ªç‰©ç†ç½‘ç»œï¼Œè´Ÿè½½è°ƒåº¦å™¨ä¸å„èŠ‚ç‚¹æœåŠ¡å™¨é€šè¿‡æœ¬åœ°ç½‘ç»œè¿æ¥ï¼Œä¸éœ€è¦å»ºç«‹ä¸“ç”¨çš„ IP éš§é“
    + å·¥ä½œåœ¨æ•°æ®é“¾è·¯å±‚ï¼ˆç¬¬äºŒå±‚ï¼‰,é€šè¿‡ä¿®æ”¹æ•°æ®åŒ…çš„ç›®æ ‡MACåœ°å€ï¼ˆæ²¡æœ‰ä¿®æ”¹ç›®æ ‡IPï¼‰ï¼Œå°†æ•°æ®åŒ…è½¬å‘åˆ°å®é™…æœåŠ¡å™¨ä¸Š
    + åŸç†
      * å½“å®¢æˆ·ç«¯ç”¨æˆ·å‘é€è¯·æ±‚ç»™ www.baidu.com ç½‘ç«™æ—¶ï¼Œé¦–å…ˆç»è¿‡ DNS è§£æåˆ° IP åå¹¶å‘ç™¾åº¦æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œæ•°æ®åŒ…ç»è¿‡ç½‘ç»œåˆ°ç™¾åº¦ LVS è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼Œè¿™æ—¶åˆ°è¾¾ LVS ç½‘å¡æ—¶çš„æ•°æ®åŒ…åŒ…æ‹¬ï¼šæº IP åœ°å€ï¼ˆå®¢æˆ·ç«¯åœ°å€ï¼‰ã€ç›®çš„ IP åœ°å€ï¼ˆç™¾åº¦å¯¹å¤–æœåŠ¡å™¨ IP åœ°å€ï¼Œä¹Ÿå°±æ˜¯ VIPï¼‰ã€æº MAC åœ°å€ï¼ˆCMAC / LVS è¿æ¥è·¯ç”±å™¨çš„ MAC åœ°å€ï¼‰ã€ç›®æ ‡ MAC åœ°å€ï¼ˆVMAC / VIP å¯¹åº”çš„ MAC åœ°å€ï¼‰ã€‚
      * æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡åï¼Œç»è¿‡é“¾è·¯å±‚åˆ°è¾¾ PREROUTING é“¾ï¼Œè¿›è¡ŒæŸ¥æ‰¾è·¯ç”±ï¼Œå‘ç°ç›®çš„ IP æ˜¯ LVS çš„ VIPï¼Œè¿™æ—¶å°±ä¼šå‘é€è‡³ INPUT é“¾ä¸­å¹¶ä¸”æ•°æ®åŒ…çš„ IP åœ°å€ã€MAC åœ°å€ã€Port éƒ½æœªç»è¿‡ä¿®æ”¹ã€‚
      * æ•°æ®åŒ…åˆ°è¾¾ INPUT é“¾ä¸­ï¼ŒLVS ä¼šæ ¹æ®ç›®çš„ IP å’Œ Portï¼ˆç«¯å£ï¼‰ç¡®è®¤æ˜¯å¦ä¸º LVS å®šä¹‰çš„æœåŠ¡ï¼Œå¦‚æ˜¯å®šä¹‰è¿‡çš„ VIP æœåŠ¡ï¼Œä¼šæ ¹æ®é…ç½®çš„æœåŠ¡ä¿¡æ¯ï¼Œä» RealServer ä¸­é€‰æ‹©ä¸€ä¸ªåç«¯æœåŠ¡å™¨ RS1ï¼Œç„¶å RS1 ä½œä¸ºç›®æ ‡å‡ºæ–¹å‘çš„è·¯ç”±ï¼Œç¡®å®šä¸‹ä¸€è·³ä¿¡æ¯åŠæ•°æ®åŒ…é€šè¿‡å…·ä½“çš„å“ªä¸ªç½‘å¡å‘å‡ºï¼Œæœ€å¥½å°†æ•°æ®åŒ…é€šè¿‡       * æ•°æ®åŒ…é€šè¿‡ POSTROUTING é“¾åï¼Œç›®çš„ MAC åœ°å€å°†ä¼šä¿®æ”¹ä¸º RealServer æœåŠ¡å™¨ MAC åœ°å€ï¼ˆRMACï¼‰æº MAC åœ°å€ä¿®æ”¹ä¸º LVS ä¸ RS åŒç½‘æ®µçš„ IP åœ°å€çš„ MAC åœ°å€ï¼ˆDMACï¼‰æ­¤æ—¶ï¼Œæ•°æ®åŒ…å°†ä¼šå‘è‡³ RealServer æœåŠ¡å™¨ã€‚
      * æ•°æ®åŒ…åˆ°è¾¾ RealServer æœåŠ¡å™¨åï¼Œå‘ç°è¯·æ±‚æŠ¥æ–‡çš„ MAC åœ°å€æ˜¯è‡ªå·±çš„ç½‘å¡ MAC åœ°å€ï¼Œå°†ä¼šæ¥å—æ­¤æŠ¥æ–‡ï¼Œå¾…å¤„ç†å®Œæˆä¹‹åï¼Œå°†å“åº”æŠ¥æ–‡é€šè¿‡ lo æ¥å£ä¼ é€ç»™ eth0 ç½‘å¡ç„¶åå‘å¤–å‘å‡ºã€‚æ­¤æ—¶çš„æº IP åœ°å€ä¸º VIPï¼Œç›®æ ‡ IP ä¸º CIPï¼Œæº MAC åœ°å€ä¸º RS1 çš„ RMACï¼Œç›®çš„ MAC åœ°å€ä¸ºä¸‹ä¸€è·³è·¯ç”±å™¨çš„ MAC åœ°å€ï¼ˆCMACï¼‰ï¼Œæœ€ç»ˆæ•°æ®åŒ…é€šè¿‡ RS ç›¸è¿çš„è·¯ç”±å™¨è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚
    + ä¸€ä¸ªè¯·æ±‚è¿‡æ¥æ—¶ï¼ŒLVS åªéœ€è¦å°†ç½‘ç»œå¸§çš„ MAC åœ°å€ä¿®æ”¹ä¸ºæŸä¸€å° RS çš„ MACï¼Œè¯¥åŒ…å°±ä¼šè¢«è½¬å‘åˆ°ç›¸åº”çš„ RS å¤„ç†ï¼Œæ³¨æ„æ­¤æ—¶çš„æº IP å’Œç›®æ ‡ IP éƒ½æ²¡å˜ï¼ŒLVS åªæ˜¯åšäº†ä¸€ä¸‹ç§»èŠ±æ¥æœ¨ã€‚RS æ”¶åˆ° LVS è½¬å‘æ¥çš„åŒ…æ—¶ï¼Œé“¾è·¯å±‚å‘ç° MAC æ˜¯è‡ªå·±çš„ï¼Œåˆ°ä¸Šé¢çš„ç½‘ç»œå±‚ï¼Œå‘ç° IP ä¹Ÿæ˜¯è‡ªå·±çš„ï¼Œäºæ˜¯è¿™ä¸ªåŒ…è¢«åˆæ³•åœ°æ¥å—ï¼ŒRS æ„ŸçŸ¥ä¸åˆ°å‰é¢æœ‰ LVS çš„å­˜åœ¨
    + å½“ RS è¿”å›å“åº”æ—¶ï¼Œåªè¦ç›´æ¥å‘æº IPï¼ˆå³ç”¨æˆ·çš„ IPï¼‰è¿”å›å³å¯ï¼Œä¸å†ç»è¿‡ LVS
    + æ•°æ®åˆ†å‘è¿‡ç¨‹ä¸­ä¸ä¿®æ”¹ IP åœ°å€ï¼Œåªä¿®æ”¹ mac åœ°å€.ç”±äºå®é™…å¤„ç†è¯·æ±‚çš„çœŸå®ç‰©ç† IP åœ°å€å’Œæ•°æ®è¯·æ±‚ç›®çš„ IP åœ°å€ä¸€è‡´ï¼Œæ‰€ä»¥ä¸éœ€è¦é€šè¿‡è´Ÿè½½å‡è¡¡æœåŠ¡å™¨è¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¯å°†å“åº”æ•°æ®åŒ…ç›´æ¥è¿”å›ç»™ç”¨æˆ·æµè§ˆå™¨ï¼Œé¿å…è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ç½‘å¡å¸¦å®½æˆä¸ºç“¶é¢ˆã€‚å› æ­¤ï¼ŒDR æ¨¡å¼å…·æœ‰è¾ƒå¥½çš„æ€§èƒ½ï¼Œä¹Ÿæ˜¯ç›®å‰å¤§å‹ç½‘ç«™ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ç§è´Ÿè½½å‡è¡¡æ‰‹æ®µã€‚
    + ç›¸è¾ƒäºLVS-NATçš„æœ€å¤§ä¼˜åŠ¿åœ¨äºLVS-DRä¸å—è°ƒåº¦å™¨å®½å¸¦çš„é™åˆ¶
    + ä¼˜ç‚¹ï¼š
    * å“åº”æ•°æ®ä¸ç»è¿‡ LVSï¼Œæ€§èƒ½é«˜ï¼›
    * å¯¹æ•°æ®åŒ…ä¿®æ”¹å°ï¼Œä¿¡æ¯å®Œæ•´æ€§å¥½ï¼›
    + ç¼ºç‚¹ï¼š
    * LVS ä¸ RS å¿…é¡»åœ¨åŒä¸€ä¸ªç‰©ç†ç½‘ç»œï¼›
    * RS ä¸Šå¿…é¡»é…ç½® lo å’Œå…¶ä»–å†…æ ¸å‚æ•°ï¼›
    * ä¸æ”¯æŒç«¯å£æ˜ å°„
  - LVS-TUNï½œåŸºäºIPéš§é“çš„è¯·æ±‚è½¬å‘æœºåˆ¶ï¼šå°†è°ƒåº¦å™¨æ”¶åˆ°çš„IPæ•°æ®åŒ…å°è£…åœ¨ä¸€ä¸ªæ–°IPæ•°æ®åŒ…ä¸­ï¼Œè½¬äº¤ç»™å®é™…æœåŠ¡å™¨ï¼Œç„¶åå®é™…æœåŠ¡å™¨çš„å“åº”æ•°æ®åŒ…å¯ä»¥ç›´æ¥åˆ°è¾¾ç”¨æˆ·ç«¯
    + ä¸LVS-DRä¸åŒçš„æ˜¯ï¼Œå®é™…æœåŠ¡å™¨å¯ä»¥å’Œè°ƒåº¦å™¨ä¸åœ¨åŒä¸€ä¸ªWANç½‘æ®µï¼Œè°ƒåº¦å™¨é€šè¿‡IPéš§é“æŠ€æœ¯æ¥è½¬å‘è¯·æ±‚åˆ°å®é™…æœåŠ¡å™¨ï¼Œæ‰€ä»¥å®é™…æœåŠ¡å™¨ä¹Ÿå¿…é¡»æ‹¥æœ‰åˆæ³•IPåœ°å€
    + åŸç†
      * å®¢æˆ·ç«¯å‘é€æ•°æ®åŒ…ç»è¿‡ç½‘ç»œååˆ° LVS ç½‘å¡ï¼Œæ•°æ®åŒ…æº IP ä¸º CIPï¼Œç›®çš„ IP ä¸º VIPã€‚
      * è¿›å…¥ PREROUTING é“¾åï¼Œä¼šæ ¹æ®ç›®çš„ IP å»æŸ¥æ‰¾è·¯ç”±ï¼Œç¡®å®šæ˜¯å¦ä¸ºæœ¬æœº IPï¼Œæ•°æ®åŒ…å°†è½¬å‘è‡³ INPUT é“¾ä¸­ï¼Œåˆ° LVSï¼Œæº IP å’Œ ç›®çš„ IP ä¸å˜ã€‚
      * åˆ° LVS åï¼Œé€šè¿‡ç›®çš„ IP å’Œç›®çš„ PORT æŸ¥æ‰¾æ˜¯å¦ä¸º IPVS æœåŠ¡ï¼Œå¦‚æ˜¯ IPVS æœåŠ¡ï¼Œå°†ä¼šé€‰æ‹©ä¸€ä¸ª RS åç«¯æœåŠ¡å™¨ï¼Œ æº IP ä¸º DIPï¼Œç›®æ ‡ IP ä¸º RIPï¼Œæ•°æ®åŒ…å°†ä¼šè½¬å‘è‡³ OUTPUT é“¾ä¸­ã€‚
      * æ•°æ®åŒ…æ ¹æ®è·¯ç”±ä¿¡æ¯åˆ°è¾¾ LVS ç½‘å¡ï¼Œå‘é€è‡³è·¯ç”±å™¨ç½‘å…³ï¼Œæœ€ç»ˆåˆ°è¾¾åç«¯æœåŠ¡å™¨ã€‚
      * åç«¯æœåŠ¡å™¨æ”¶åˆ°æ•°æ®åŒ…åï¼Œä¼šæ‹†æ‰æœ€å¤–å±‚çš„ IP åœ°å€åï¼Œä¼šå‘ç°è¿˜æœ‰ä¸€å±‚ IP é¦–éƒ¨ï¼Œæº IP ä¸º CIPï¼Œç›®çš„ IP ä¸º VIPï¼ŒTUNL0 ä¸Šé…ç½® VIPï¼ŒæŸ¥æ‰¾è·¯ç”±ååˆ¤æ–­ä¸ºæœ¬æœº IP åœ°å€ï¼Œå°†ä¼šå‘ç»™ç”¨æˆ·ç©ºé—´å±‚çš„åº”ç”¨ç¨‹åºå“åº”å VIP ä¸ºæº IPï¼ŒCIP ä¸ºç›®çš„ IP æ•°æ®åŒ…å‘é€è‡³ç½‘å¡ï¼Œæœ€ç»ˆè¿”å›è‡³å®¢æˆ·ç«¯ç”¨æˆ·ã€‚
    + ä¼˜ç‚¹ï¼š
      * å•è‡‚æ¨¡å¼ï¼ŒLVS è´Ÿè½½å‹åŠ›å°ï¼›
      * æ•°æ®åŒ…ä¿®æ”¹å°ï¼Œä¿¡æ¯å®Œæ•´æ€§é«˜ï¼›
      * å¯è·¨æœºæˆ¿ï¼›
    + ç¼ºç‚¹ï¼š
      * ä¸æ”¯æŒç«¯å£æ˜ å°„ï¼›
      * éœ€åœ¨ RS åç«¯æœåŠ¡å™¨å®‰è£…æ¨¡å—åŠé…ç½® VIPï¼›
      * éš§é“å¤´éƒ¨ IP åœ°å€å›ºå®šï¼ŒRS åç«¯æœåŠ¡å™¨ç½‘å¡å¯èƒ½ä¼šä¸å‡åŒ€ï¼›
      * éš§é“å¤´éƒ¨çš„åŠ å…¥å¯èƒ½ä¼šå¯¼è‡´åˆ†ç‰‡ï¼Œæœ€ç»ˆä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½ï¼›
    + å¦‚å¯¹è½¬å‘æ€§è¦æ±‚è¾ƒé«˜ä¸”å…·æœ‰è·¨æœºæˆ¿éœ€æ±‚çš„ï¼Œå¯é€‰æ‹© TUN æ¨¡å¼
  - LVS-DRå’ŒLVS-TUNéƒ½é€‚åˆå“åº”å’Œè¯·æ±‚ä¸å¯¹ç§°çš„WebæœåŠ¡å™¨ï¼Œå¦‚ä½•ä»å®ƒä»¬ä¸­åšå‡ºé€‰æ‹©ï¼Œå–å†³äºä½ çš„ç½‘ç»œéƒ¨ç½²éœ€è¦ï¼Œå› ä¸ºLVS-TUNå¯ä»¥å°†å®é™…æœåŠ¡å™¨æ ¹æ®éœ€è¦éƒ¨ç½²åœ¨ä¸åŒçš„åœ°åŸŸï¼Œå¹¶ä¸”æ ¹æ®å°±è¿‘è®¿é—®çš„åŸåˆ™æ¥è½¬ç§»è¯·æ±‚ï¼Œæ‰€ä»¥æœ‰ç±»ä¼¼è¿™ç§éœ€æ±‚çš„ï¼Œå°±åº”è¯¥é€‰æ‹©LVS-TUN
* ä¼˜ç‚¹
  - æŠ—è´Ÿè½½èƒ½åŠ›å¼ºã€æ˜¯å·¥ä½œåœ¨ä¼ è¾“å±‚ä¸Šä»…ä½œåˆ†å‘ä¹‹ç”¨ï¼Œæ²¡æœ‰æµé‡çš„äº§ç”Ÿï¼Œè¿™ä¸ªç‰¹ç‚¹ä¹Ÿå†³å®šäº†å®ƒåœ¨è´Ÿè½½å‡è¡¡è½¯ä»¶é‡Œçš„æ€§èƒ½æœ€å¼ºçš„ï¼Œå¯¹å†…å­˜å’Œ cpu èµ„æºæ¶ˆè€—æ¯”è¾ƒä½
  - é…ç½®æ€§æ¯”è¾ƒä½ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼ºç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªä¼˜ç‚¹ï¼Œå› ä¸ºæ²¡æœ‰å¯å¤ªå¤šé…ç½®çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦å¤ªå¤šæ¥è§¦ï¼Œå¤§å¤§å‡å°‘äº†äººä¸ºå‡ºé”™çš„å‡ ç‡
  - å·¥ä½œç¨³å®šï¼Œå› ä¸ºå…¶æœ¬èº«æŠ—è´Ÿè½½èƒ½åŠ›å¾ˆå¼ºï¼Œè‡ªèº«æœ‰å®Œæ•´çš„åŒæœºçƒ­å¤‡æ–¹æ¡ˆï¼Œå¦‚ LVS + Keepalived
  - æ— æµé‡ï¼ŒLVS åªåˆ†å‘è¯·æ±‚ï¼Œè€Œæµé‡å¹¶ä¸ä»å®ƒæœ¬èº«å‡ºå»ï¼Œè¿™ç‚¹ä¿è¯äº†å‡è¡¡å™¨ IO çš„æ€§èƒ½ä¸ä¼šå—åˆ°å¤§æµé‡çš„å½±å“
  - åº”ç”¨èŒƒå›´æ¯”è¾ƒå¹¿ï¼Œå› ä¸º LVS å·¥ä½œåœ¨ä¼ è¾“å±‚ï¼Œå‡ ä¹å¯ä»¥å¯¹æ‰€æœ‰åº”ç”¨åšè´Ÿè½½å‡è¡¡ï¼ŒåŒ…æ‹¬ httpã€æ•°æ®åº“ã€åœ¨çº¿èŠå¤©å®¤ç­‰ç­‰
* ç¼ºç‚¹
  - LVSæ€§èƒ½ä¾èµ–Linuxå†…æ ¸çš„ç½‘ç»œæ€§èƒ½ï¼Œä½†Linuxå†…æ ¸çš„ç½‘ç»œè·¯å¾„è¿‡é•¿å¯¼è‡´äº†å¤§é‡å¼€é”€ï¼Œä½¿å¾—LVSå•æœºæ€§èƒ½è¾ƒä½
  - è½¯ä»¶æœ¬èº«ä¸æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼å¤„ç†ï¼Œä¸èƒ½åšåŠ¨é™åˆ†ç¦»ï¼›è€Œç°åœ¨è®¸å¤šç½‘ç«™åœ¨è¿™æ–¹é¢éƒ½æœ‰è¾ƒå¼ºçš„éœ€æ±‚ï¼Œè¿™ä¸ªæ˜¯ Nginxã€HAProxy + Keepalived çš„ä¼˜åŠ¿æ‰€åœ¨
  - å¦‚æœæ˜¯ç½‘ç«™åº”ç”¨æ¯”è¾ƒåºå¤§çš„è¯ï¼ŒLVS/DR + Keepalived å®æ–½èµ·æ¥å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œç›¸å¯¹è€Œè¨€ï¼ŒNginx / HAProxy + Keepalived å°±ç®€å•å¤šäº†
* LVS vs Nginx
  - LVS æ¯” Nginx å…·æœ‰æ›´å¼ºçš„æŠ—è´Ÿè½½èƒ½åŠ›ï¼Œæ€§èƒ½é«˜ï¼Œå¯¹å†…å­˜å’Œ CPU èµ„æºæ¶ˆè€—è¾ƒä½
  - LVS å·¥ä½œåœ¨ç½‘ç»œå±‚ï¼Œå…·ä½“æµé‡ç”±æ“ä½œç³»ç»Ÿå†…æ ¸è¿›è¡Œå¤„ç†ï¼ŒNginx å·¥ä½œåœ¨åº”ç”¨å±‚ï¼Œå¯é’ˆå¯¹ HTTP åº”ç”¨å®æ–½ä¸€äº›åˆ†æµç­–ç•¥
  - LVS å®‰è£…é…ç½®è¾ƒå¤æ‚ï¼Œç½‘ç»œä¾èµ–æ€§å¤§ï¼Œç¨³å®šæ€§é«˜ã€‚Nginx å®‰è£…é…ç½®è¾ƒç®€å•ï¼Œç½‘ç»œä¾èµ–æ€§å°
  - LVS ä¸æ”¯æŒæ­£åˆ™åŒ¹é…å¤„ç†ï¼Œæ— æ³•å®ç°åŠ¨é™åˆ†ç¦»æ•ˆæœ
  - LVS é€‚ç”¨çš„åè®®èŒƒå›´å¹¿ã€‚Nginx ä»…æ”¯æŒ HTTPã€HTTPSã€Email åè®®ï¼Œé€‚ç”¨èŒƒå›´å°

## [keepalived](https://wsgzao.github.io/post/keepalived/)

* è¿è¡Œåœ¨ lvs ä¹‹ä¸Šï¼Œæ˜¯ä¸€ä¸ªç”¨äºåšåŒæœºçƒ­å¤‡ï¼ˆHAï¼‰çš„è½¯ä»¶ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å®ç°çœŸå®æœºçš„æ•…éšœéš”ç¦»åŠè´Ÿè½½å‡è¡¡å™¨é—´çš„å¤±è´¥åˆ‡æ¢ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§
  - keepalived æ˜¯ lvs çš„æ‰©å±•é¡¹ç›®, å› æ­¤å®ƒä»¬ä¹‹é—´å…·å¤‡è‰¯å¥½çš„å…¼å®¹æ€§
  - å¯¹ RealServer çš„å¥åº·æ£€æŸ¥, å®ç°å¯¹å¤±æ•ˆæœºå™¨ / æœåŠ¡çš„æ•…éšœéš”ç¦»
* åŸç†ï¼škeepalived é€šè¿‡é€‰ä¸¾ï¼ˆçœ‹æœåŠ¡å™¨è®¾ç½®çš„æƒé‡ï¼‰æŒ‘é€‰å‡ºä¸€å°çƒ­å¤‡æœåŠ¡å™¨åš MASTER æœºå™¨ï¼ŒMASTER æœºå™¨ä¼šè¢«åˆ†é…åˆ°ä¸€ä¸ªæŒ‡å®šçš„è™šæ‹Ÿ ipï¼Œå¤–éƒ¨ç¨‹åºå¯é€šè¿‡è¯¥ ip è®¿é—®è¿™å°æœåŠ¡å™¨ï¼Œå¦‚æœè¿™å°æœåŠ¡å™¨å‡ºç°æ•…éšœï¼ˆæ–­ç½‘ï¼Œé‡å¯ï¼Œæˆ–è€…æœ¬æœºå™¨ä¸Šçš„ keepalived crash ç­‰ï¼‰ï¼Œkeepalived ä¼šä»å…¶ä»–çš„å¤‡ä»½æœºå™¨ä¸Šé‡é€‰ï¼ˆè¿˜æ˜¯çœ‹æœåŠ¡å™¨è®¾ç½®çš„æƒé‡ï¼‰ä¸€å°æœºå™¨åš MASTER å¹¶åˆ†é…åŒæ ·çš„è™šæ‹Ÿ IPï¼Œå……å½“å‰ä¸€å° MASTER çš„è§’è‰²
* é€‰ä¸¾ç­–ç•¥ï¼šæ ¹æ® VRRP åè®®ï¼Œå®Œå…¨æŒ‰ç…§æƒé‡å¤§å°ï¼Œæƒé‡æœ€å¤§ï¼ˆ0ï½255ï¼‰çš„æ˜¯ MASTER æœºå™¨ï¼Œä¸‹é¢å‡ ç§æƒ…å†µä¼šè§¦å‘é€‰ä¸¾
  - keepalived å¯åŠ¨çš„æ—¶å€™
  - master æœåŠ¡å™¨å‡ºç°æ•…éšœï¼ˆæ–­ç½‘ï¼Œé‡å¯ï¼Œæˆ–è€…æœ¬æœºå™¨ä¸Šçš„ keepalived crash ç­‰ï¼Œè€Œæœ¬æœºå™¨ä¸Šå…¶ä»–åº”ç”¨ç¨‹åº crash ä¸ç®—ï¼‰
  - æœ‰æ–°çš„å¤‡ä»½æœåŠ¡å™¨åŠ å…¥ä¸”æƒé‡æœ€å¤§
* é…ç½®
  - VRRPD é…ç½®åŒ…æ‹¬ä¸‰ä¸ªç±»:
    + VRRP åŒæ­¥ç»„(synchroization group)
    + VRRP å®ä¾‹(VRRP Instance)
    + VRRP è„šæœ¬

```sh
# å…¨å±€å®šä¹‰ (global definition)
global_defs {
   notification_email {
   acassen@firewall.loc
   failover@firewall.loc
   sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL
}
#notification_email: è¡¨ç¤º keepalived åœ¨å‘ç”Ÿè¯¸å¦‚åˆ‡æ¢æ“ä½œæ—¶éœ€è¦å‘é€ email é€šçŸ¥ä»¥åŠ email å‘é€ç»™å“ªäº›é‚®ä»¶åœ°å€é‚®ä»¶åœ°å€å¯ä»¥å¤šä¸ªæ¯è¡Œä¸€ä¸ª
#notification_email_from admin@example.com: è¡¨ç¤ºå‘é€é€šçŸ¥é‚®ä»¶æ—¶é‚®ä»¶æºåœ°å€æ˜¯è°
#smtp_server 127.0.0.1: è¡¨ç¤ºå‘é€ email æ—¶ä½¿ç”¨çš„ smtp æœåŠ¡å™¨åœ°å€è¿™é‡Œå¯ä»¥ç”¨æœ¬åœ°çš„ sendmail æ¥å®ç°
#smtp_connect_timeout 30: è¿æ¥ smtp è¿æ¥è¶…æ—¶æ—¶é—´
#router_id node1: æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸é…ç½®ä¸»æœºå

# é™æ€åœ°å€å’Œè·¯ç”±é…ç½®èŒƒä¾‹
static_ipaddress {
    192.168.1.1/24 brd + dev eth0 scope global
    192.168.1.2/24 brd + dev eth1 scope global
}
static_routes {
    src $SRC_IP to $DST_IP dev $SRC_DEVICE
    src $SRC_IP to $DST_IP via $GW dev $SRC_DEVICE
}
# è¿™é‡Œå®é™…ä¸Šå’Œç³»ç»Ÿé‡Œé¢å‘½ä»¤é…ç½® IP åœ°å€å’Œè·¯ç”±ä¸€æ ·ä¾‹å¦‚
# 192.168.1.1/24 brd + dev eth0 scope global ç›¸å½“äº: ip addr add 192.168.1.1/24 brd + dev eth0 scope global
# å°±æ˜¯ç»™ eth0 é…ç½® IP åœ°å€è·¯ç”±åŒç†, ä¸€èˆ¬è¿™ä¸ªåŒºåŸŸä¸éœ€è¦é…ç½®
# è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ç»™æœåŠ¡å™¨é…ç½®çœŸå®çš„ IP åœ°å€å’Œè·¯ç”±çš„åœ¨å¤æ‚çš„ç¯å¢ƒä¸‹å¯èƒ½éœ€è¦é…ç½®ä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªæ¥é…ç½®æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ vi /etc/sysconfig/network-script/ifcfg-eth1 æ¥é…ç½®åˆ‡è®°è¿™é‡Œå¯ä¸æ˜¯ VIP ä¸è¦ææ··æ·†äº†åˆ‡è®°åˆ‡è®°
```

### ç®—æ³•

* è¡¡é‡æ ‡å‡†
  - æ˜¯å¦æ„è¯†åˆ°ä¸åŒèŠ‚ç‚¹çš„æœåŠ¡èƒ½åŠ›æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚CPUã€å†…å­˜ã€ç½‘ç»œã€åœ°ç†ä½ç½®
  - æ˜¯å¦æ„è¯†åˆ°èŠ‚ç‚¹çš„æœåŠ¡èƒ½åŠ›æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œé«˜é…çš„æœºå™¨ä¹Ÿæœ‰å¯èƒ½ç”±äºä¸€äº›çªå‘åŸå› å¯¼è‡´å¤„ç†é€Ÿåº¦å˜å¾—å¾ˆæ…¢
  - æ˜¯å¦è€ƒè™‘å°†åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæˆ–è€…è¯´åŒæ ·çš„è¯·æ±‚åˆ†å‘åˆ°åŒä¸€ä¸ªå¤„ç†èŠ‚ç‚¹ï¼Œè¿™å¯¹äºâ€œæœ‰çŠ¶æ€â€çš„æœåŠ¡éå¸¸é‡è¦ï¼Œæ¯”å¦‚sessionï¼Œæ¯”å¦‚åˆ†å¸ƒå¼å­˜å‚¨
  - è°æ¥è´Ÿè´£è´Ÿè½½å‡è¡¡ï¼Œå³è°å……å½“è´Ÿè½½å‡è¡¡å™¨ï¼ˆload balancerï¼‰ï¼Œbalanceræœ¬èº«æ˜¯å¦ä¼šæˆä¸ºç“¶é¢ˆ
* æ–¹æ¡ˆ
  - è½®è¯¢ç®—æ³•ï¼ˆround-robinï¼‰ï¼šæä¾›åŒè´¨æœåŠ¡çš„èŠ‚ç‚¹é€ä¸ªå¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™æ ·èƒ½åšåˆ°ç»å¯¹çš„å‡è¡¡.
    - æ²¡æœ‰è€ƒè™‘åˆ°èŠ‚ç‚¹çš„å·®å¼‚
  - åŠ æƒè½®è¯¢ç®—æ³•ï¼ˆweight round-robinï¼‰:åœ¨è½®è®­ç®—æ³•çš„åŸºç¡€ä¸Šï¼Œè€ƒè™‘åˆ°æœºå™¨çš„å·®å¼‚æ€§ï¼Œåˆ†é…ç»™æœºå™¨ä¸åŒçš„æƒé‡.ä¾èµ–äºè¯·æ±‚çš„ç±»å‹ï¼Œæ¯”å¦‚è®¡ç®—å¯†é›†å‹ï¼Œé‚£å°±è€ƒè™‘CPUã€å†…å­˜ï¼›å¦‚æœæ˜¯IOå¯†é›†å‹ï¼Œé‚£å°±è€ƒè™‘ç£ç›˜æ€§èƒ½
  - éšæœºç®—æ³•ï¼ˆrandomï¼‰:éšæœºé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æœåŠ¡ï¼ŒæŒ‰ç…§æ¦‚ç‡ï¼Œåªè¦è¯·æ±‚æ•°é‡è¶³å¤Ÿå¤šï¼Œé‚£ä¹ˆä¹Ÿèƒ½è¾¾åˆ°ç»å¯¹å‡è¡¡çš„æ•ˆæœ
  - åŠ æƒéšæœºç®—æ³•ï¼ˆrandomï¼‰:åœ¨éšæœºçš„æ—¶å€™å¼•å…¥ä¸åŒèŠ‚ç‚¹çš„æƒé‡
  - å“ˆå¸Œæ³•ï¼ˆhashï¼‰ï¼šæ ¹æ®å®¢æˆ·ç«¯çš„IPï¼Œæˆ–è€…è¯·æ±‚çš„â€œKeyâ€ï¼Œè®¡ç®—å‡ºä¸€ä¸ªhashå€¼ï¼Œç„¶åå¯¹èŠ‚ç‚¹æ•°ç›®å–æ¨¡ã€‚å¥½å¤„å°±æ˜¯ï¼ŒåŒä¸€ä¸ªè¯·æ±‚èƒ½å¤Ÿåˆ†é…åˆ°åŒæ ·çš„æœåŠ¡èŠ‚ç‚¹ï¼Œè¿™å¯¹äºâ€œæœ‰çŠ¶æ€â€çš„æœåŠ¡å¾ˆæœ‰å¿…è¦
    + å½“èŠ‚ç‚¹çš„æ•°ç›®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè¯·æ±‚ä¼šå¤§æ¦‚ç‡åˆ†é…åˆ°å…¶ä»–çš„èŠ‚ç‚¹ï¼Œå¼•å‘åˆ°ä¸€ç³»åˆ—é—®é¢˜
  - ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼šä¸€ä¸ªç‰©ç†èŠ‚ç‚¹ä¸å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹æ˜ å°„ï¼Œåœ¨hashçš„æ—¶å€™ï¼Œä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹æ•°ç›®è€Œä¸æ˜¯ç‰©ç†èŠ‚ç‚¹æ•°ç›®ã€‚å½“ç‰©ç†èŠ‚ç‚¹å˜åŒ–çš„æ—¶å€™ï¼Œè™šæ‹ŸèŠ‚ç‚¹çš„æ•°ç›®æ— éœ€å˜åŒ–ï¼Œåªæ¶‰åŠåˆ°è™šæ‹ŸèŠ‚ç‚¹çš„é‡æ–°åˆ†é…ã€‚è€Œä¸”ï¼Œè°ƒæ•´æ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹æ•°ç›®ï¼Œä¹Ÿå°±ç›¸å½“äºæ¯ä¸ªç‰©ç†èŠ‚ç‚¹æœ‰ä¸åŒçš„æƒé‡
  - æœ€å°‘è¿æ¥ç®—æ³•ï¼ˆleast connectionï¼‰ï¼šæ ¹æ®èŠ‚ç‚¹çš„çœŸå®è´Ÿè½½ï¼ŒåŠ¨æ€åœ°è°ƒæ•´èŠ‚ç‚¹çš„æƒé‡å°±éå¸¸é‡è¦ã€‚å½“ç„¶ï¼Œè¦è·å¾—æ¥èŠ‚ç‚¹çš„çœŸå®è´Ÿè½½ä¹Ÿä¸æ˜¯ä¸€æ¦‚è€Œè®ºçš„äº‹æƒ…ï¼Œå¦‚ä½•å®šä¹‰è´Ÿè½½ï¼Œè´Ÿè½½çš„æ”¶é›†æ˜¯å¦åŠæ—¶
    + æ¯ä¸ªèŠ‚ç‚¹å½“å‰çš„è¿æ¥æ•°ç›®æ˜¯ä¸€ä¸ªéå¸¸å®¹æ˜“æ”¶é›†çš„æŒ‡æ ‡ï¼Œå› æ­¤lease connectionæ˜¯æœ€å¸¸è¢«äººæåˆ°çš„ç®—æ³•
  - å“åº”ç­–ç•¥ï¼šå°†è¯·æ±‚è½¬å‘ç»™å½“å‰æ—¶åˆ»å“åº”æœ€å¿«çš„åç«¯æœåŠ¡å™¨
    + ä¸åœçš„å»ç»Ÿè®¡æ¯ä¸€å°åç«¯æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å¤„ç†é€Ÿåº¦äº†

```python
SERVER_LIST = [
      '10.246.10.1',
     '10.246.10.2',
     '10.246.10.3',
 ]
 def round_robin(server_lst, cur = [0]):
     length = len(server_lst)
     ret = server_lst[cur[0] % length]
     cur[0] = (cur[0] + 1) % length
     return ret

 WEIGHT_SERVER_LIST = {
     '10.246.10.1': 1,
     '10.246.10.2': 3,
     '10.246.10.3': 2,
 }
 def weight_round_robin(servers, cur = [0]):
     weighted_list = []
     for k, v in servers.iteritems():
         weighted_list.extend([k] * v)

     length = len(weighted_list)
     ret = weighted_list[cur[0] % length]
     cur[0] = (cur[0] + 1) % length
     return ret

def random_choose(server_lst):
    import random
    random.seed()
    return random.choice(server_lst)

def weight_random_choose(servers):
    import random
    random.seed()
    weighted_list = []
    for k, v in servers.iteritems():
        weighted_list.extend([k] * v)
    return random.choice(weighted_list)

# å¦‚æœèŠ‚ç‚¹åˆ—è¡¨ä»¥åŠæƒé‡å˜åŒ–ä¸å¤§ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥å¯¹æ‰€æœ‰èŠ‚ç‚¹å½’ä¸€åŒ–ï¼Œç„¶åæŒ‰æ¦‚ç‡åŒºé—´é€‰æ‹©
def normalize_servers(servers):
    normalized_servers = {}
    total = sum(servers.values())
    cur_sum = 0
    for k, v in servers.iteritems():
        normalized_servers[k] = 1.0 * (cur_sum + v) / total
        cur_sum += v
    return normalized_servers

def weight_random_choose_ex(normalized_servers):
    import random, operator
    random.seed()
    rand = random.random()
    for k, v in sorted(normalized_servers.iteritems(), key = operator.itemgetter(1)):
        if v >= rand:
            return k
    else:
        assert False, 'Error normalized_servers with rand %s ' % rand

def hash_choose(request_info, server_lst):
     hashed_request_info = hash(request_info)
     return server_lst[hashed_request_info % len(server_lst)]
```

## å¥å£®ç³»ç»Ÿ

## èµ„æº

* [Hprose](https://hprose.com):é«˜æ€§èƒ½è¿œç¨‹å¯¹è±¡æœåŠ¡å¼•æ“
* [Kickball/awesome-selfhosted](https://github.com/Kickball/awesome-selfhosted):This is a list of Free Software network services and web applications which can be hosted locally. Selfhosting is the process of locally hosting and managing applications instead of renting from SaaS providers. <https://reddit.com/r/selfhosted>
* [arialdomartini/Back-End-Developer-Interview-Questions](https://github.com/arialdomartini/Back-End-Developer-Interview-Questions):A list of back-end related questions you can be inspired from to interview potential candidates, test yourself or completely ignore
* [wx-chevalier/Backend-Series](https://github.com/wx-chevalier/Backend-Series):ğŸ“š æœåŠ¡ç«¯åº”ç”¨ç¨‹åºå¼€å‘ä¸ç³»ç»Ÿæ¶æ„/å¾®æœåŠ¡æ¶æ„ä¸å®è·µï¼ŒæœåŠ¡ç«¯åŸºç¡€ç¯‡ | å¾®æœåŠ¡ä¸äº‘åŸç”Ÿç¯‡ | Spring ç¯‡ | Node.js ç¯‡ | DevOps ç¯‡ | ä¿¡æ¯å®‰å…¨ä¸æ¸—é€æµ‹è¯•ç¯‡
* [lemonchann/TechClass](https://github.com/lemonchann/TechClass):é¡¹ç›®æ¶µç›–æˆä¸ºä¸€ä¸ªåç«¯å¼€å‘ç¨‹åºå‘˜å¿…å¤‡çš„æŠ€èƒ½ï¼ŒåŒ…æ‹¬Linuxã€ç½‘ç»œã€æ¶æ„ã€å¾®æœåŠ¡ã€æ•°æ®åº“ã€æ•°æ®ç»“æ„å’Œç®—æ³•ã€ç¼–ç¨‹è¯­è¨€å­¦ä¹ ç­‰å†…å®¹ <https://lemonchann.github.io/TechClass>

## å‚è€ƒ

* [dianping/camel](https://github.com/dianping/camel):è½¯è´Ÿè½½ä¸€ä½“è§£å†³æ–¹æ¡ˆï¼Œæ‰¿æ‹…äº†F5ç¡¬è´Ÿè½½å±‚åçš„è½¯è´Ÿè½½å·¥ä½œ
* [cilium](https://github.com/cilium/cilium):API Aware Networking and Security using BPF and XDP
