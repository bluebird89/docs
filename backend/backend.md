# åç«¯|æœåŠ¡å™¨ç«¯

* ä¸‰é«˜ï¼ˆé«˜å¹¶å‘ï¼Œé«˜å¯ç”¨ï¼Œé«˜æ€§èƒ½ï¼‰
* å®‰å…¨
* å­˜å‚¨
* ä¸šåŠ¡

## æ–¹å‘

* ç½‘ç»œ-åˆ†å¸ƒå¼ç³»ç»Ÿ-å¹¶è¡Œè®¡ç®—
* ä¸šåŠ¡é€»è¾‘-WEB-æ¸¸æˆ-äº¤æ˜“-æœç´¢
* æ•°æ®-CACHE-DB-KeyValue-æ–‡ä»¶å­˜å‚¨æœåŠ¡
* è¿ç»´-è´Ÿè½½å‡è¡¡-å®¹é”™-å®¹ç¾-è¿ç»´å·¥å…·

## èŒèƒ½

* webé¡¹ç›®å¼€å‘
* åº•å±‚APIå°è£…ä¸å¼€å‘:ä¸ºå‰ç«¯æ“ä½œæä¾›æœåŠ¡
* çº¿ä¸Šç³»ç»Ÿçš„ä¼˜åŒ–
* çº¿ä¸ŠæœåŠ¡å™¨çš„è¿ç»´ï¼Œå¸¸è§é—®é¢˜çš„è¯Šæ–­ä¸è§£å†³ã€‚
* å­˜å‚¨ï¼šæ–‡ä»¶ ä¿¡æ¯ ä¿¡æ¯ä¹‹é—´çš„å…³ç³»ï¼ˆæ•°æ®åº“ï¼‰

## æŠ€èƒ½

* æŒæ¡å¥½è¯­è¨€åŸºç¡€
* è¯­è¨€ç”Ÿæ€
  - apache+php å¸¸ç”¨çš„PHPå’Œapacheæ¨¡å—
  - æ¡†æ¶ï¼šLN(A)MPæ¶æ„
* ç®—æ³•ä¸æ•°æ®ç»“æ„
* è®¡ç®—æœºç½‘ç»œ
* æ•°æ®åº“
  - Mysql ä¼˜åŒ–ã€èƒ½åˆ›å»ºé«˜æ•ˆçš„ç´¢å¼•
  - nosql
* æ¶ˆæ¯ä¸­é—´ä»¶
* Linuxä¸åº”ç”¨éƒ¨ç½²ï¼ŒShellè„šæœ¬
* ç¼“å­˜
  * Memcache
  * Redis
* æœåŠ¡åŒ–
* é¡¹ç›®æ‰©å±•
  - restful
  - solr
* æ¨¡ç‰ˆå¼•æ“

## ä¸šåŠ¡

* è®¾è®¡ã€å®ç°ç›¸å…³ä¸šåŠ¡æœåŠ¡
* åº•å±‚æ¡†æ¶ä»£ç ä»¥åŠçº¿ä¸Šç³»ç»Ÿä¼˜åŒ–

## è¿›é˜¶

* äº†è§£å¤§å®¹é‡ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å‘åŸç†
* åœ¨å¼€æ”¾å¹³å°ï¼Œåˆ†å¸ƒå¼å­˜å‚¨ï¼Œåˆ†å¸ƒå¼Cache

## è¶‹åŠ¿

* å¼‚æ­¥æ¨¡å¼ï¼šGo Dubbo.å¼‚æ­¥éé˜»å¡çš„ Nginxï¼Œè€Œä¸æ˜¯åŒæ­¥é˜»å¡çš„ Apacheã€‚å°±æ˜¯å› ä¸º Nginx è¿™æ ·çš„å¼‚æ­¥ç¨‹åºï¼Œå®ƒçš„é€‚åº”æ€§æ›´å¥½ã€å¹¶å‘èƒ½åŠ›æ›´å¼ºã€‚ç°åœ¨åœ¨åç«¯ä¸šåŠ¡å¼€å‘ç¼–ç¨‹æ–¹é¢ï¼ŒæŠ€æœ¯åŠ›é‡å¼ºçš„å›¢é˜Ÿå·²ç»å¼€å§‹å°†æŠ€æœ¯æ ˆä»åŒæ­¥æ¨¡å¼åˆ‡æ¢ä¸ºå¼‚æ­¥äº†ã€‚
  - åŒæ­¥é˜»å¡æ¨¡å¼å­˜åœ¨è¾ƒå¤šç¼ºé™·ï¼Œå¹¶å‘èƒ½åŠ›å¼±ã€é€‚åº”æ€§å·®ã€æ…¢é€Ÿè¯·æ±‚å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚å¦‚ï¼šåå°æ¥å£ä¸­è°ƒç”¨ç¬¬ä¸‰æ–¹ API çš„åœºæ™¯ï¼ŒåŒæ­¥æ¨¡å¼æ•ˆæœæå·®ã€‚è¿‡å»é‚£äº›ä½¿ç”¨ Javaã€PHPã€C++ã€Pythonã€Ruby è¯­è¨€å¼€å‘çš„åŒæ­¥é˜»å¡æ¨¡å¼æ¡†æ¶ï¼Œç”¨çš„äººè¶Šæ¥è¶Šå°‘ã€‚
* Node.js:å¾ˆå°‘è§åˆ°ä¼ä¸šå°† Node.js ä½œä¸ºå…¬å¸åç«¯æ–¹é¢çš„ä¸»è¦ç¼–ç¨‹è¯­è¨€.
  - å¼‚æ­¥å›è°ƒçš„æŠ€æœ¯æ–¹æ¡ˆï¼Œä»¥åŠåœ¨å®ƒä¹‹ä¸Šæ‰€åšçš„ä¸€äº›ä¼˜åŒ–æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Promiseã€Futureã€Yield/Generatorã€Async/Await ç­‰ï¼Œæ”¹å˜äº†ç¨‹åºå¼€å‘çš„é£æ ¼å’Œä¹ æƒ¯ã€‚ä½¿ç”¨è¿™äº›æŠ€æœ¯æ–¹æ¡ˆæ˜¯æ— æ³•å…¼å®¹å·²æœ‰ç¨‹åºçš„
* åç¨‹æ¨¡å¼ï¼Œå…¼é¡¾äº†åŒæ­¥é˜»å¡çš„å¯ç»´æŠ¤æ€§å’Œå¼‚æ­¥éé˜»å¡çš„é«˜å¹¶å‘èƒ½åŠ›ã€‚å°†ä¼šæˆä¸ºæœªæ¥åç«¯å¼€å‘é¢†åŸŸçš„ä¸»æµæŠ€æœ¯æ–¹æ¡ˆã€‚
  - åç¨‹æ¨¡å¼åªéœ€è¦å¯¹å·²æœ‰é¡¹ç›®ä»£ç è¿›è¡Œå°‘é‡è°ƒæ•´å°±å¯ä»¥è¿è¡Œèµ·æ¥ï¼Œç”šè‡³å¯ä»¥å®Œå…¨å…¼å®¹è€é¡¹ç›®ã€‚åªéœ€è¦æ¡†æ¶å±‚è¿›è¡Œå…¼å®¹å³å¯ã€‚
  - GO æ˜¯æœ€è€€çœ¼çš„é‚£ä¸€ä¸ªã€‚åç¨‹ã€é€šé“ã€é™æ€è¯­è¨€ã€æ€§èƒ½ã€å¯Œç¼–è¯‘ã€æ ‡å‡†åº“ä¸°å¯Œã€ç”Ÿæ€å®Œæ•´ã€Google ç­‰
  - PHP + Swoole çš„æŠ€æœ¯æ ˆï¼Œæ›´é€‚åˆå¿«é€Ÿå¼€å‘ã€å¿«é€Ÿè¿­ä»£ã€ä¸šåŠ¡é©±åŠ¨çš„åœºæ™¯ã€‚æ¯•ç«ŸåŠ¨æ€è¯­è¨€æ¯”é™æ€è¯­è¨€è¿˜æ˜¯è¦æ›´åŠ çµæ´»ã€å¼€å‘æ•ˆç‡æ›´é«˜ã€‚è€Œ Go æ›´é€‚åˆç¼–å†™ç³»ç»Ÿçº§è½¯ä»¶ã€æ ¸å¿ƒä¸šåŠ¡ã€‚

## ç³»ç»Ÿæ€§èƒ½

* åˆ†ç±»
  - Load Testing - è´Ÿè½½æµ‹è¯•
  - Stress Testing - å‹åŠ›æµ‹è¯•
  - Soak Testing - è€ä¹…æµ‹è¯•
  - Spike Testing - ç¬å‹æµ‹è¯•
* æŒ‡æ ‡
  - æŠ€æœ¯æŒ‡æ ‡
    + OK / KO
    + QPS / RPS / TPS
    + Response Time(min/max/mean/std/90%â€¦)
    + Concurrent Users / Concurrent Requests
  - ä¸šåŠ¡æŒ‡æ ‡
    + å¹³å‡åŒæ—¶åœ¨çº¿ç”¨æˆ·æ•°
    + åŒæ—¶åœ¨çº¿ç”¨æˆ·æ•°
* æ­¥éª¤
  - ç¡®å®šæ€§èƒ½éœ€æ±‚ï¼ˆå¯é€‰ï¼‰
  - å‡†å¤‡æµ‹è¯•ç¯å¢ƒå’Œæµ‹è¯•æ•°æ®
  - é€‰æ‹©æ€§èƒ½æµ‹è¯•å·¥å…·/å¹³å°ï¼Œ
  - åˆ¶å®šæ€§èƒ½æµ‹è¯•æ¨¡å‹ï¼Œç¼–å†™æ€§èƒ½æµ‹è¯•ä»£ç 
  - è¿è¡Œæ€§èƒ½æµ‹è¯•
  - åˆ†ææµ‹è¯•æŠ¥å‘Š
  - æ€§èƒ½è°ƒä¼˜ | ä¿®å¤é—®é¢˜
* æµ‹è¯•æ ¸å¿ƒ
  - ç½‘å…³(é˜²ç«å¢™/VPNç­‰)
  - åº”ç”¨ç³»ç»Ÿ
  - æ•°æ®åº“
* ç›®æ ‡ï¼šæ ¸å¿ƒä¸‰ç‚¹éƒ½åˆ†åˆ«æ€§èƒ½æœ€ä¼˜ï¼Œå¹¶ä¸”å…¨é“¾è·¯é•¿æ—¶è¶…é«˜å‹èƒ½æ­£å¸¸è¿è¡Œ
* å†…å®¹
  - æ¶æ„æ˜“æ‰©å±•
  - æµ‹è¯•è¾ƒç®€å•
  - åˆ†æå¾ˆå›°éš¾
    + æ€§èƒ½æµ‹è¯•ç»“æœ ï¼ˆ Throughput vs Latency ç­‰ï¼‰
    + æ“ä½œç³»ç»Ÿç›‘æ§ï¼ˆ CPU, Memory, IO, Network ç­‰ï¼‰
    + åº”ç”¨ç³»ç»Ÿï¼ˆ Profiler, Code Review ç­‰ï¼‰
    + ç½‘å…³å’Œæ•°æ®åº“ ï¼ˆ Logs, CPU, Memory, IO ç­‰ï¼‰
  - ä¼˜åŒ–å¯çµæ´»
    + ç¡¬ä»¶åŸºç¡€è®¾æ–½ä¼˜åŒ–
    + æ“ä½œç³»ç»Ÿä¼˜åŒ–
    + åº”ç”¨ç³»ç»Ÿä¼˜åŒ–
    + æ•°æ®åº“ä¼˜åŒ–
    + ç³»ç»Ÿæ¶æ„ä¼˜åŒ–
  - è§„åˆ’è¦æŒ‰éœ€
    + é€‰å–æµ‹è¯•æŒ‡æ ‡
    + å»ºç«‹æµ‹è¯•æ¨¡å‹
    + å˜åŒ–æµ‹è¯•æŒ‡æ ‡
    + åˆ†ææµ‹è¯•æŠ¥å‘Šã€æ‹Ÿåˆæµ‹è¯•æ•°æ®

## è´Ÿè½½å‡è¡¡ Load Balancer

* å½“ç³»ç»Ÿé¢ä¸´å¤§é‡ç”¨æˆ·è®¿é—®ï¼Œè´Ÿè½½è¿‡é«˜çš„æ—¶å€™ï¼Œä½¿ç”¨æœåŠ¡å™¨é›†ç¾¤æ¥æé«˜ç½‘ç«™çš„æ•´ä½“æ€§èƒ½ï¼Œä¸€ç»„è®¡ç®—æœºèŠ‚ç‚¹ï¼ˆæˆ–è€…ä¸€ç»„è¿›ç¨‹ï¼‰æä¾›ç›¸åŒï¼ˆåŒè´¨çš„ï¼‰æœåŠ¡ï¼ŒæœåŠ¡è¯·æ±‚åº”è¯¥å‡åŒ€åˆ†æ‘Šåˆ°è¿™äº›èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨é›†ç¾¤å’Œè´Ÿè½½å‡è¡¡æé«˜æ•´ä¸ªç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›
* æŠŠç”¨æˆ·è®¿é—®çš„æµé‡é€šè¿‡ã€Œè´Ÿè½½å‡è¡¡å™¨ã€æ ¹æ®æŸç§è½¬å‘ç­–ç•¥ï¼Œå‡åŒ€çš„åˆ†å‘åˆ°åç«¯å¤šå°æœåŠ¡å™¨ä¸Šï¼Œåç«¯æœåŠ¡å™¨å¯ä»¥ç‹¬ç«‹å“åº”å’Œå¤„ç†è¯·æ±‚ï¼Œä»è€Œå®ç°åˆ†æ•£è´Ÿè½½çš„æ•ˆæœï¼Œè´Ÿè½½å‡è¡¡çš„å…³é”®åœ¨äºå°†ç”¨æˆ·æµé‡è¿›è¡Œå‡è¡¡å‡å‹çš„
* è®©æ‰€æœ‰èŠ‚ç‚¹ä»¥æœ€å°ä»£ä»·ã€æœ€å¥½çŠ¶æ€å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™æ ·ç³»ç»Ÿååé‡æœ€å¤§ï¼Œæ€§èƒ½æ›´é«˜ï¼Œå¯¹äºç”¨æˆ·è€Œè¨€è¯·æ±‚çš„æ—¶é—´ä¹Ÿæ›´å°
* åœ¨æœåŠ¡å™¨é›†ç¾¤ä¸­ï¼Œéœ€è¦æœ‰ä¸€å°æœåŠ¡å™¨å……å½“è°ƒåº¦è€…çš„è§’è‰²ï¼Œç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šé¦–å…ˆç”±å®ƒæ¥æ”¶ï¼Œè°ƒåº¦è€…å†æ ¹æ®æ¯å°æœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µå°†è¯·æ±‚åˆ†é…ç»™æŸä¸€å°åç«¯æœåŠ¡å™¨å»å¤„ç†ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè°ƒåº¦è€…å¦‚ä½•åˆç†åˆ†é…ä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰åç«¯æœåŠ¡å™¨éƒ½å°†æ€§èƒ½å……åˆ†å‘æŒ¥ï¼Œä»è€Œä¿æŒæœåŠ¡å™¨é›†ç¾¤çš„æ•´ä½“æ€§èƒ½æœ€ä¼˜ï¼Œè¿™å°±æ˜¯è´Ÿè½½å‡è¡¡è¦è§£å†³çš„é—®é¢˜ã€‚
* ç±»å‹
  - äºŒå±‚è´Ÿè½½å‡è¡¡ï¼šåŸºäºMACåœ°å€çš„äºŒå±‚è´Ÿè½½å‡è¡¡
  - ä¸‰å±‚è´Ÿè½½å‡è¡¡ï¼šåŸºäºIPåœ°å€çš„è´Ÿè½½å‡è¡¡
  - å››å±‚è´Ÿè½½å‡è¡¡ï¼šåŸºäºIP+ç«¯å£çš„è´Ÿè½½å‡è¡¡
  - ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼šåŸºäºURLç­‰åº”ç”¨å±‚ä¿¡æ¯çš„è´Ÿè½½å‡è¡¡
* ä¼˜ç‚¹
  - å¢å¼ºäº†ç³»ç»Ÿå¯é æ€§
  - æé«˜äº†ç³»ç»ŸæœåŠ¡èƒ½åŠ›
  - å¢å¼ºäº†åº”ç”¨å¯ç”¨æ€§ï¼Œæœ€å¤§åŒ–é™ä½äº†å•ä¸ªèŠ‚ç‚¹è¿‡è½½ã€ç”šè‡³crashæ¦‚ç‡
* è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§æ¨æ¨¡å‹ï¼Œä¸€å®šä¼šé€‰å‡ºä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œç„¶åæŠŠè¯·æ±‚æ¨é€è¿‡æ¥
* æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ‹‰æ¨¡å‹ï¼šç©ºé—²æœåŠ¡èŠ‚ç‚¹ä¸»åŠ¨å»æ‹‰å–è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå„ä¸ªèŠ‚ç‚¹è´Ÿè½½è‡ªç„¶ä¹Ÿæ˜¯å‡è¡¡çš„
  - æœåŠ¡èŠ‚ç‚¹ä¸ä¼šè¢«å¤§é‡è¯·æ±‚å†²å®ï¼ŒåŒæ—¶å¢åŠ æœåŠ¡èŠ‚ç‚¹æ›´åŠ å®¹æ˜“
  - ç¼ºç‚¹ï¼šè¯·æ±‚ä¸æ˜¯äº‹å®å¤„ç†çš„

## IDC Internet Data Center æ•°æ®ä¸­å¿ƒã€æœºæˆ¿

* ç”¨æ¥æ”¾ç½®æœåŠ¡å™¨ã€‚IDCç½‘ç»œæ˜¯æœåŠ¡å™¨é—´é€šä¿¡çš„æ¡¥æ¢
* ç½‘ç»œè®¾å¤‡
  - å†…ç½‘æ¥å…¥äº¤æ¢æœºï¼šä¹Ÿç§°ä¸ºTOR(top of rack),æ˜¯æœåŠ¡å™¨æ¥å…¥ç½‘ç»œçš„è®¾å¤‡ã€‚æ¯å°å†…ç½‘æ¥å…¥äº¤æ¢æœºä¸‹è”40-48å°æœåŠ¡å™¨ï¼Œä½¿ç”¨ä¸€ä¸ªæ©ç ä¸º/24çš„ç½‘æ®µä½œä¸ºæœåŠ¡å™¨å†…ç½‘ç½‘æ®µã€‚
  - å†…ç½‘æ ¸å¿ƒäº¤æ¢æœºï¼šè´Ÿè´£IDCå†…å„å†…ç½‘æ¥å…¥äº¤æ¢æœºçš„æµé‡è½¬å‘åŠè·¨IDCæµé‡è½¬å‘ã€‚
  - MGW/NATï¼šMGWå³LVSç”¨æ¥åšè´Ÿè½½å‡è¡¡ï¼ŒNATç”¨äºå†…ç½‘è®¾å¤‡è®¿é—®å¤–ç½‘æ—¶åšåœ°å€è½¬æ¢ã€‚
  - å¤–ç½‘æ ¸å¿ƒè·¯ç”±å™¨ï¼šé€šè¿‡é™æ€äº’è”è¿è¥å•†æˆ–BGPäº’è”ç»Ÿä¸€å¤–ç½‘å¹³å°ã€‚

![Alt text](../_static/idc.jpg "Optional title")

### ç»“æ„

æ¯ä¸€ä¸ªä¸Šæ¸¸éƒ½å‡åŒ€è®¿é—®æ¯ä¸€ä¸ªä¸‹æ¸¸ï¼Œå°±èƒ½å®ç°â€œå°†è¯·æ±‚/æ•°æ®ã€å‡åŒ€ã€‘åˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒä¸Šæ‰§è¡Œ

* å®¢æˆ·ç«¯å±‚ï¼šå…¸å‹è°ƒç”¨æ–¹æ˜¯æµè§ˆå™¨browseræˆ–è€…æ‰‹æœºåº”ç”¨APPï¼Œæ ¹æ®æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯è‡ªè¡Œé€‰æ‹©ï¼Œç„¶åå°†è¯·æ±‚ç›´æ¥å‘é€åˆ°é€‰ä¸­æœåŠ¡èŠ‚ç‚¹
  - çŸ¥é“æœåŠ¡å™¨åˆ—è¡¨ï¼Œè¦ä¹ˆæ˜¯é™æ€é…ç½®ï¼Œè¦ä¹ˆæœ‰ç®€å•æ¥å£æŸ¥è¯¢
  - backend serverè¯¦ç»†è´Ÿè½½ä¿¡æ¯ï¼Œå°±ä¸é€‚ç”¨é€šè¿‡å®¢æˆ·ç«¯æ¥æŸ¥è¯¢
  - ç®—æ³•è¦ä¹ˆæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ¯”å¦‚è½®è®­ï¼ˆåŠ æƒè½®è®­ï¼‰ã€éšæœºï¼ˆåŠ æƒéšæœºï¼‰ã€å“ˆå¸Œè¿™å‡ ç§ç®—æ³•ï¼Œåªè¦æ¯ä¸ªå®¢æˆ·ç«¯è¶³å¤Ÿéšæœºï¼ŒæŒ‰ç…§å¤§æ•°å®šç†ï¼ŒæœåŠ¡èŠ‚ç‚¹çš„è´Ÿè½½ä¹Ÿæ˜¯å‡è¡¡çš„
  - è¾ƒä¸ºå¤æ‚ç®—æ³•ï¼Œæ¯”å¦‚æ ¹æ®backendçš„å®é™…è´Ÿè½½éœ€è¦å»é¢å¤–çš„è´Ÿè½½å‡è¡¡æœåŠ¡ï¼ˆexternal load balancing serviceï¼‰æŸ¥è¯¢åˆ°è¿™äº›ä¿¡æ¯ï¼Œåœ¨grpcä¸­ï¼Œå°±æ˜¯ä½¿ç”¨è¿™ç§åŠæ³•
    + load balancerä¸grpc serveré€šä¿¡ï¼Œè·å¾—grpc serverçš„è´Ÿè½½ç­‰å…·ä½“è¯¦ç»†
    + grpc clientä»load balancerè·å–è¿™äº›ä¿¡æ¯ï¼Œæœ€ç»ˆgrpc clientç›´è¿åˆ°è¢«é€‰æ‹©çš„grpc server
* åå‘ä»£ç†å±‚ï¼šç³»ç»Ÿå…¥å£ï¼Œåå‘ä»£ç†
  - æ°´å¹³æ‰©å±•é€šè¿‡â€œDNSè½®è¯¢â€å®ç°çš„ï¼šdns-serverå¯¹äºä¸€ä¸ªåŸŸåé…ç½®äº†å¤šä¸ªè§£æipï¼Œæ¯æ¬¡DNSè§£æè¯·æ±‚æ¥è®¿é—®dns-serverï¼Œä¼šè½®è¯¢è¿”å›è¿™äº›ip
  - å½“nginxæˆä¸ºç“¶é¢ˆçš„æ—¶å€™ï¼Œåªè¦å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œæ–°å¢nginxæœåŠ¡éƒ¨ç½²ï¼Œå¢åŠ ä¸€ä¸ªå¤–ç½‘ipï¼Œå°±èƒ½æ‰©å±•åå‘ä»£ç†å±‚çš„æ€§èƒ½ï¼Œåšåˆ°ç†è®ºä¸Šçš„æ— é™é«˜å¹¶å‘
  - è¯·æ±‚è½®è¯¢ï¼šå’ŒDNSè½®è¯¢ç±»ä¼¼ï¼Œè¯·æ±‚ä¾æ¬¡è·¯ç”±åˆ°å„ä¸ªweb-serverï¼›
  - æœ€å°‘è¿æ¥è·¯ç”±ï¼šå“ªä¸ªweb-serverçš„è¿æ¥å°‘ï¼Œè·¯ç”±åˆ°å“ªä¸ªweb-serverï¼›
  - ipå“ˆå¸Œï¼šæŒ‰ç…§è®¿é—®ç”¨æˆ·çš„ipå“ˆå¸Œå€¼æ¥è·¯ç”±web-serverï¼Œåªè¦ç”¨æˆ·çš„ipåˆ†å¸ƒæ˜¯å‡åŒ€çš„ï¼Œè¯·æ±‚ç†è®ºä¸Šä¹Ÿæ˜¯å‡åŒ€çš„ï¼Œipå“ˆå¸Œå‡è¡¡æ–¹æ³•å¯ä»¥åšåˆ°ï¼ŒåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å›ºå®šè½åˆ°åŒä¸€å°web-serverä¸Šï¼Œæ­¤ç­–ç•¥é€‚åˆæœ‰çŠ¶æ€æœåŠ¡ï¼Œä¾‹å¦‚sessionï¼›
* ç«™ç‚¹åº”ç”¨å±‚ï¼šå®ç°æ ¸å¿ƒåº”ç”¨é€»è¾‘ï¼Œè¿”å›htmlæˆ–è€…json
  - æ°´å¹³æ‰©å±•é€šè¿‡â€œnginxâ€å®ç°çš„ã€‚é€šè¿‡ä¿®æ”¹nginx.confï¼Œè®¾ç½®å¤šä¸ªwebåç«¯
  - å½“webåç«¯æˆä¸ºç“¶é¢ˆçš„æ—¶å€™ï¼Œå¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œæ–°å¢webæœåŠ¡éƒ¨ç½²ï¼Œåœ¨nginxé…ç½®ä¸­é…ç½®ä¸Šæ–°çš„webåç«¯ï¼Œå°±èƒ½æ‰©å±•ç«™ç‚¹å±‚çš„æ€§èƒ½ï¼Œåšåˆ°ç†è®ºä¸Šçš„æ— é™é«˜å¹¶å‘
* æœåŠ¡å±‚ï¼šå¦‚æœå®ç°äº†æœåŠ¡åŒ–ï¼Œå°±æœ‰è¿™ä¸€å±‚
  - æ°´å¹³æ‰©å±•é€šè¿‡â€œæœåŠ¡è¿æ¥æ± â€å®ç°çš„ã€‚ç«™ç‚¹å±‚é€šè¿‡RPC-clientè°ƒç”¨ä¸‹æ¸¸çš„æœåŠ¡å±‚RPC-serveræ—¶ï¼ŒRPC-clientä¸­çš„è¿æ¥æ± ä¼šå»ºç«‹ä¸ä¸‹æ¸¸æœåŠ¡å¤šä¸ªè¿æ¥ï¼Œå½“æœåŠ¡æˆä¸ºç“¶é¢ˆçš„æ—¶å€™ï¼Œåªè¦å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œæ–°å¢æœåŠ¡éƒ¨ç½²ï¼Œåœ¨RPC-clientå¤„å»ºç«‹æ–°çš„ä¸‹æ¸¸æœåŠ¡è¿æ¥ï¼Œå°±èƒ½æ‰©å±•æœåŠ¡å±‚æ€§èƒ½ï¼Œåšåˆ°ç†è®ºä¸Šçš„æ— é™é«˜å¹¶å‘
  - å¦‚æœéœ€è¦ä¼˜é›…è¿›è¡ŒæœåŠ¡å±‚è‡ªåŠ¨æ‰©å®¹ï¼Œéœ€è¦é…ç½®ä¸­å¿ƒé‡ŒæœåŠ¡è‡ªåŠ¨å‘ç°åŠŸèƒ½çš„æ”¯æŒ
* ç¼“å­˜å±‚ï¼šç¼“å­˜åŠ é€Ÿè®¿é—®å­˜å‚¨
* æ•°æ®åº“å±‚ï¼šæ•°æ®åº“å›ºåŒ–æ•°æ®å­˜å‚¨
* åœ¨æ•°æ®é‡å¾ˆå¤§æƒ…å†µä¸‹ï¼Œæ•°æ®å±‚ï¼ˆç¼“å­˜ï¼Œæ•°æ®åº“ï¼‰æ¶‰åŠæ•°æ®æ°´å¹³æ‰©å±•ï¼Œå°†åŸæœ¬å­˜å‚¨åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼ˆç¼“å­˜ï¼Œæ•°æ®åº“ï¼‰æ°´å¹³æ‹†åˆ†åˆ°ä¸åŒæœåŠ¡å™¨ä¸Šå»ï¼Œä»¥è¾¾åˆ°æ‰©å……ç³»ç»Ÿæ€§èƒ½çš„ç›®çš„ï¼Œè¦è€ƒè™‘â€œæ•°æ®çš„å‡è¡¡â€ä¸â€œè¯·æ±‚çš„å‡è¡¡â€ä¸¤ä¸ªç‚¹
  - æŒ‰ç…§èŒƒå›´æ°´å¹³æ‹†åˆ†ï¼šæ¯ä¸€ä¸ªæ•°æ®æœåŠ¡ï¼Œå­˜å‚¨ä¸€å®šèŒƒå›´çš„æ•°æ®ï¼Œuser0åº“ï¼Œå­˜å‚¨uidèŒƒå›´1-1kwï¼Œuser1åº“ï¼Œå­˜å‚¨uidèŒƒå›´1kw-2kw
    + è§„åˆ™ç®€å•ï¼Œserviceåªéœ€åˆ¤æ–­ä¸€ä¸‹uidèŒƒå›´å°±èƒ½è·¯ç”±åˆ°å¯¹åº”çš„å­˜å‚¨æœåŠ¡ï¼›
    + æ•°æ®å‡è¡¡æ€§è¾ƒå¥½ï¼›
    + æ¯”è¾ƒå®¹æ˜“æ‰©å±•ï¼Œå¯ä»¥éšæ—¶åŠ ä¸€ä¸ªuid[2kw,3kw]çš„æ•°æ®æœåŠ¡
    + ä¸è¶³ï¼šè¯·æ±‚çš„è´Ÿè½½ä¸ä¸€å®šå‡è¡¡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ–°æ³¨å†Œçš„ç”¨æˆ·ä¼šæ¯”è€ç”¨æˆ·æ›´æ´»è·ƒï¼Œå¤§rangeçš„æœåŠ¡è¯·æ±‚å‹åŠ›ä¼šæ›´å¤§
  - æŒ‰ç…§å“ˆå¸Œæ°´å¹³æ‹†åˆ†:æ¯ä¸€ä¸ªæ•°æ®åº“ï¼Œå­˜å‚¨æŸä¸ªkeyå€¼hashåçš„éƒ¨åˆ†æ•°æ®ï¼Œuser0åº“ï¼Œå­˜å‚¨å¶æ•°uidæ•°æ®,user1åº“ï¼Œå­˜å‚¨å¥‡æ•°uidæ•°æ®
    + è§„åˆ™ç®€å•ï¼Œserviceåªéœ€å¯¹uidè¿›è¡Œhashèƒ½è·¯ç”±åˆ°å¯¹åº”çš„å­˜å‚¨æœåŠ¡
    + æ•°æ®å‡è¡¡æ€§è¾ƒå¥½
    + è¯·æ±‚å‡åŒ€æ€§è¾ƒå¥½
    + ä¸å®¹æ˜“æ‰©å±•ï¼Œæ‰©å±•ä¸€ä¸ªæ•°æ®æœåŠ¡ï¼Œhashæ–¹æ³•æ”¹å˜æ—¶å€™ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œæ•°æ®è¿ç§»
  - æ°´å¹³æ‹†åˆ†æ¥æ‰©å……ç³»ç»Ÿæ€§èƒ½vsä¸»ä»åŒæ­¥è¯»å†™åˆ†ç¦»
    + æ°´å¹³æ‹†åˆ†æ‰©å±•æ•°æ®åº“æ€§èƒ½ï¼š
      * æ¯ä¸ªæœåŠ¡å™¨ä¸Šå­˜å‚¨çš„æ•°æ®é‡æ˜¯æ€»é‡çš„1/nï¼Œæ‰€ä»¥å•æœºçš„æ€§èƒ½ä¹Ÿä¼šæœ‰æå‡
      * nä¸ªæœåŠ¡å™¨ä¸Šçš„æ•°æ®æ²¡æœ‰äº¤é›†ï¼Œé‚£ä¸ªæœåŠ¡å™¨ä¸Šæ•°æ®çš„å¹¶é›†æ˜¯æ•°æ®çš„å…¨é›†
      * æ•°æ®æ°´å¹³æ‹†åˆ†åˆ°äº†nä¸ªæœåŠ¡å™¨ä¸Šï¼Œç†è®ºä¸Šè¯»æ€§èƒ½æ‰©å……äº†nå€ï¼Œå†™æ€§èƒ½ä¹Ÿæ‰©å……äº†nå€ï¼ˆå…¶å®è¿œä¸æ­¢nå€ï¼Œå› ä¸ºå•æœºçš„æ•°æ®é‡å˜ä¸ºäº†åŸæ¥çš„1/nï¼‰
    + é€šè¿‡ä¸»ä»åŒæ­¥è¯»å†™åˆ†ç¦»æ‰©å±•æ•°æ®åº“æ€§èƒ½ï¼š
      * æ¯ä¸ªæœåŠ¡å™¨ä¸Šå­˜å‚¨çš„æ•°æ®é‡æ˜¯å’Œæ€»é‡ç›¸åŒ
      * nä¸ªæœåŠ¡å™¨ä¸Šçš„æ•°æ®éƒ½ä¸€æ ·ï¼Œéƒ½æ˜¯å…¨é›†
      * ç†è®ºä¸Šè¯»æ€§èƒ½æ‰©å……äº†nå€ï¼Œå†™ä»ç„¶æ˜¯å•ç‚¹ï¼Œå†™æ€§èƒ½ä¸å˜
* æœåŠ¡èŠ‚ç‚¹é›†ç¾¤ä¹‹å‰æ”¾ä¸€ä¸ªé›†ä¸­å¼ä»£ç†ï¼ˆproxyï¼‰ï¼Œç”±ä»£ç†è´Ÿè´£è¯·æ±‚åˆ†å‘
  - 7å±‚Nginx:responseç»è¿‡Proxy
  - å››å±‚F5ã€LVS:responseä¸ç»è¿‡proxyï¼Œå¦‚LVS
  - åœ¨äºæ–¹ä¾¿æ§åˆ¶ï¼Œè€Œä¸”èƒ½å®¹æ˜“å®ç°ä¸€äº›æ›´ç²¾å¯†ï¼Œæ›´å¤æ‚çš„ç®—æ³•
  - ç¼ºç‚¹
    - è´Ÿè½½å‡è¡¡å™¨æœ¬èº«å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
    - å¯èƒ½å¼•å…¥é¢å¤–çš„å»¶è¿Ÿï¼Œè¯·æ±‚ä¸€å®šå…ˆå‘åˆ°è¾¾è´Ÿè½½å‡è¡¡å™¨ï¼Œç„¶ååˆ°è¾¾çœŸæ­£çš„æœåŠ¡èŠ‚ç‚¹ã€‚
  * load balancer proxyä¸èƒ½æˆä¸ºå•ç‚¹æ•…éšœï¼ˆsingle point of failureï¼‰ï¼Œå› æ­¤ä¸€èˆ¬ä¼šè®¾è®¡ä¸ºé«˜å¯ç”¨çš„ä¸»ä»ç»“æ„
  * responseä¹Ÿæ˜¯èµ°load balancer proxyçš„è¯ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡è¿‡ç¨‹å¯¹å®¢æˆ·ç«¯è€Œè¨€å°±æ˜¯å®Œå…¨é€æ˜çš„ï¼Œä¹Ÿé˜²æ­¢äº†å®¢æˆ·ç«¯å»å°è¯•è¿æ¥åå°æœåŠ¡å™¨ï¼Œæä¾›äº†ä¸€å±‚å®‰å…¨ä¿éšœï¼

![grpcåŸç†å›¾](../_static/grpc.png "grpcåŸç†å›¾")
![proxyåŸç†å›¾](../_static/proxy.png "proxyåŸç†å›¾")

### æ–¹æ¡ˆ

* HTTPé‡å®šå‘ï¼šæƒè¡¡è½¬ç§»è¯·æ±‚å¼€é”€å’Œå¤„ç†å®é™…è¯·æ±‚å¼€é”€ï¼Œå‰è€…ç›¸å¯¹äºåè€…è¶Šå°ï¼Œé‚£ä¹ˆé‡å®šå‘çš„æ„ä¹‰å°±è¶Šå¤§
  - webæœåŠ¡å™¨å¯ä»¥é€šè¿‡httpå“åº”å¤´ä¿¡æ¯ä¸­çš„Locationæ ‡è®°æ¥è¿”å›ä¸€ä¸ªæ–°çš„URLã€‚è¿™æ„å‘³ç€HTTPä»£ç†éœ€è¦ç»§ç»­è¯·æ±‚è¿™ä¸ªæ–°çš„URLï¼Œå®Œæˆè‡ªåŠ¨è·³è½¬ã€‚
  - ç¼ºé™·
    + ååç‡é™åˆ¶ï¼šä¸»ç«™ç‚¹æœåŠ¡å™¨çš„ååç‡å¹³å‡åˆ†é…åˆ°äº†è¢«è½¬ç§»çš„æœåŠ¡å™¨ç°å‡è®¾ä½¿ç”¨RRï¼ˆRound Robinï¼‰è°ƒåº¦ç­–ç•¥ï¼Œä¸»æœåŠ¡å™¨çš„ååä¸å­æœåŠ¡å™¨åååŒ¹é…
    + é‡å®šå‘è®¿é—®æ·±åº¦ä¸åŒï¼šå®é™…æœåŠ¡å™¨çš„è´Ÿè½½å·®å¼‚æ˜¯ä¸å¯é¢„æ–™çš„ï¼Œè€Œä¸»ç«™æœåŠ¡å™¨å´ä¸€æ— æ‰€çŸ¥
* åŸºäºDNSè´Ÿè½½å‡è¡¡ï¼šå¯ä»¥å®ç°åœ¨åœ°åŸŸä¸Šæµé‡å‡è¡¡,DNSæœåŠ¡å™¨å……å½“è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨
  - ä½¿ç”¨åŸŸåç³»ç»Ÿé€šè¿‡å°†åŸŸåè§£æä¸ºæœåŠ¡å™¨çš„ä¸åŒ IP åœ°å€æ¥å°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨
  - å¤§å‹ç½‘ç«™ä¸€èˆ¬ä½¿ç”¨DNSä½œä¸ºç¬¬ä¸€çº§è´Ÿè½½å‡è¡¡,èŠ‚çœäº†æ‰€è°“çš„ä¸»ç«™ç‚¹ï¼ŒDNSæœåŠ¡å™¨å……å½“ä¸»ç«™ç‚¹èŒèƒ½ã€‚å¸¸è§ç­–ç•¥æ˜¯å¯¹å¤šä¸ªAè®°å½•è¿›è¡ŒRR(è½®è¯¢),digå‘½ä»¤æŸ¥è¯¢
    + åœ¨DNSæœåŠ¡å™¨é…ç½®å¤šä¸ªAè®°å½•ï¼Œä¸åŒçš„DNSè¯·æ±‚ä¼šè§£æåˆ°ä¸åŒçš„IPåœ°å€ è®©DNSæœåŠ¡å™¨æ ¹æ®ä¸åŒåœ°ç†ä½ç½®çš„ç”¨æˆ·è¿”å›ä¸åŒçš„IP
  - ç›¸å½“äºå®ç°äº†æŒ‰ç…§ã€Œå°±è¿‘åŸåˆ™ã€å°†è¯·æ±‚åˆ†æµäº†ï¼Œæ—¢å‡è½»äº†å•ä¸ªé›†ç¾¤çš„è´Ÿè½½å‹åŠ›ï¼Œä¹Ÿæå‡äº†ç”¨æˆ·çš„è®¿é—®é€Ÿåº¦
  - é…ç½®ç®€å•ï¼Œå®ç°æˆæœ¬éå¸¸ä½ï¼Œæ— éœ€é¢å¤–çš„å¼€å‘å’Œç»´æŠ¤å·¥ä½œ
  - ç¼ºç‚¹ï¼š
    + å¤§å¤šæ˜¯åŸºäºåœ°åŸŸæˆ–è€…å¹²è„†ç›´æ¥åšIPè½®è¯¢ï¼Œæ²¡æœ‰æ›´é«˜çº§çš„è·¯ç”±ç­–ç•¥ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯DNSæ–¹æ¡ˆçš„å±€é™æ‰€åœ¨ï¼Œæ¯”å¦‚ æ— æ³•å°†HTTPè¯·æ±‚çš„ä¸Šä¸‹æ–‡å¼•å…¥åˆ°è°ƒåº¦ç­–ç•¥ä¸­
    + DNSç”Ÿæ•ˆæ—¶é—´ç•¥é•¿ï¼Œå½“é…ç½®ä¿®æ”¹åï¼Œç”Ÿæ•ˆä¸åŠæ—¶ã€‚è¿™ä¸ªæ˜¯ç”±äºDNSçš„ç‰¹æ€§å¯¼è‡´çš„ï¼ŒDNSä¸€èˆ¬ä¼šæœ‰å¤šçº§ç¼“å­˜ï¼Œæ‰€ä»¥å½“ä¿®æ”¹äº†DNSé…ç½®ä¹‹åï¼Œç”±äºç¼“å­˜çš„åŸå› ï¼Œä¼šå¯¼è‡´IPå˜æ›´ä¸åŠæ—¶ï¼Œä»è€Œå½±å“è´Ÿè½½å‡è¡¡çš„æ•ˆæœ
    + å®¹æ˜“å¯¼è‡´æœåŠ¡å™¨ä¹‹é—´çš„åŠ¨æ€è´Ÿè½½ä¸å¹³è¡¡ï¼Œå› æ­¤æœåŠ¡å™¨å¾ˆéš¾å¤„ç†å…¶å³°å€¼è´Ÿè½½ã€‚åœ¨ DNS æœåŠ¡å™¨ä¸Šä¸èƒ½å¾ˆå¥½åœ°é€‰æ‹©åç§°æ˜ å°„çš„ TTL å€¼ã€‚
* åŸºäºç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼šç”¨äºå¤§å‹æœåŠ¡å™¨é›†ç¾¤ä¸­çš„è´Ÿè½½éœ€æ±‚ï¼ŒF5 Network Big-IP
  - å®Œå…¨é€šè¿‡ç¡¬ä»¶æ¥æŠ—å‹åŠ›ï¼Œæ€§èƒ½æ˜¯éå¸¸çš„å¥½ã€‚ç”¨åœ¨å¤§å‹äº’è”ç½‘å…¬å¸çš„æµé‡å…¥å£æœ€å‰ç«¯
  - ä¼˜ç‚¹ï¼š
    + åŠŸèƒ½å¼ºå¤§ï¼šæ”¯æŒå„å±‚çº§è´Ÿè½½å‡è¡¡åŠå…¨é¢è´Ÿè½½å‡è¡¡ç®—æ³•
    + æ€§èƒ½å¼ºå¤§ï¼šæ€§èƒ½è¿œè¶…å¸¸è§çš„è½¯ä»¶è´Ÿè½½å‡è¡¡å™¨
    + ç¨³å®šæ€§é«˜ï¼šç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼Œå¤§è§„æ¨¡ä½¿ç”¨è‚¯å®šæ˜¯ä¸¥æ ¼æµ‹è¯•è¿‡çš„
    + å®‰å…¨é˜²æŠ¤ï¼šé™¤å…·å¤‡è´Ÿè½½å‡è¡¡åŠŸèƒ½å¤–ï¼Œè¿˜å…·å¤‡é˜²ç«å¢™ã€é˜² DDoS æ”»å‡»ç­‰å®‰å…¨åŠŸèƒ½
  - ç¼ºç‚¹ï¼š
    + ä»·æ ¼æ˜‚è´µ
    + å¯æ‰©å±•æ€§å·®
    + è°ƒè¯•ç»´æŠ¤éº»çƒ¦
* åŸºäºè½¯ä»¶è´Ÿè½½å‡è¡¡ï¼šåŸºäºæœºå™¨å±‚é¢çš„æµé‡å‡è¡¡
  - åå‘ä»£ç†è´Ÿè½½å‡è¡¡ï½œä¸ƒå±‚è´Ÿè½½å‡è¡¡ :åŸºäºç¬¬ä¸ƒå±‚åº”ç”¨å±‚æ¥åšæµé‡åˆ†å‘
    + å·¥ä½œåœ¨HTTPå±‚é¢ï¼Œæ ¸å¿ƒå·¥ä½œæ˜¯è½¬å‘HTTP
    + ä»»ä½•å¯¹äºå®é™…æœåŠ¡å™¨HTTPè¯·æ±‚éƒ½å¿…é¡»ç»è¿‡è°ƒåº¦å™¨
    + è°ƒåº¦å™¨å¿…é¡»ç­‰å¾…å®é™…æœåŠ¡å™¨HTTPå“åº”ï¼Œå¹¶å°†å®ƒåé¦ˆç»™ç”¨æˆ·
    + ç‰¹æ€§ï¼š
      * è°ƒåº¦ç­–ç•¥ä¸°å¯Œ
      * å¯¹åå‘ä»£ç†æœåŠ¡å™¨çš„å¹¶å‘å¤„ç†èƒ½åŠ›è¦æ±‚é«˜ï¼Œå› ä¸ºå®ƒå·¥ä½œåœ¨HTTPå±‚é¢
      * åå‘ä»£ç†æœåŠ¡å™¨è¿›è¡Œè½¬å‘æ“ä½œæœ¬èº«éœ€è¦ä¸€å®šå¼€é”€çš„ï¼Œæ¯”å¦‚åˆ›å»ºçº¿ç¨‹ã€ä¸åç«¯æœåŠ¡å™¨å»ºç«‹TCPè¿æ¥ã€æ¥æ”¶åç«¯æœåŠ¡å™¨è¿”å›çš„å¤„ç†ç»“æœã€åˆ†æHTTPå¤´éƒ¨ä¿¡æ¯ã€ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é¢‘ç¹åˆ‡æ¢ç­‰ï¼Œè™½ç„¶è¿™éƒ¨åˆ†æ—¶é—´å¹¶ä¸é•¿ï¼Œä½†æ˜¯å½“åç«¯æœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æ—¶é—´éå¸¸çŸ­æ—¶ï¼Œè½¬å‘çš„å¼€é”€å°±æ˜¾å¾—å°¤ä¸ºçªå‡ºã€‚ä¾‹å¦‚è¯·æ±‚é™æ€æ–‡ä»¶ï¼Œæ›´é€‚åˆä½¿ç”¨å‰é¢ä»‹ç»çš„åŸºäºDNSçš„è´Ÿè½½å‡è¡¡æ–¹å¼
      * åå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥ç›‘æ§åç«¯æœåŠ¡å™¨ï¼Œæ¯”å¦‚ç³»ç»Ÿè´Ÿè½½ã€å“åº”æ—¶é—´ã€æ˜¯å¦å¯ç”¨ã€TCPè¿æ¥æ•°ã€æµé‡ç­‰ï¼Œä»è€Œæ ¹æ®è¿™äº›æ•°æ®è°ƒæ•´è´Ÿè½½å‡è¡¡çš„ç­–ç•¥
      * åå°„ä»£ç†æœåŠ¡å™¨å¯ä»¥è®©ç”¨æˆ·åœ¨ä¸€æ¬¡ä¼šè¯å‘¨æœŸå†…çš„æ‰€æœ‰è¯·æ±‚å§‹ç»ˆè½¬å‘åˆ°ä¸€å°ç‰¹å®šçš„åç«¯æœåŠ¡å™¨ä¸Šï¼ˆç²˜æ»ä¼šè¯ï¼‰ï¼Œè¿™æ ·çš„å¥½å¤„ä¸€æ˜¯ä¿æŒsessionçš„æœ¬åœ°è®¿é—®ï¼ŒäºŒæ˜¯é˜²æ­¢åç«¯æœåŠ¡å™¨çš„åŠ¨æ€å†…å­˜ç¼“å­˜çš„èµ„æºæµªè´¹
    + Nginxï¼šä¸ƒå±‚è´Ÿè½½å‡è¡¡ ï¼Œä¹Ÿç§°ä¸ºâ€œå†…å®¹äº¤æ¢â€ï¼Œä¹Ÿå°±æ˜¯ä¸»è¦é€šè¿‡æŠ¥æ–‡ä¸­çœŸæ­£æœ‰æ„ä¹‰çš„åº”ç”¨å±‚å†…å®¹
      * ä¼ ç»Ÿï¼šç›¸å¯¹äºä¼ ç»ŸåŸºäºè¿›ç¨‹æˆ–çº¿ç¨‹æ¨¡å‹ï¼ˆApacheå°±é‡‡ç”¨è¿™ç§æ¨¡å‹ï¼‰åœ¨å¤„ç†å¹¶å‘è¿æ¥æ—¶ä¼šä¸ºæ¯ä¸€ä¸ªè¿æ¥å»ºç«‹ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œä¸”åœ¨ç½‘ç»œæˆ–è€…è¾“å…¥/è¾“å‡ºæ“ä½œæ—¶é˜»å¡ï¼Œå°†å¯¼è‡´å†…å­˜å’Œ CPU çš„å¤§é‡æ¶ˆè€—ï¼Œå› ä¸ºæ–°èµ·ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹æˆ–çº¿ç¨‹éœ€è¦å‡†å¤‡æ–°çš„è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒ…æ‹¬å †å’Œæ ˆå†…å­˜çš„åˆ†é…ï¼Œä»¥åŠæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå½“ç„¶ï¼Œè¿™äº›ä¹Ÿä¼šå¯¼è‡´å¤šä½™çš„ CPU å¼€é”€ã€‚æœ€ç»ˆï¼Œä¼šç”±äºè¿‡å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢è€Œå¯¼è‡´æœåŠ¡å™¨æ€§èƒ½å˜å·®ã€‚
      * Nginx çš„æ¶æ„è®¾è®¡æ˜¯é‡‡ç”¨æ¨¡å—åŒ–çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥ã€å•çº¿ç¨‹ä¸”éé˜»å¡
  - [HAProxy](../../ops/HAProxy.md)
* æ—¥ PV å°äº1000ä¸‡ï¼Œç”¨ Nginx å°±å®Œå…¨å¯ä»¥äº†ï¼›å¦‚æœæœºå™¨ä¸å°‘ï¼Œå¯ä»¥ç”¨ DNS è½®è¯¢ï¼ŒLVS æ‰€è€—è´¹çš„æœºå™¨è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼›å¤§å‹ç½‘ç«™æˆ–é‡è¦çš„æœåŠ¡ï¼Œä¸”æœåŠ¡å™¨æ¯”è¾ƒå¤šæ—¶ï¼Œå¯ä»¥è€ƒè™‘ç”¨ LVS
* åˆç†æµè¡Œæ¶æ„æ–¹æ¡ˆï¼šWeb å‰ç«¯é‡‡ç”¨ Nginx/HAProxy+Keepalived ä½œè´Ÿè½½å‡è¡¡å™¨ï¼›åç«¯é‡‡ç”¨ MySQLæ•°æ®åº“ä¸€ä¸»å¤šä»å’Œè¯»å†™åˆ†ç¦»ï¼Œé‡‡ç”¨ LVS+Keepalived çš„æ¶æ„
* Googleäº2016å¹´3æœˆæœ€æ–°å…¬å¸ƒçš„è´Ÿè½½å‡è¡¡Maglev
  - Maglevæ˜¯è°·æ­Œä¸ºè‡ªå·±çš„æ•°æ®ä¸­å¿ƒç ”å‘çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶äº2008å¼€å§‹ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚åœ¨ç¬¬åä¸‰å±Šç½‘ç»œç³»ç»Ÿè®¾è®¡ä¸å®ç°USENIXç ”è®¨ä¼šï¼ˆNSDI '16ï¼‰ä¸Šï¼Œ æ¥è‡ªè°·æ­Œã€åŠ å·å¤§å­¦æ´›æ‰çŸ¶åˆ†æ ¡ã€SpaceXå…¬å¸çš„å·¥ç¨‹å¸ˆä»¬åˆ†äº«äº†è¿™ä¸€å•†ç”¨æœåŠ¡å™¨è´Ÿè½½å‡è¡¡å™¨Maglevçš„è¯¦ç»†ä¿¡æ¯
  - Maglevå®‰è£…åä¸éœ€è¦é¢„çƒ­5ç§’å†…å°±èƒ½åº”ä»˜æ¯ç§’100ä¸‡æ¬¡è¯·æ±‚ä»¤äººæƒŠå¹ä¸å·²ã€‚åœ¨è°·æ­Œçš„æ€§èƒ½åŸºå‡†æµ‹è¯•ä¸­ï¼ŒMaglevå®ä¾‹è¿è¡Œåœ¨ä¸€ä¸ª8æ ¸CPUä¸‹ï¼Œç½‘ç»œååç‡ä¸Šé™ä¸º12M PPS(æ•°æ®åŒ…æ¯ç§’)ï¼Œå¦‚æœMaglevä½¿ç”¨Linuxå†…æ ¸ç½‘ç»œå †æ ˆåˆ™é€Ÿåº¦ä¼šå°äº4M PPS
* å›½å†…äº‘æœåŠ¡å•† UCloud è¿›ä¸€æ­¥è¿­ä»£äº†è´Ÿè½½å‡è¡¡äº§å“----Vortexï¼ŒæˆåŠŸåœ°æå‡äº†å•æœºæ€§èƒ½
  - åœ¨æŠ€æœ¯å®ç°ä¸Šï¼ŒUCloud Vortexä¸Google Maglevé¢‡ä¸ºç›¸ä¼¼ã€‚ä»¥ä¸€å°æ™®é€šæ€§ä»·æ¯”çš„x86 1UæœåŠ¡å™¨ä¸ºä¾‹ï¼ŒVortexå¯ä»¥å®ç°ååé‡è¾¾14M PPS(10G, 64å­—èŠ‚çº¿é€Ÿ)ï¼Œæ–°å»ºè¿æ¥200k CPSä»¥ä¸Šï¼Œå¹¶å‘è¿æ¥æ•°è¾¾åˆ°3000ä¸‡ã€10Gçº¿é€Ÿçš„è½¬å‘

## [keepalived](https://wsgzao.github.io/post/keepalived/)

* è¿è¡Œåœ¨ lvs ä¹‹ä¸Šï¼Œæ˜¯ä¸€ä¸ªç”¨äºåšåŒæœºçƒ­å¤‡ï¼ˆHAï¼‰çš„è½¯ä»¶ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å®ç°çœŸå®æœºçš„æ•…éšœéš”ç¦»åŠè´Ÿè½½å‡è¡¡å™¨é—´çš„å¤±è´¥åˆ‡æ¢ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§
  - keepalived æ˜¯ lvs çš„æ‰©å±•é¡¹ç›®, å› æ­¤å®ƒä»¬ä¹‹é—´å…·å¤‡è‰¯å¥½çš„å…¼å®¹æ€§
  - å¯¹ RealServer çš„å¥åº·æ£€æŸ¥, å®ç°å¯¹å¤±æ•ˆæœºå™¨ / æœåŠ¡çš„æ•…éšœéš”ç¦»
* åŸç†ï¼škeepalived é€šè¿‡é€‰ä¸¾ï¼ˆçœ‹æœåŠ¡å™¨è®¾ç½®çš„æƒé‡ï¼‰æŒ‘é€‰å‡ºä¸€å°çƒ­å¤‡æœåŠ¡å™¨åš MASTER æœºå™¨ï¼ŒMASTER æœºå™¨ä¼šè¢«åˆ†é…åˆ°ä¸€ä¸ªæŒ‡å®šçš„è™šæ‹Ÿ ipï¼Œå¤–éƒ¨ç¨‹åºå¯é€šè¿‡è¯¥ ip è®¿é—®è¿™å°æœåŠ¡å™¨ï¼Œå¦‚æœè¿™å°æœåŠ¡å™¨å‡ºç°æ•…éšœï¼ˆæ–­ç½‘ï¼Œé‡å¯ï¼Œæˆ–è€…æœ¬æœºå™¨ä¸Šçš„ keepalived crash ç­‰ï¼‰ï¼Œkeepalived ä¼šä»å…¶ä»–çš„å¤‡ä»½æœºå™¨ä¸Šé‡é€‰ï¼ˆè¿˜æ˜¯çœ‹æœåŠ¡å™¨è®¾ç½®çš„æƒé‡ï¼‰ä¸€å°æœºå™¨åš MASTER å¹¶åˆ†é…åŒæ ·çš„è™šæ‹Ÿ IPï¼Œå……å½“å‰ä¸€å° MASTER çš„è§’è‰²
* é€‰ä¸¾ç­–ç•¥ï¼šæ ¹æ® VRRP åè®®ï¼Œå®Œå…¨æŒ‰ç…§æƒé‡å¤§å°ï¼Œæƒé‡æœ€å¤§ï¼ˆ0ï½255ï¼‰çš„æ˜¯ MASTER æœºå™¨ï¼Œä¸‹é¢å‡ ç§æƒ…å†µä¼šè§¦å‘é€‰ä¸¾
  - keepalived å¯åŠ¨çš„æ—¶å€™
  - master æœåŠ¡å™¨å‡ºç°æ•…éšœï¼ˆæ–­ç½‘ï¼Œé‡å¯ï¼Œæˆ–è€…æœ¬æœºå™¨ä¸Šçš„ keepalived crash ç­‰ï¼Œè€Œæœ¬æœºå™¨ä¸Šå…¶ä»–åº”ç”¨ç¨‹åº crash ä¸ç®—ï¼‰
  - æœ‰æ–°çš„å¤‡ä»½æœåŠ¡å™¨åŠ å…¥ä¸”æƒé‡æœ€å¤§
* é…ç½®
  - VRRPD é…ç½®åŒ…æ‹¬ä¸‰ä¸ªç±»:
    + VRRP åŒæ­¥ç»„(synchroization group)
    + VRRP å®ä¾‹(VRRP Instance)
    + VRRP è„šæœ¬

```sh
# å…¨å±€å®šä¹‰ (global definition)
global_defs {
   notification_email {
   acassen@firewall.loc
   failover@firewall.loc
   sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL
}
#notification_email: è¡¨ç¤º keepalived åœ¨å‘ç”Ÿè¯¸å¦‚åˆ‡æ¢æ“ä½œæ—¶éœ€è¦å‘é€ email é€šçŸ¥ä»¥åŠ email å‘é€ç»™å“ªäº›é‚®ä»¶åœ°å€é‚®ä»¶åœ°å€å¯ä»¥å¤šä¸ªæ¯è¡Œä¸€ä¸ª
#notification_email_from admin@example.com: è¡¨ç¤ºå‘é€é€šçŸ¥é‚®ä»¶æ—¶é‚®ä»¶æºåœ°å€æ˜¯è°
#smtp_server 127.0.0.1: è¡¨ç¤ºå‘é€ email æ—¶ä½¿ç”¨çš„ smtp æœåŠ¡å™¨åœ°å€è¿™é‡Œå¯ä»¥ç”¨æœ¬åœ°çš„ sendmail æ¥å®ç°
#smtp_connect_timeout 30: è¿æ¥ smtp è¿æ¥è¶…æ—¶æ—¶é—´
#router_id node1: æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸é…ç½®ä¸»æœºå

# é™æ€åœ°å€å’Œè·¯ç”±é…ç½®èŒƒä¾‹
static_ipaddress {
    192.168.1.1/24 brd + dev eth0 scope global
    192.168.1.2/24 brd + dev eth1 scope global
}
static_routes {
    src $SRC_IP to $DST_IP dev $SRC_DEVICE
    src $SRC_IP to $DST_IP via $GW dev $SRC_DEVICE
}
# è¿™é‡Œå®é™…ä¸Šå’Œç³»ç»Ÿé‡Œé¢å‘½ä»¤é…ç½® IP åœ°å€å’Œè·¯ç”±ä¸€æ ·ä¾‹å¦‚
# 192.168.1.1/24 brd + dev eth0 scope global ç›¸å½“äº: ip addr add 192.168.1.1/24 brd + dev eth0 scope global
# å°±æ˜¯ç»™ eth0 é…ç½® IP åœ°å€è·¯ç”±åŒç†, ä¸€èˆ¬è¿™ä¸ªåŒºåŸŸä¸éœ€è¦é…ç½®
# è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ç»™æœåŠ¡å™¨é…ç½®çœŸå®çš„ IP åœ°å€å’Œè·¯ç”±çš„åœ¨å¤æ‚çš„ç¯å¢ƒä¸‹å¯èƒ½éœ€è¦é…ç½®ä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªæ¥é…ç½®æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ vi /etc/sysconfig/network-script/ifcfg-eth1 æ¥é…ç½®åˆ‡è®°è¿™é‡Œå¯ä¸æ˜¯ VIP ä¸è¦ææ··æ·†äº†åˆ‡è®°åˆ‡è®°
```

### ç®—æ³•

* è¡¡é‡æ ‡å‡†
  - æ˜¯å¦æ„è¯†åˆ°ä¸åŒèŠ‚ç‚¹çš„æœåŠ¡èƒ½åŠ›æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚CPUã€å†…å­˜ã€ç½‘ç»œã€åœ°ç†ä½ç½®
  - æ˜¯å¦æ„è¯†åˆ°èŠ‚ç‚¹çš„æœåŠ¡èƒ½åŠ›æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œé«˜é…çš„æœºå™¨ä¹Ÿæœ‰å¯èƒ½ç”±äºä¸€äº›çªå‘åŸå› å¯¼è‡´å¤„ç†é€Ÿåº¦å˜å¾—å¾ˆæ…¢
  - æ˜¯å¦è€ƒè™‘å°†åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæˆ–è€…è¯´åŒæ ·çš„è¯·æ±‚åˆ†å‘åˆ°åŒä¸€ä¸ªå¤„ç†èŠ‚ç‚¹ï¼Œè¿™å¯¹äºâ€œæœ‰çŠ¶æ€â€çš„æœåŠ¡éå¸¸é‡è¦ï¼Œæ¯”å¦‚sessionï¼Œæ¯”å¦‚åˆ†å¸ƒå¼å­˜å‚¨
  - è°æ¥è´Ÿè´£è´Ÿè½½å‡è¡¡ï¼Œå³è°å……å½“è´Ÿè½½å‡è¡¡å™¨ï¼ˆload balancerï¼‰ï¼Œbalanceræœ¬èº«æ˜¯å¦ä¼šæˆä¸ºç“¶é¢ˆ
* æ–¹æ¡ˆ
  - è½®è¯¢ç®—æ³•ï¼ˆround-robinï¼‰ï¼šæä¾›åŒè´¨æœåŠ¡çš„èŠ‚ç‚¹é€ä¸ªå¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™æ ·èƒ½åšåˆ°ç»å¯¹çš„å‡è¡¡.
    - æ²¡æœ‰è€ƒè™‘åˆ°èŠ‚ç‚¹çš„å·®å¼‚
  - åŠ æƒè½®è¯¢ç®—æ³•ï¼ˆweight round-robinï¼‰:åœ¨è½®è®­ç®—æ³•çš„åŸºç¡€ä¸Šï¼Œè€ƒè™‘åˆ°æœºå™¨çš„å·®å¼‚æ€§ï¼Œåˆ†é…ç»™æœºå™¨ä¸åŒçš„æƒé‡.ä¾èµ–äºè¯·æ±‚çš„ç±»å‹ï¼Œæ¯”å¦‚è®¡ç®—å¯†é›†å‹ï¼Œé‚£å°±è€ƒè™‘CPUã€å†…å­˜ï¼›å¦‚æœæ˜¯IOå¯†é›†å‹ï¼Œé‚£å°±è€ƒè™‘ç£ç›˜æ€§èƒ½
  - éšæœºç®—æ³•ï¼ˆrandomï¼‰:éšæœºé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æœåŠ¡ï¼ŒæŒ‰ç…§æ¦‚ç‡ï¼Œåªè¦è¯·æ±‚æ•°é‡è¶³å¤Ÿå¤šï¼Œé‚£ä¹ˆä¹Ÿèƒ½è¾¾åˆ°ç»å¯¹å‡è¡¡çš„æ•ˆæœ
  - åŠ æƒéšæœºç®—æ³•ï¼ˆrandomï¼‰:åœ¨éšæœºçš„æ—¶å€™å¼•å…¥ä¸åŒèŠ‚ç‚¹çš„æƒé‡
  - å“ˆå¸Œæ³•ï¼ˆhashï¼‰ï¼šæ ¹æ®å®¢æˆ·ç«¯çš„IPï¼Œæˆ–è€…è¯·æ±‚çš„â€œKeyâ€ï¼Œè®¡ç®—å‡ºä¸€ä¸ªhashå€¼ï¼Œç„¶åå¯¹èŠ‚ç‚¹æ•°ç›®å–æ¨¡ã€‚å¥½å¤„å°±æ˜¯ï¼ŒåŒä¸€ä¸ªè¯·æ±‚èƒ½å¤Ÿåˆ†é…åˆ°åŒæ ·çš„æœåŠ¡èŠ‚ç‚¹ï¼Œè¿™å¯¹äºâ€œæœ‰çŠ¶æ€â€çš„æœåŠ¡å¾ˆæœ‰å¿…è¦
    + å½“èŠ‚ç‚¹çš„æ•°ç›®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè¯·æ±‚ä¼šå¤§æ¦‚ç‡åˆ†é…åˆ°å…¶ä»–çš„èŠ‚ç‚¹ï¼Œå¼•å‘åˆ°ä¸€ç³»åˆ—é—®é¢˜
  - ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼šä¸€ä¸ªç‰©ç†èŠ‚ç‚¹ä¸å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹æ˜ å°„ï¼Œåœ¨hashçš„æ—¶å€™ï¼Œä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹æ•°ç›®è€Œä¸æ˜¯ç‰©ç†èŠ‚ç‚¹æ•°ç›®ã€‚å½“ç‰©ç†èŠ‚ç‚¹å˜åŒ–çš„æ—¶å€™ï¼Œè™šæ‹ŸèŠ‚ç‚¹çš„æ•°ç›®æ— éœ€å˜åŒ–ï¼Œåªæ¶‰åŠåˆ°è™šæ‹ŸèŠ‚ç‚¹çš„é‡æ–°åˆ†é…ã€‚è€Œä¸”ï¼Œè°ƒæ•´æ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹æ•°ç›®ï¼Œä¹Ÿå°±ç›¸å½“äºæ¯ä¸ªç‰©ç†èŠ‚ç‚¹æœ‰ä¸åŒçš„æƒé‡
  - æœ€å°‘è¿æ¥ç®—æ³•ï¼ˆleast connectionï¼‰ï¼šæ ¹æ®èŠ‚ç‚¹çš„çœŸå®è´Ÿè½½ï¼ŒåŠ¨æ€åœ°è°ƒæ•´èŠ‚ç‚¹çš„æƒé‡å°±éå¸¸é‡è¦ã€‚å½“ç„¶ï¼Œè¦è·å¾—æ¥èŠ‚ç‚¹çš„çœŸå®è´Ÿè½½ä¹Ÿä¸æ˜¯ä¸€æ¦‚è€Œè®ºçš„äº‹æƒ…ï¼Œå¦‚ä½•å®šä¹‰è´Ÿè½½ï¼Œè´Ÿè½½çš„æ”¶é›†æ˜¯å¦åŠæ—¶
    + æ¯ä¸ªèŠ‚ç‚¹å½“å‰çš„è¿æ¥æ•°ç›®æ˜¯ä¸€ä¸ªéå¸¸å®¹æ˜“æ”¶é›†çš„æŒ‡æ ‡ï¼Œå› æ­¤lease connectionæ˜¯æœ€å¸¸è¢«äººæåˆ°çš„ç®—æ³•
  - å“åº”ç­–ç•¥ï¼šå°†è¯·æ±‚è½¬å‘ç»™å½“å‰æ—¶åˆ»å“åº”æœ€å¿«çš„åç«¯æœåŠ¡å™¨
    + ä¸åœçš„å»ç»Ÿè®¡æ¯ä¸€å°åç«¯æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å¤„ç†é€Ÿåº¦äº†

```python
SERVER_LIST = [
      '10.246.10.1',
     '10.246.10.2',
     '10.246.10.3',
 ]
 def round_robin(server_lst, cur = [0]):
     length = len(server_lst)
     ret = server_lst[cur[0] % length]
     cur[0] = (cur[0] + 1) % length
     return ret

 WEIGHT_SERVER_LIST = {
     '10.246.10.1': 1,
     '10.246.10.2': 3,
     '10.246.10.3': 2,
 }
 def weight_round_robin(servers, cur = [0]):
     weighted_list = []
     for k, v in servers.iteritems():
         weighted_list.extend([k] * v)

     length = len(weighted_list)
     ret = weighted_list[cur[0] % length]
     cur[0] = (cur[0] + 1) % length
     return ret

def random_choose(server_lst):
    import random
    random.seed()
    return random.choice(server_lst)

def weight_random_choose(servers):
    import random
    random.seed()
    weighted_list = []
    for k, v in servers.iteritems():
        weighted_list.extend([k] * v)
    return random.choice(weighted_list)

# å¦‚æœèŠ‚ç‚¹åˆ—è¡¨ä»¥åŠæƒé‡å˜åŒ–ä¸å¤§ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥å¯¹æ‰€æœ‰èŠ‚ç‚¹å½’ä¸€åŒ–ï¼Œç„¶åæŒ‰æ¦‚ç‡åŒºé—´é€‰æ‹©
def normalize_servers(servers):
    normalized_servers = {}
    total = sum(servers.values())
    cur_sum = 0
    for k, v in servers.iteritems():
        normalized_servers[k] = 1.0 * (cur_sum + v) / total
        cur_sum += v
    return normalized_servers

def weight_random_choose_ex(normalized_servers):
    import random, operator
    random.seed()
    rand = random.random()
    for k, v in sorted(normalized_servers.iteritems(), key = operator.itemgetter(1)):
        if v >= rand:
            return k
    else:
        assert False, 'Error normalized_servers with rand %s ' % rand

def hash_choose(request_info, server_lst):
     hashed_request_info = hash(request_info)
     return server_lst[hashed_request_info % len(server_lst)]
```

## [å¥å£®ç³»ç»Ÿ](https://mp.weixin.qq.com/s/uYze9g54jd9DdmB92lX15w)

* è‰¯å¥½çš„è½¯ä»¶ç³»ç»Ÿæ¶æ„è®¾è®¡
  - ç³»ç»Ÿæ¶æ„ï¼šç½‘ç»œæ‹“æ‰‘æ˜¯ä»€ä¹ˆã€ç”¨ä»€ä¹ˆå­˜å‚¨ã€ç”¨ä»€ä¹ˆç¼“å­˜ã€æ•´ä¸ªæ•°æ®æµå‘æ˜¯å¦‚ä½•ã€é‚£ä¸ªæ ¸å¿ƒæœåŠ¡é‡‡ç”¨é‚£ä¸ªå¼€æºè½¯ä»¶æ”¯æ’‘ã€ç”¨ä»€ä¹ˆç¼–ç¨‹è¯­è¨€æ¥æ„å»ºæ•´ä¸ªè½¯ä»¶è¿æ¥å„ä¸ªæœåŠ¡ã€æ•´ä¸ªç³»ç»Ÿå¦‚ä½•åˆ†å±‚ï¼Ÿ
    + æ¶æ„å¸ˆè§†è§’æ˜¯ä¸ä»…æ˜¯å®Œæˆæ•´ä¸ªé¡¹ç›®ï¼Œæ›´å¤šéœ€è¦æ€è€ƒæ•´ä¸ªæ¶æ„æ˜¯å¦æ¸…æ™°ã€æ˜¯å¦å¯ç»´æŠ¤ã€æ˜¯å¦å¯æ‰©å±•ã€å¯é æ€§ç¨³å®šæ€§å¦‚ä½•ï¼Œæ•´ä¸ªæŠ€æœ¯æ¡†æ¶å’Œå„ç§ä½“ç³»é€‰å‹æ˜¯å¦æ–¹ä¾¿å®¹æ˜“å¼€å‘ç»´æŠ¤ï¼›æ•´ä¸ªæ€è€ƒç»´åº¦å’Œè§†è§’æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚ç¨‹åºå‘˜è§†è§’æ˜¯æ‰§è¡Œå±‚é¢å…·ä½“ç¼–ç çš„è§†è§’ï¼Œæ¶æ„å¸ˆè§†è§’æ˜¯è®¾è®¡å¸ˆçš„è§†è§’ï¼Œä¼šæ›´å®è§‚ï¼Œæƒ³çš„æ›´è¿œã€‚
    + æœåŠ¡æ¶æ„é“¾è·¯è¦æ¸…æ™°,æ¯ä¸€å±‚å„å¸å…¶èŒ:æ¥å…¥å±‚ï¼ˆç½‘å…³ã€è´Ÿè½½å‡è¡¡ï¼‰ã€åº”ç”¨å±‚ï¼ˆPHPç¨‹åºç­‰ï¼‰ã€æœåŠ¡å±‚ï¼ˆå¾®æœåŠ¡æ¥å£ç­‰ï¼‰ã€å­˜å‚¨å±‚ï¼ˆDBã€ç¼“å­˜ã€æ£€ç´¢ESç­‰ï¼‰ã€ç¦»çº¿è®¡ç®—å±‚ï¼ˆä¸ä¸€å®šåŒ…å«ï¼Œä¸€èˆ¬ä¼šä»¥æœåŠ¡å±‚æˆ–å­˜å‚¨å±‚å‡ºç°ï¼‰
    + æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦è€ƒè™‘ç¾å¤‡æˆ–åˆ†å¸ƒå¼ï¼Œä¸èƒ½å‡ºç°å•ç‚¹æ¶æ„ï¼ˆæŒç»­è¿›åŒ–ï¼‰
    + æ¯ä¸ªæœåŠ¡éƒ½å¿…é¡»è€ƒè™‘æœ€ä¼˜çš„æŠ€æœ¯é€‰å‹ï¼ˆæœ€ä½³å®è·µï¼‰
    + æœåŠ¡å¿…é¡»è€ƒè™‘ç†”æ–­é™çº§æ–¹æ¡ˆ:æŠŠæœåŠ¡åˆ†å±‚ï¼Œåˆ‡åˆ†ä¸€çº§æ ¸å¿ƒæœåŠ¡ã€äºŒçº§é‡è¦æœåŠ¡ã€ä¸‰çº§å¯ç†”æ–­æœåŠ¡ç­‰ç­‰åŒºåˆ†ï¼Œè¿˜éœ€è¦æœ‰å¯¹åº”çš„é¢„æ¡ˆ
    + è¿ç»´éƒ¨ç½²å›æ»šç›‘æ§ç­‰ç³»ç»Ÿéœ€è¦å¿«é€Ÿé«˜æ•ˆ
    + ç¼–å†™çš„æ¥å£å’Œå‰åç«¯è”åˆè°ƒè¯•è¦æ–¹ä¾¿å¿«æ·
      * å–„äºä½¿ç”¨å¥½çš„å·¥å…·ï¼ˆæ¯”å¦‚Filder/Postman/SoapUIç­‰ï¼‰ï¼Œå¹¶ä¸”å¯¹åº”æ¥å£æ–‡æ¡£æ¸…æ™°ï¼Œæœ€å¥½æ˜¯èƒ½å¤Ÿé€šè¿‡ä¸€äº›å·¥å…·ç”Ÿæˆå¥½APIæ–‡æ¡£ï¼ˆAPIJson/Swagger/Eolinkerï¼‰
    + è®©æ•´ä¸ªç³»ç»Ÿå®Œå…¨å¯ç›‘æ§å¯è¿½è¸ª
      * å¯¹åº”çš„traceç³»ç»Ÿï¼ˆåŒ…å«trace_idï¼‰ï¼ŒæŠŠä»æ¥å…¥å±‚ã€åº”ç”¨å±‚ã€æœåŠ¡å±‚ã€å­˜å‚¨å±‚ç­‰éƒ½èƒ½å¤Ÿä¸²è”èµ·æ¥ï¼Œæ¯ä¸ªç¯èŠ‚å‡ºç°çš„é—®é¢˜éƒ½å¯è¿½è¸ªï¼Œå¿«é€Ÿå®šä½é—®é¢˜æ‰¾åˆ°bugæˆ–è€…æœåŠ¡ç“¶é¢ˆçŸ­æ¿ï¼›ä¹Ÿèƒ½å¤Ÿäº†è§£æ•´ä¸ªç³»ç»Ÿè¿è¡Œæƒ…å†µå’Œç»†èŠ‚ã€‚ï¼ˆæ¯”å¦‚ä¸€äº›æ—¥å¿—é‡‡é›†ç³»ç»Ÿ OpenResty/Filebeat/Flume/LogStash/ELKï¼‰
    + ç³»ç»Ÿä¸­çš„æ¯ä¸ªç»†èŠ‚éƒ½æ˜¯éœ€è¦å¯ä»¥é‡åŒ–çš„ï¼Œä¸èƒ½æ˜¯æ¨¡ç³Šä¸æ˜ç¡®çš„
      * æ¯”å¦‚å•ä¸ªæœåŠ¡çš„QPSèƒ½åŠ›ï¼ˆé¢„è®¡æµé‡éœ€è¦å¤šå°‘æœåŠ¡å™¨)ã€å¹¶å‘è¿æ¥æ•°ï¼ˆç³»ç»Ÿè®¾ç½®ã€ç³»ç»Ÿæ‰¿è½½è¿æ¥ï¼‰ã€å•ä¸ªè¿›ç¨‹å†…å­˜å ç”¨ã€çº¿ç¨‹æ•°ã€ç½‘ç»œä¹‹é—´è®¿é—®å»¶è¿Ÿæ—¶é—´ï¼ˆæœåŠ¡å™¨ä¹‹é—´å»¶è¿Ÿã€æœºæˆ¿åˆ°æœºæˆ¿çš„å»¶è¿Ÿã€å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„å»¶è¿Ÿï¼‰ã€å„ç§ç¡¬ä»¶æ€§èƒ½å‚æ•°ï¼ˆç£ç›˜IOã€æœåŠ¡å™¨ç½‘å¡ååé‡ç­‰ï¼‰ã€‚
    + è®©åº”ç”¨æ— çŠ¶æ€åŒ–ã€å®¹å™¨åŒ–ã€å¾®æœåŠ¡åŒ–
      * å»ä¸­å¿ƒåŒ–ã€åŸå­åŒ–ã€è¯­è¨€æ— ä¾èµ–ã€ç‹¬ç«‹è‡ªæ²»ã€å¿«é€Ÿç»„åˆã€è‡ªåŠ¨éƒ¨ç½²ã€å¿«é€Ÿæ‰©å®¹ï¼Œé‡‡ç”¨å¾®æœåŠ¡+å®¹å™¨åŒ–æ¥è§£å†³ã€‚
      * é˜»ç¢æ¨ªå‘æ‰©å±•çš„æœ€å¤§çš„é˜»ç¢å°±æ˜¯â€œæœ‰çŠ¶æ€â€ï¼Œæœ‰çŠ¶æ€å°±æ˜¯æœ‰å¾ˆå¤šåº”ç”¨ä¼šå­˜å‚¨ç§æœ‰çš„ä¸œè¥¿åœ¨åº”ç”¨è¿è¡Œçš„å†…å­˜ã€ç£ç›˜ä¸­ï¼Œè€Œä¸æ˜¯é‡‡ç”¨é€šç”¨çš„åˆ†å¸ƒå¼ç¼“å­˜ã€åˆ†å¸ƒå¼å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå¯¼è‡´åº”ç”¨åœ¨å®¹å™¨åŒ–çš„æƒ…å†µä¸‹æ— æ³•å¿«é€Ÿæ‰©å®¹ï¼Œæ‰€ä»¥åº”ç”¨éœ€è¦â€œå»æœ‰çŠ¶æ€åŒ–â€ï¼Œè®©åº”ç”¨å…¨éƒ¨â€œæ— çŠ¶æ€åŒ–â€ã€‚
      * å¾®æœåŠ¡åŒ–çš„é€»è¾‘æ˜¯è®©çš„æ¯ä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œæ¯”å¦‚è¯´ç”¨æˆ·ä¸­å¿ƒç³»ç»Ÿå¯¹å¤–æä¾›çš„ä¸æ˜¯ä»£ç çº§åˆ«çš„APIï¼Œè€Œæ˜¯åŸºäºRESTfuæˆ–è€…gRPCåè®®çš„è¿œç¨‹ä¸€ä¸ªæœåŠ¡å¤šä¸ªæ¥å£ï¼Œè¿™ä¸ªæœåŠ¡æˆ–æ¥å£æ ¸å¿ƒç”¨æ¥è§£å†³æŠŠæ•´ä¸ªç”¨æˆ·ä¸­å¿ƒæœåŠ¡å˜æˆç‹¬ç«‹æœåŠ¡ï¼Œè°éƒ½å¯ä»¥è°ƒç”¨ï¼Œå¹¶ä¸”è¿™ä¸ªæœåŠ¡æœ¬èº«ä¸ä¼šå¯¹å†…å¤–éƒ¨æœ‰å¤ªå¤šçš„è€¦åˆå’Œä¾èµ–ï¼Œå¯¹å¤–æš´éœ²çš„ä¹Ÿåªæ˜¯ä¸€ä¸ªä¸ªç‹¬ç«‹çš„è¿œç¨‹æ¥å£è€Œå·²ã€‚
      * å°½é‡æŠŠå…³é”®æœåŠ¡å¯ä»¥æŠ½è±¡æˆä¸ºä¸€ä¸ªä¸ªå¾®æœåŠ¡ï¼Œè™½ç„¶å¾®æœåŠ¡ä¼šå¢åŠ ç½‘ç»œè°ƒç”¨çš„æˆæœ¬ï¼Œä½†æ˜¯æ¯ä¸ªæœåŠ¡ä¹‹é—´çš„äº’ç›¸ä¾èµ–æ€§ç­‰ç­‰éƒ½é™ä½äº†ï¼Œå¹¶ä¸”é€šè¿‡å®¹å™¨æŠ€æœ¯ï¼Œå¯ä»¥æŠŠå•ç»™å¾®æœåŠ¡å¿«é€Ÿçš„æ¨ªå‘æ‰©å±•éƒ¨ç½²å¢åŠ æ€§èƒ½ï¼Œè™½ç„¶ä¸æ˜¯é“¶å¼¹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„è§£å†³æ–¹æ¡ˆã€‚
      * åŸºäºå®¹å™¨çš„å¾®æœåŠ¡åŒ–ä»¥åï¼Œæ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿä»å¼€å‘ã€æµ‹è¯•ã€å‘å¸ƒã€çº¿ä¸Šè¿ç»´ã€æ‰©å±• ç­‰å¤šä¸ªæ–¹é¢éƒ½æ¯”è¾ƒç®€å•äº†ï¼Œå¯ä»¥å®Œå…¨ä¾èµ–äºå„ç§è‡ªåŠ¨åŠè‡ªåŠ¨åŒ–å·¥å…·å®Œæˆï¼Œæ•´ä¸ªäººå·¥å¹²é¢„å‚åŠ çš„æˆåˆ†å¤§å¹…å‡å°‘ã€‚
  - ç³»ç»Ÿè®¾è®¡ï¼šé‡‡ç”¨ä»€ä¹ˆç¼–ç¨‹è¯­è¨€ã€ç¼–ç¨‹è¯­è¨€ä½¿ç”¨ä»€ä¹ˆç¼–ç¨‹æ¡†æ¶æˆ–ä¸­é—´ä»¶ã€ä½¿ç”¨ä»€ä¹ˆè®¾è®¡æ¨¡å¼æ¥æ„å»ºä»£ç ã€ä¸­é—´ä»£ç å¦‚ä½•åˆ†å±‚ï¼Ÿ
  - ç¼–ç¨‹å®ç°ï¼šç¼–ç¨‹è¯­è¨€ç”¨ä»€ä¹ˆæ¡†æ¶ã€æœ‰ä»€ä¹ˆè§„èŒƒã€ç¼–ç¨‹è¯­è¨€éœ€è¦æ³¨æ„å“ªäº›ç»†èŠ‚ã€æœ‰å“ªäº›æŠ€å·§ã€é‚£äº›ç¼–ç¨‹åŸåˆ™ï¼Ÿ
* ç¼–ç¨‹æœ€ä½³å®è·µ
  - å……åˆ†ç†è§£ä¸šåŠ¡éœ€æ±‚:ä¿è¯ç†è§£ä¸šåŠ¡åï¼Œæ•´ä¸ªç¨‹åºè®¾è®¡ç¬¦åˆéœ€æ±‚æˆ–è€…æœªæ¥å‡ ä¸ªæœˆå¯ä»¥æ‰©å±•ï¼Œæ—¢ä¸åšè¿‡åº¦è®¾è®¡ï¼Œä¹Ÿä¸åšå„ç§ä¸´æ—¶ç¡¬ç¼–ç ã€‚
  - ä»£ç æ ¸å¿ƒåŸåˆ™ï¼šKISSï¼ˆKeep it simple,stupidï¼‰:æ¥è‡ªäºUnixç¼–ç¨‹è‰ºæœ¯ï¼Œä½ çš„ä¸œè¥¿å¿…é¡»è¶³å¤Ÿç®€å•è¶³å¤Ÿæ„šè ¢ï¼Œå¥½å¤„éå¸¸å¤šï¼Œæ¯”å¦‚å®¹æ˜“è¯»æ‡‚ï¼Œå®¹æ˜“ç»´æŠ¤äº¤æ¥ï¼Œå‡ºé—®é¢˜å®¹æ˜“è¿½æŸ¥ç­‰ç­‰ã€‚
  - éµå®ˆç¼–ç è§„èŒƒï¼Œä»£ç è®¾è®¡é€šç”¨çµæ´»:å­¦ä¼šé€šè¿‡ç”¨å‡½æ•°å’Œç±»è¿›è¡Œå°è£…ï¼ˆé«˜å†…èšã€ä½è€¦åˆï¼‰ã€å¦‚ä½•å®šä¹‰å‡½æ•°ï¼Œç¼©è¿›æ–¹å¼ï¼Œè¿”å›å‚æ•°å®šä¹‰ï¼Œæ³¨é‡Šå¦‚ä½•å®šä¹‰ã€å‡å°‘ç¡¬ç¼–ç ï¼ˆé€šè¿‡é…ç½®ã€æ•°æ®åº“å­˜å‚¨å˜é‡æ¥è§£å†³ï¼‰
  - è®¾è®¡æ¨¡å¼å’Œä»£ç ç»“æ„éœ€è¦æ¸…æ™°:æ¯”å¦‚å¸¸è§„ä½¿ç”¨çš„MVCè®¾è®¡æ¨¡å¼ï¼Œä¸ºäº†å°±æ˜¯æŠŠå„ä¸ªå±‚æ¬¡ä»£ç åŒºåˆ†å¼€ã€‚ï¼ˆMå¹²å¥½æ•°æ®è¯»å–æˆ–è€…æ¥å£è®¿é—®çš„äº‹å„¿ï¼ŒCå¹²å¥½å˜é‡æ”¶å‘åŸºæœ¬æ•™ç ”ï¼ŒVå¹²å¥½æ¨¡æ¿æ¸²æŸ“æˆ–è€…apiæ¥å£è¾“å‡ºï¼›Må¯ä»¥æ‹†åˆ†æˆä¸ºï¼šDAOæ•°æ®è®¿é—®å±‚å’ŒServiceæŸæœåŠ¡æä¾›å±‚ï¼‰
  - ç¨‹åºä¸­ä¸€å®šè¦å†™æ—¥å¿—ï¼Œä»£ç æ—¥å¿—è¦è®°å½•æ¸…æ™°:ï¼ˆInfoã€Debugã€Waringã€Traceç­‰ç­‰ï¼Œè°ƒç”¨ç»Ÿä¸€çš„æ—¥å¿—åº“ï¼Œä¸è¦å®³æ€•å¤šå†™æ—¥å¿—ï¼‰
  - ç¨³å¥æ€§ç¼–ç¨‹å°æŠ€å·§
    + ä»£ç é‡Œå°½é‡ä¸è¦ä½¿ç”¨else
    + æ‰€æœ‰çš„å¾ªç¯å¿…é¡»æœ‰ç»“æŸæ¡ä»¶æˆ–çº¦å®šï¼Œå¹¶ä¸”ä¸ä¼šä¸å¯æ§
    + ä¸è¦ç”³è¯·è¶…çº§å¤§çš„å˜é‡æˆ–å†…å­˜é€ æˆèµ„æºæµªè´¹
    + æ— è®ºé™æ€è¿˜æ˜¯åŠ¨æ€è¯­è¨€ï¼Œå†…å­˜æˆ–å¯¹è±¡ä½¿ç”¨å®Œä»¥åå°½é‡åŠæ—¶é‡Šæ”¾
    + è¾“å…¥æ•°æ®åŠ¡å¿…è¦æ ¡éªŒï¼Œç”¨æˆ·è¾“å…¥æ•°æ®å¿…é¡»ä¸å¯ä¿¡ã€‚
    + å°½é‡ä¸è¦ä½¿ç”¨å¼‚æ­¥å›è°ƒçš„æ–¹å¼
  - æ‰€æœ‰å†…å¤–éƒ¨è®¿é—®éƒ½å¿…é¡»æœ‰è¶…æ—¶æœºåˆ¶ï¼šä¿è¯ä¸è¿é”ååº”é›ªå´©
    + è¿æ¥è¶…æ—¶ã€è¯»è¶…æ—¶ã€å†™è¶…æ—¶ã€é€šç”¨è¶…æ—¶
    + ä¸€èˆ¬è¶…æ—¶ç²’åº¦å¤§éƒ¨åˆ†éƒ½æ˜¯ç§’ä¸ºå•ä½ï¼Œå¯¹äºæ—¶é—´æ•æ„Ÿä¸šåŠ¡éƒ½æ˜¯æ¯«ç§’ä¸ºå•ä½ï¼Œå»ºè®®ä»¥æ¯«ç§’(ms)ä¸ºå•ä½çš„è¶…æ—¶æ›´å¯é ï¼Œä½†æ˜¯å¾ˆå¤šæœåŠ¡æ²¡æœ‰æä¾›è¿™ç±»è¶…æ—¶æ“ä½œæ¥å£ã€‚
  - æˆç†Ÿç¨³å®šçš„SQLè¯­è¨€ä½¿ç”¨ä¹ æƒ¯å’ŒæŠ€å·§
    + æ‰€æœ‰SQLè¯­å¥éƒ½å¿…é¡»æœ‰çº¦æŸæ¡ä»¶
    + SQLæŸ¥è¯¢é‡ŒæŠ½å–å­—æ®µä¸­æ˜ç¡®éœ€è¦æŠ½å–çš„å­—æ®µ
    + ç†ŸçŸ¥å„ç§SQLæ“ä½œçš„æœ€ä½³å®è·µæŠ€å·§ï¼ŒåŒ…æ‹¬ä¸é™äºï¼šå¸¸ç”¨å­—æ®µå»ºç«‹ç´¢å¼•ï¼ˆå•è¡¨ä¸è¶…è¿‡6ä¸ªï¼‰ã€å°½é‡å‡å°‘ORã€å°½é‡å‡å°‘è¿è¡¨æŸ¥è¯¢ã€å°½é‡ä¸è¦SQLè¯­å¥ä¸­ä½¿ç”¨å‡½æ•°ï¼ˆdatetimeä¹‹ç±»ï¼‰ã€ä½¿ç”¨existsä»£æ›¿inã€ä½¿ç”¨explainè§‚å¯ŸSQLè¿è¡Œæƒ…å†µç­‰ç­‰ã€‚
  - å¼€å‘ä¸­æ—¶åˆ»è¦è®°å¾—ä»£ç å®‰å…¨
    + SQLæ³¨å…¥
    + XSS
    + CSRF
    + URLè·³è½¬æ¼æ´
    + æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ¼æ´
  - è°ƒä¼˜åç«¯æœåŠ¡çš„æ€§èƒ½é…ç½®
* å¥å£®ä»£ç é€šç”¨åŸåˆ™
  - æ¨¡å—æ€§åŸåˆ™ï¼šå†™ç®€å•çš„ï¼Œé€šè¿‡å¹²å‡€çš„æ¥å£å¯è¢«è¿æ¥çš„éƒ¨ä»¶ã€‚ï¼ˆæ¯”å¦‚ç±»ã€å‡½æ•°ï¼Œé«˜å†…èšä½è€¦åˆï¼‰
  - æ¸…æ¥šåŸåˆ™ï¼šæ¸…æ¥šè¦æ¯”å°èªæ˜å¥½ã€‚ï¼ˆä»£ç ä¸­æ³¨é‡Šéœ€è¦æ¸…æ™°æ˜ç¡®ï¼Œæœ€å¥½æœ‰å†å²è¿­ä»£ï¼Œä¸è¦è€å°èªæ˜ï¼Œæˆ–è€…ç”¨ä¸€äº›å¥‡æ€ªçš„å®ç°ç®—æ³•å¹¶ä¸”æ²¡æ³¨é‡Šï¼‰
  - åˆå¹¶åŸåˆ™ï¼šè®¾è®¡èƒ½è¢«å…¶å®ƒç¨‹åºè¿æ¥çš„ç¨‹åºã€‚ï¼ˆæä¾›å¥½è¾“å…¥è¾“å‡ºå‚æ•°ï¼Œæˆ–è€…è®¾è®¡å¥½çš„openapiï¼Œå°½é‡è®©ç¨‹åºå¯ä»¥å¤ç”¨ï¼‰
  - ç®€å•åŸåˆ™ï¼šè®¾è®¡è¦ç®€å•ï¼›åªæœ‰å½“ä½ éœ€è¦çš„æ—¶å€™ï¼Œå¢åŠ å¤æ‚æ€§ã€‚ï¼ˆæ¯ä¸ªå‡½æ•°ç±»è¦ç®€å•æ˜ç¡®ï¼Œä¸è¦å¤ªå†—é•¿ï¼‰
  - å¥å£®æ€§åŸåˆ™ï¼šå¥å£®æ€§æ˜¯é€æ˜å’Œç®€å•çš„è¿½éšè€…ã€‚ï¼ˆé€æ˜+ç®€å•äº†ï¼Œå¥å£®å°±æ¥äº†ï¼‰
  - æ²‰é»˜è¡¥æ•‘åŸåˆ™ï¼šå½“ä¸€ä¸ªç¨‹åºæ²¡æœ‰å¼‚å¸¸çš„æ—¶å€™å°±åªæ˜¯è®°å½•ï¼Œå‡å°‘å¹²æ‰°æˆ–è€…å•¥éƒ½ä¸è¯´ï¼›å½“ä½ å¿…é¡»å¤±è´¥çš„æ—¶å€™ï¼Œå°½å¯èƒ½å¿«çš„åµé—¹åœ°å¤±è´¥ã€‚ï¼ˆå¤±è´¥äº†ä¸€å®šè¦æ˜ç¡®æ¸…æ™°çš„æç¤ºå½¢å¼ï¼ŒåŒ…æ‹¬é”™è¯¯ä»£ç ï¼Œé”™è¯¯åŸå› çš„ä¿¡æ¯ï¼Œä¸è¦æ‚„æ— å£°æ¯ï¼‰
  - ç»æµåŸåˆ™ï¼šç¨‹åºå‘˜çš„æ—¶é—´æ˜¯å®è´µçš„ï¼›ä¼˜å…ˆæœºå™¨æ—¶é—´èŠ‚çº¦å®ƒã€‚ï¼ˆèƒ½å¤Ÿç”¨å†…å­˜+CPUæå®šï¼Œä¸è¦è¿‡å¤šçº ç»“åœ¨ç®—æ³•ä¸Šï¼‰
  - äº§ç”ŸåŸåˆ™ï¼šé¿å…æ‰‹å·¥å †ç Œï¼›å½“ä½ å¯èƒ½çš„æ—¶å€™ï¼Œç¼–å†™å¯ä»¥å†™ç¨‹åºçš„ç¨‹åºã€‚ï¼ˆç”¨ç¨‹åºæ¥å¸®ä½ å®ç°é‡å¤çš„äº‹å„¿ï¼‰
  - ä¼˜åŒ–åŸåˆ™ï¼šåœ¨é›•ç¢ä¹‹å‰å…ˆæœ‰åŸå‹ï¼›åœ¨ä½ ä¼˜åŒ–å®ƒä¹‹å‰ï¼Œå…ˆè®©ä»–å¯ä»¥è¿è¡Œã€‚ï¼ˆå…ˆå®Œæˆï¼Œå†å®Œç¾ï¼‰
  - å¯æ‰©å±•åŸåˆ™ï¼šä¸ºå°†æ¥åšè®¾è®¡ï¼Œå› ä¸ºå®ƒå¯èƒ½æ¯”ä½ è®¤ä¸ºæ¥çš„è¦å¿«ã€‚ï¼ˆå°½é‡è€ƒè™‘ä½ è¿™ä¸ªä»£ç 2ï¼Œ3ï¼Œ5å¹´åæ‰ä¼šé‡æ„ï¼Œä¸ºæœªæ¥è´Ÿè´£ï¼‰
* ä¸ªäººä¸“ä¸šè½¯ç´ è´¨
  - ç»†å¿ƒï¼šå†™å®Œä»£ç éƒ½éœ€è¦é‡æ–°Reviewä¸€éï¼Œå˜é‡åæ˜¯å¦æ­£ç¡®ï¼Œå˜é‡æ˜¯å¦åˆå§‹åŒ–ï¼Œæ¯ä¸ªSQLè¯­å¥æ˜¯å¦æ€§èƒ½é«˜è¶…æˆ–è€…ä¸ä¼šå¯¼è‡´è¶…æ—¶æ­»é”ï¼›
  - è®¤çœŸï¼šæ¯ä¸ªå‡½æ•°æ˜¯å¦éƒ½è‡ªå·±æ ¡éªŒè¿‡è¾“å…¥è¾“å‡ºæ˜¯æ»¡è¶³é¢„æœŸçš„ï¼›æ¡ä»¶å…è®¸ï¼Œæ˜¯å¦æ ¸å¿ƒå‡½æ•°éƒ½å…·å¤‡å•å…ƒæµ‹è¯•ä»£ç ï¼›
  - è°¨æ…ï¼šä¸è¦ç›¸ä¿¡ä»»ä½•å¤–éƒ¨è¾“å…¥çš„æ•°æ®ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€æ–‡ä»¶ã€ç¼“å­˜ã€ç”¨æˆ·HTTPæäº¤å„ç§å˜é‡ï¼Œéƒ½éœ€è¦ä¸¥æ ¼æ ¡éªŒå’Œè¿‡æ»¤ã€‚
  - ç²¾è¿›ï¼šä¸è¦æƒ§æ€•åˆ«äººè¯´ä½ ä»£ç çƒ‚ï¼Œå¿…é¡»èƒ½å¤ŸæŒç»­è¢«äººåæ§½ä¸‹ä¼˜åŒ–ï¼Œåœ¨åœ¨æˆ‘é©æ–°ä¸‹ä¼˜åŒ–ï¼›è¦å­¦ä¹ åˆ«äººä¼˜ç§€çš„ä»£ç è®¾è®¡æ€æƒ³å’Œä»£ç é£æ ¼ï¼ŒæŒç»­è¿›æ­¥ã€‚
  - ä¸“ä¸šï¼šä¸“ä¸šæ˜¯ä¸€ç§å·¥ä½œæ€åº¦ï¼Œä¹Ÿæ˜¯ä¸€ç§äººç”Ÿæ€åº¦ï¼›ä»£ç è¦ä¸“ä¸šã€æ¶æ„è¦ä¸“ä¸šã€å˜é‡åè¦ä¸“ä¸šã€æ–‡æ¡£è¦ä¸“ä¸šã€è·Ÿåˆ«äººå‘å·¥ä½œæ¶ˆæ¯é‚®ä»¶è¦ä¸“ä¸šã€å¼€ä¼šè¦ä¸“ä¸šã€æ²Ÿé€šè¦ä¸“ä¸šï¼Œç­‰ç­‰ï¼Œä¸“ä¸šè¦ä¼´éšè‡ªå·±ä¸€ç”Ÿã€‚

```
# æ ¸å¿ƒæ€§èƒ½å½±å“é…ç½®

# Linuxç³»ç»Ÿ
## å¹¶å‘æ–‡ä»¶æè¿°ç¬¦ /etc/security/limits.conf
*        soft    nofile  1000000
*        hard    nofile  1000000
## Sessionä¸´æ—¶ä¿®æ”¹
ulimit -SHn 1000000

# è¿›ç¨‹æ•°é‡é™åˆ¶ /etc/security/limits.d/20-nproc.conf
*          soft    nproc  4096
root     soft    nproc  unlimited

# æ–‡ä»¶å¥æŸ„æ•°é‡
## ä¸´æ—¶ä¿®æ”¹
echo 1000000 > /proc/sys/fs/file-max
## æ°¸ä¹…ä¿®æ”¹
echo "fs.file-max = 1000000" >>/etc/sysctl.conf
## ç½‘ç»œTCPé€‰é¡¹ï¼Œå…³æ³¨ *somaxconn/*backlog/*mem*ç³»åˆ—/*time*ç³»åˆ—ç­‰ç­‰
## å…³é—­SWAPäº¤æ¢åˆ†åŒºï¼ˆæœåŠ¡å™¨å¡æ­»å…ƒå‡¶ï¼‰
echo "vm.swappiness = 0">> /etc/sysctl.conf

Nginx/OpenResty
# Nginx Workeræ€§èƒ½ï¼š
worker_processes 4;
worker_cpu_affinity 01 10 01 10;
worker_rlimit_nofile 10240;
worker_connections 10240;

# Nginxç½‘ç»œæ€§èƒ½ï¼š
use epoll;
sendfile on;
tcp_nopush on;
tcp_nodelay on;
keepalive_timeout 30;
proxy_connect_timeout 10;

# Nginxç¼“å­˜é…ç½®ï¼š
fastcgi_buffer_size 64k;
client_max_body_size 300m;
client_header_buffer_size 4k;
open_file_cachemax=65535 inactive=60s;
open_file_cache_valid 80s;
proxy_buffer_size 256k;
proxy_buffers 4256k;
proxy_cache*

# PHP/FPM
listen.backlog = -1  #backlogæ•°ï¼Œ-1è¡¨ç¤ºæ— é™åˆ¶
rlimit_files = 1024  #è®¾ç½®æ–‡ä»¶æ‰“å¼€æè¿°ç¬¦çš„rlimité™åˆ¶
rlimit_core = unlimited #ç”Ÿæˆcore dumpæ–‡ä»¶é™åˆ¶ï¼Œå—é™äºlinuxç³»ç»Ÿ
pm.max_children = 256  #å­è¿›ç¨‹æœ€å¤§æ•°
pm.max_requests = 1000 #è®¾ç½®æ¯ä¸ªå­è¿›ç¨‹é‡ç”Ÿä¹‹å‰æœåŠ¡çš„è¯·æ±‚æ•°
request_terminate_timeout = 0 #è®¾ç½®å•ä¸ªè¯·æ±‚çš„è¶…æ—¶ä¸­æ­¢æ—¶é—´
request_slowlog_timeout = 10s  #å½“ä¸€ä¸ªè¯·æ±‚è¯¥è®¾ç½®çš„è¶…æ—¶æ—¶é—´å

# MySQL/MariaDB
## MySQLæœåŠ¡é€‰é¡¹ï¼š
wait_timeout=1800
max_connections=3000
max_user_connections=800
thread_cache_size=64
skip-name-resolve = 1
open_tables=512
max_allowed_packet = 64M

## MySQLæ€§èƒ½é€‰é¡¹ï¼š
innodb_page_size = 8K #è„é¡µå¤§å°
innodb_buffer_pool_size = 10G #å»ºè®®è®¾ç½®ä¸ºå†…å­˜80%
innodb_log_buffer_size = 20M #æ—¥å¿—ç¼“å­˜å¤§å°
innodb_flush_log_at_trx_commit = 0  #äº‹åŠ¡æ—¥å¿—æäº¤æ–¹å¼ï¼Œè®¾ç½®ä¸º0æ¯”è¾ƒåˆé€‚
innodb_lock_wait_timeout = 30 #é”è·å–è¶…æ—¶ç­‰å¾…æ—¶é—´
innodb_io_capacity = 2000 #åˆ·è„é¡µçš„é¢‘æ¬¡é»˜è®¤200ï¼Œé«˜ä¸€äº›ä¼šè®©ioæ›²çº¿ç¨³

# Redis
maxmemory  5000mb  #æœ€å¤§å†…å­˜å ç”¨
maxmemory-policy allkeys-lru  #è¾¾åˆ°å†…å­˜å ç”¨åæ·˜æ±°ç­–ç•¥ï¼Œå­˜åœ¨çƒ­ç‚¹æ•°æ®ï¼Œæ·˜æ±°ä¸å’‹è®¿é—®çš„
maxclients 1000 #å®¢æˆ·ç«¯å¹¶å‘è¿æ¥æ•°
timeout 150  #å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´
tcp-keepalive 150  #å‘å®¢æˆ·ç«¯å‘é€tcp_ackæ¢æµ‹å­˜æ´»
rdbcompression no  #ç£ç›˜é•œåƒå‹ç¼©ï¼Œå¼€å¯å ç”¨cpu
rdbchecksum no  #å­˜å‚¨å¿«ç…§åcrc64ç®—æ³•æ ¡éªŒï¼Œå¢åŠ 10%cpuå ç”¨
vm-enabled no #ä¸åšæ•°æ®äº¤æ¢
```

## èµ„æº

* [Hprose](https://hprose.com):é«˜æ€§èƒ½è¿œç¨‹å¯¹è±¡æœåŠ¡å¼•æ“
* [awesome-selfhosted](https://github.com/Kickball/awesome-selfhosted):This is a list of Free Software network services and web applications which can be hosted locally. Selfhosting is the process of locally hosting and managing applications instead of renting from SaaS providers. <https://reddit.com/r/selfhosted>
* [Back-End-Developer-Interview-Questions](https://github.com/arialdomartini/Back-End-Developer-Interview-Questions):A list of back-end related questions you can be inspired from to interview potential candidates, test yourself or completely ignore
* [Backend-Series](https://github.com/wx-chevalier/Backend-Series):ğŸ“š æœåŠ¡ç«¯åº”ç”¨ç¨‹åºå¼€å‘ä¸ç³»ç»Ÿæ¶æ„/å¾®æœåŠ¡æ¶æ„ä¸å®è·µï¼ŒæœåŠ¡ç«¯åŸºç¡€ç¯‡ | å¾®æœåŠ¡ä¸äº‘åŸç”Ÿç¯‡ | Spring ç¯‡ | Node.js ç¯‡ | DevOps ç¯‡ | ä¿¡æ¯å®‰å…¨ä¸æ¸—é€æµ‹è¯•ç¯‡
* [TechClass](https://github.com/lemonchann/TechClass):é¡¹ç›®æ¶µç›–æˆä¸ºä¸€ä¸ªåç«¯å¼€å‘ç¨‹åºå‘˜å¿…å¤‡çš„æŠ€èƒ½ï¼ŒåŒ…æ‹¬Linuxã€ç½‘ç»œã€æ¶æ„ã€å¾®æœåŠ¡ã€æ•°æ®åº“ã€æ•°æ®ç»“æ„å’Œç®—æ³•ã€ç¼–ç¨‹è¯­è¨€å­¦ä¹ ç­‰å†…å®¹ <https://lemonchann.github.io/TechClass>

## å‚è€ƒ

* [camel](https://github.com/dianping/camel):è½¯è´Ÿè½½ä¸€ä½“è§£å†³æ–¹æ¡ˆï¼Œæ‰¿æ‹…äº†F5ç¡¬è´Ÿè½½å±‚åçš„è½¯è´Ÿè½½å·¥ä½œ
* [cilium](https://github.com/cilium/cilium):API Aware Networking and Security using BPF and XDP
